<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Zaloguj się</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="login-page">

    <div class="login-container">
        <div class="header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c9/Herb_Polski.svg" alt="Godło Polski"
                class="logo-img">
            <span class="logo-text">mUczelnia</span>
        </div>

        <form class="login-form" id="loginForm">
            <h2>Zaloguj się</h2>

            <div class="input-wrapper">
                <input type="email" id="email-input" placeholder="Adres e-mail lub telefon" required>
            </div>

            <div class="input-wrapper">
                <input type="password" placeholder="Hasło" id="password-input" required>
                <div id="toggle-password"></div>
            </div>

            <div class="form-options">
                <label class="remember-me">
                    <input type="checkbox" name="remember">
                    Zapamiętaj mnie
                </label>
                <div class="forgot-password">
                    <a href="#">Nie pamiętasz hasła?</a>
                </div>
            </div>

            <button type="submit" class="login-button">Zaloguj</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // 2. CONFIGURATION
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';

        // ⚠️ PASTE YOUR PUBLIC ANON KEY HERE
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';

        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('password-input');
            const togglePassword = document.getElementById('toggle-password');
            const emailInput = document.getElementById('email-input');
            const loginForm = document.getElementById('loginForm');

            // --- Toggle Password Logic ---
            togglePassword.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                togglePassword.classList.toggle('visible', isPassword);
            });

            // --- 3. Secure Login Logic ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const email = emailInput.value;
                const password = passwordInput.value;

                console.log("Attempting secure login...");

                // A. Authenticate with Supabase Auth (Checks Hash)
                const { data: authData, error: authError } = await _supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (authError) {
                    alert('Błąd logowania: ' + authError.message);
                    return;
                }

                // B. Login Success! Now fetch the Public Profile
                // We use the ID from the auth result (authData.user.id)
                console.log("Auth success. Fetching profile for ID:", authData.user.id);

                const { data: profile, error: profileError } = await _supabase
                    .from('users') // Querying your 'public.users' table
                    .select('username')
                    .eq('id', authData.user.id)
                    .single();

                if (profileError) {
                    console.error("Profile fetch error:", profileError);
                    alert("Zalogowano, ale nie udało się pobrać profilu.");
                } else {
                    // C. Success!
                    //alert(`✅ Zalogowano pomyślnie!\nWitaj, ${profile.username}`);

                    // UNCOMMENT BELOW TO REDIRECT
                    window.location.href = 'dashboard.html';
                }
            });
        });
    </script>
</body>


</html>

