<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Pulpit</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="layout-wrapper">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="#" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Pulpit</span></a></li>
                </ul>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <h1 id="welcome-message">Witaj!</h1>
                    <p>Wybierz moduł, aby kontynuować.</p>
                </div>
            </div>

            <!-- DASHBOARD GRID -->
            <div class="dashboard-grid">
                
                <!-- 1. ADMIN: UTWÓRZ KURS -->
                <a href="create_course.html" id="widget-create-course" class="widget-tile" style="display: none; border: 2px dashed var(--accent-color);">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23f04a4a%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%223%22 width=%2218%22 height=%2218%22 rx=%222%22 ry=%222%22></rect><line x1=%2212%22 y1=%228%22 x2=%2212%22 y2=%2216%22></line><line x1=%228%22 y1=%2212%22 x2=%2216%22 y2=%2212%22></line></svg>');"></div>
                    <h3 style="color: var(--accent-color);">Utwórz Kurs</h3>
                    <p class="course-meta">Administrator</p>
                </a>
                
                <!-- 2. ADMIN: DODAJ UŻYTKOWNIKA -->
                <div id="widget-add-user" class="widget-tile" style="display: none; border: 2px dashed #555; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23555%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%228.5%22 cy=%227%22 r=%224%22></circle><line x1=%2220%22 y1=%228%22 x2=%2220%22 y2=%2214%22></line><line x1=%2223%22 y1=%2211%22 x2=%2217%22 y2=%2211%22></line></svg>');"></div>
                    <h3 style="color: #555;">Dodaj Użytkownika</h3>
                    <p class="course-meta">Administrator</p>
                </div>

                <!-- 3. ADMIN ONLY: DODAJ SZKOŁĘ -->
                <div id="widget-add-school" class="widget-tile" style="display: none; border: 2px dashed #2196F3; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%232196F3%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4%22></path></svg>');"></div>
                    <h3 style="color: #2196F3;">Dodaj Szkołę</h3>
                    <p class="course-meta">Administrator</p>
                </div>

                <!-- 4. ADMIN & MANAGER: DODAJ KLASĘ -->
                <div id="widget-add-class" class="widget-tile" style="display: none; border: 2px dashed #4CAF50; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%234CAF50%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%229%22 cy=%227%22 r=%224%22></circle><path d=%22M23 21v-2a4 4 0 0 0-3-3.87%22></path><path d=%22M16 3.13a4 4 0 0 1 0 7.75%22></path></svg>');"></div>
                    <h3 style="color: #4CAF50;">Dodaj Klasę</h3>
                    <p class="course-meta">Admin & Manager</p>
                </div>

                <!-- STANDARD TILES -->
                <a href="courses_list.html" class="widget-tile">
                    <div class="widget-icon icon-course-active"></div>
                    <h3>Moje Kursy</h3>
                    <p class="course-meta">Przejdź do listy zajęć</p>
                </a>

                <a href="#" class="widget-tile" onclick="alert('Moduł w budowie!')">
                    <div class="widget-icon icon-grades"></div>
                    <h3>Oceny</h3>
                </a>
            </div>
        </main>

        <!-- RIGHT SIDEBAR -->
        <aside class="sidebar-right">
            <div class="profile-card">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje"></div>
                <div class="dropdown-menu" id="profileDropdown">
                    <div class="dropdown-item" id="logoutBtn">
                        <div class="icon-logout"></div>
                        Wyloguj się
                    </div>
                </div>
                <h2 class="profile-name" id="profile-name-display">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
            </div>
        </aside>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- 1. CREATE USER MODAL (UPDATED WITH SCHOOL/CLASS) -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Użytkownika</h3>
                <span class="close-modal" onclick="closeModal('createUserModal')">&times;</span>
            </div>
            <form id="createUserForm" class="modal-form">
                <label>Nazwa</label>
                <input type="text" id="new-username" class="edit-input" required>
                <label>Email</label>
                <input type="email" id="new-email" class="edit-input" required>
                <label>Hasło</label>
                <input type="password" id="new-password" class="edit-input" required>
                
                <label>Rola</label>
                <select id="new-role" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;">
                    <option value="student" selected>Student</option>
                    <option value="teacher">Nauczyciel</option>
                    <option value="manager">Dziekanat (Manager)</option>
                    <option value="admin">Administrator</option>
                </select>

                <!-- NEW: SCHOOL SELECT -->
                <div id="school-select-container" style="display: block;">
                    <label>Szkoła / Wydział</label>
                    <select id="new-user-school" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;">
                        <option value="" selected>-- Brak / Ogólne --</option>
                    </select>
                </div>

                <!-- NEW: CLASS SELECT (Hidden for teachers/admins) -->
                <div id="class-select-container" style="display: block;">
                    <label>Klasa / Grupa</label>
                    <select id="new-user-class" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;" disabled>
                        <option value="" selected>-- Najpierw wybierz szkołę --</option>
                    </select>
                </div>

                <button type="submit" class="login-button full-width-btn" id="createBtn">Utwórz konto</button>
            </form>
        </div>
    </div>

    <!-- 2. ADD SCHOOL MODAL (Admin Only) -->
    <div class="modal-overlay" id="addSchoolModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Szkołę/Wydział</h3>
                <span class="close-modal" onclick="closeModal('addSchoolModal')">&times;</span>
            </div>
            <form id="addSchoolForm" class="modal-form">
                <label>Nazwa Szkoły</label>
                <input type="text" id="school-name" class="edit-input" placeholder="np. Wydział Informatyki" required>
                <label>Adres (Opcjonalnie)</label>
                <input type="text" id="school-address" class="edit-input" placeholder="ul. Słoneczna 5">
                <button type="submit" class="login-button full-width-btn">Zapisz Szkołę</button>
            </form>
        </div>
    </div>

    <!-- 3. ADD CLASS MODAL (Admin & Manager) -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Klasę/Grupę</h3>
                <span class="close-modal" onclick="closeModal('addClassModal')">&times;</span>
            </div>
            <form id="addClassForm" class="modal-form">
                <label>Wybierz Szkołę</label>
                <select id="class-school-select" class="edit-input" style="border:1px solid #ccc;" required>
                    <option value="" disabled selected>Ładowanie szkół...</option>
                </select>
                
                <label>Nazwa Klasy</label>
                <input type="text" id="class-name" class="edit-input" placeholder="np. 1A - Informatyka" required>
                
                <button type="submit" class="login-button full-width-btn">Zapisz Klasę</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth Check
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const userId = session.user.id;
            
            // 2. Fetch Profile & Check Roles
            const { data: profile } = await _supabase
                .from('users')
                .select('username, role')
                .eq('id', userId)
                .single();

            if (profile) {
                document.getElementById('profile-name-display').textContent = profile.username;
                document.getElementById('profile-role-display').textContent = profile.role.toUpperCase();
                document.getElementById('welcome-message').textContent = `Witaj, ${profile.username}!`;

                // --- ROLE BASED VISIBILITY ---
                if (profile.role === 'admin') {
                    document.getElementById('widget-create-course').style.display = 'flex';
                    
                    const btnUser = document.getElementById('widget-add-user');
                    btnUser.style.display = 'flex';
                    btnUser.onclick = () => openCreateUserModal(); // Updated function

                    const btnSchool = document.getElementById('widget-add-school');
                    btnSchool.style.display = 'flex';
                    btnSchool.onclick = () => openModal('addSchoolModal');

                    const btnClass = document.getElementById('widget-add-class');
                    btnClass.style.display = 'flex';
                    btnClass.onclick = () => openClassModal();
                }

                if (profile.role === 'manager') {
                    const btnClass = document.getElementById('widget-add-class');
                    btnClass.style.display = 'flex';
                    btnClass.onclick = () => openClassModal();
                }
            }

            // Dropdown & Logout
            const avatarTrigger = document.getElementById('avatarTrigger');
            const dropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            avatarTrigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
            window.addEventListener('click', () => { if (dropdown.classList.contains('show')) dropdown.classList.remove('show'); });
            logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.href = 'login.html'; });

            // --- FORM LISTENERS ---

            // 1. Create User
            document.getElementById('createUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createNewUser();
            });

            // 2. Add School
            document.getElementById('addSchoolForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('school-name').value;
                const address = document.getElementById('school-address').value;

                const { error } = await _supabase.from('schools').insert({ name, address });
                if (error) alert("Błąd: " + error.message);
                else {
                    alert("Szkoła dodana!");
                    closeModal('addSchoolModal');
                    document.getElementById('addSchoolForm').reset();
                }
            });

            // 3. Add Class
            document.getElementById('addClassForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const schoolId = document.getElementById('class-school-select').value;
                const name = document.getElementById('class-name').value;

                if (!schoolId) return alert("Wybierz szkołę!");

                const { error } = await _supabase.from('classes').insert({ school_id: schoolId, name });
                if (error) alert("Błąd: " + error.message);
                else {
                    alert("Klasa dodana!");
                    closeModal('addClassModal');
                    document.getElementById('addClassForm').reset();
                }
            });

            // --- DYNAMIC UX FOR CREATE USER FORM ---
            
            // Toggle visibility based on role
            document.getElementById('new-role').addEventListener('change', function() {
                const role = this.value;
                const classContainer = document.getElementById('class-select-container');
                const schoolContainer = document.getElementById('school-select-container');
                
                // Show School for Student, Teacher, Manager
                if (role === 'admin') {
                    schoolContainer.style.display = 'none';
                    classContainer.style.display = 'none';
                } else {
                    schoolContainer.style.display = 'block';
                    // Show Class ONLY for Student
                    if (role === 'student') {
                        classContainer.style.display = 'block';
                    } else {
                        classContainer.style.display = 'none';
                        document.getElementById('new-user-class').value = ""; // Clear class if switching to teacher
                    }
                }
            });

            // Load classes when school changes
            document.getElementById('new-user-school').addEventListener('change', async function() {
                const schoolId = this.value;
                await loadClassesForSchool(schoolId);
            });
        });

        // --- HELPER FUNCTIONS ---

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // Fetch schools when opening Create User modal
        async function openCreateUserModal() {
            openModal('createUserModal');
            const schoolSelect = document.getElementById('new-user-school');
            
            // Fetch schools
            const { data: schools } = await _supabase.from('schools').select('id, name');
            
            schoolSelect.innerHTML = '<option value="" selected>-- Brak / Ogólne --</option>';
            if (schools) {
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    schoolSelect.appendChild(opt);
                });
            }
        }

        // Fetch classes dynamically
        async function loadClassesForSchool(schoolId) {
            const classSelect = document.getElementById('new-user-class');
            classSelect.innerHTML = '<option value="" selected>Ładowanie...</option>';
            classSelect.disabled = true;

            if (!schoolId) {
                classSelect.innerHTML = '<option value="" selected>-- Najpierw wybierz szkołę --</option>';
                return;
            }

            const { data: classes } = await _supabase
                .from('classes')
                .select('id, name')
                .eq('school_id', schoolId);

            classSelect.innerHTML = '<option value="" selected>-- Wybierz Klasę --</option>';
            if (classes && classes.length > 0) {
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    classSelect.appendChild(opt);
                });
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option value="" selected>-- Brak klas w tej szkole --</option>';
            }
        }

        // Fetch schools for "Add Class" modal (Admin/Manager)
        async function openClassModal() {
            openModal('addClassModal');
            const select = document.getElementById('class-school-select');
            if (select.options.length <= 1) {
                const { data: schools } = await _supabase.from('schools').select('id, name');
                if (schools) {
                    select.innerHTML = '<option value="" disabled selected>-- Wybierz Szkołę --</option>';
                    schools.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        select.appendChild(opt);
                    });
                }
            }
        }

        async function createNewUser() {
            const btn = document.getElementById('createBtn');
            const originalText = btn.textContent;
            btn.textContent = "Tworzenie...";
            btn.disabled = true;

            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const username = document.getElementById('new-username').value;
            const role = document.getElementById('new-role').value;
            const schoolId = document.getElementById('new-user-school').value;
            const classId = document.getElementById('new-user-class').value;

            try {
                const tempSupabase = supabase.createClient(supabaseUrl, supabaseKey, {
                    auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                });

                // SEND DATA VIA METADATA (Trigger handles insertion)
                const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                    email: email, password: password,
                    options: { 
                        data: { 
                            username: username, 
                            role: role,
                            school_id: schoolId || null, // Send ID or null
                            class_id: classId || null    // Send ID or null
                        } 
                    }
                });

                if (authError) throw authError;
                alert(`✅ Sukces! Utworzono użytkownika: ${username}`);
                closeModal('createUserModal');
                document.getElementById('createUserForm').reset();
            } catch (err) { alert("Błąd: " + err.message); } 
            finally { btn.textContent = originalText; btn.disabled = false; }
        }
    </script>
</body>
</html>
