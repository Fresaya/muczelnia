<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Pulpit</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="#" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Pulpit</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <h1 id="welcome-message">Witaj!</h1>
                    <p>Wybierz moduł, aby kontynuować.</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- 1. ADMIN: UTWÓRZ KURS -->
                <a href="create_course.html" id="widget-create-course" class="widget-tile" style="display: none; border: 2px dashed var(--accent-color);">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23f04a4a%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%223%22 width=%2218%22 height=%2218%22 rx=%222%22 ry=%222%22></rect><line x1=%2212%22 y1=%228%22 x2=%2212%22 y2=%2216%22></line><line x1=%228%22 y1=%2212%22 x2=%2216%22 y2=%2212%22></line></svg>');"></div>
                    <h3 style="color: var(--accent-color);">Utwórz Kurs</h3>
                    <p class="course-meta">Administrator</p>
                </a>

                <!-- 1b. ADMIN: UTWÓRZ QUIZ -->
                <a href="create_quiz.html" id="widget-create-quiz" class="widget-tile" style="display: none; border: 2px dashed #9C27B0;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239C27B0%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z%22></path><polyline points=%2214 2 14 8 20 8%22></polyline><line x1=%2212%22 y1=%2218%22 x2=%2212%22 y2=%2218%22></line><line x1=%2212%22 y1=%2214%22 x2=%2212%22 y2=%2212%22></line></svg>');"></div>
                    <h3 style="color: #9C27B0;">Utwórz Quiz</h3>
                    <p class="course-meta">Administrator</p>
                </a>
                
                <!-- 2. ADMIN & MANAGER: DODAJ UŻYTKOWNIKA -->
                <div id="widget-add-user" class="widget-tile" style="display: none; border: 2px dashed #555; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23555%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%228.5%22 cy=%227%22 r=%224%22></circle><line x1=%2220%22 y1=%228%22 x2=%2220%22 y2=%2214%22></line><line x1=%2223%22 y1=%2211%22 x2=%2217%22 y2=%2211%22></line></svg>');"></div>
                    <h3 style="color: #555;">Dodaj Użytkownika</h3>
                    <p class="course-meta">Admin & Manager</p>
                </div>

                <!-- 3. ADMIN ONLY: DODAJ SZKOŁĘ -->
                <div id="widget-add-school" class="widget-tile" style="display: none; border: 2px dashed #2196F3; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%232196F3%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4%22></path></svg>');"></div>
                    <h3 style="color: #2196F3;">Dodaj Szkołę</h3>
                    <p class="course-meta">Administrator</p>
                </div>

                <!-- 4. ADMIN & MANAGER: DODAJ KLASĘ -->
                <div id="widget-add-class" class="widget-tile" style="display: none; border: 2px dashed #4CAF50; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%234CAF50%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%229%22 cy=%227%22 r=%224%22></circle><path d=%22M23 21v-2a4 4 0 0 0-3-3.87%22></path><path d=%22M16 3.13a4 4 0 0 1 0 7.75%22></path></svg>');"></div>
                    <h3 style="color: #4CAF50;">Dodaj Klasę</h3>
                    <p class="course-meta">Admin & Manager</p>
                </div>

                <!-- 5. ADMIN & MANAGER: ZARZĄDZAJ UCZNIAMI -->
                <div id="widget-manage-students" class="widget-tile" style="display: none; border: 2px dashed #FF9800; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23FF9800%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%229%22 cy=%227%22 r=%224%22></circle><path d=%22M23 21v-2a4 4 0 0 0-3-3.87%22></path><path d=%22M16 3.13a4 4 0 0 1 0 7.75%22></path></svg>');"></div>
                    <h3 style="color: #FF9800;">Uczniowie</h3>
                    <p class="course-meta">Przypisz klasy</p>
                </div>

                <!-- 6. ASSIGN COURSE -->
                <div id="widget-assign-course" class="widget-tile" style="display: none; border: 2px dashed #9C27B0; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239C27B0%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M4 19.5A2.5 2.5 0 0 1 6.5 17H20%22></path><path d=%22M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z%22></path><path d=%22M12 11h5%22></path><path d=%22M12 8h5%22></path></svg>');"></div>
                    <h3 style="color: #9C27B0;">Przypisz Materiał</h3>
                    <p class="course-meta">Kurs lub Quiz</p>
                </div>

                <!-- LINK TO COURSES LIST -->
                <a href="courses_list.html" class="widget-tile">
                    <div class="widget-icon icon-course-active"></div>
                    <h3>Moje Kursy</h3>
                    <p class="course-meta">Przejdź do listy zajęć</p>
                </a>

                <!-- LINK TO QUIZZES LIST -->
                <a href="quizzes_list.html" class="widget-tile">
                    <div class="widget-icon icon-notes"></div>
                    <h3>Ćwiczenia</h3>
                    <p class="course-meta">Testy i Quizy</p>
                </a>

                <a href="#" class="widget-tile" onclick="alert('Moduł w budowie!')">
                    <div class="widget-icon icon-grades"></div>
                    <h3>Oceny</h3>
                </a>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje"></div>
                <div class="dropdown-menu" id="profileDropdown">
                    <div class="dropdown-item" id="logoutBtn">
                        <div class="icon-logout"></div>
                        Wyloguj się
                    </div>
                </div>
                <h2 class="profile-name" id="profile-name-display">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
            </div>
        </aside>
    </div>

    <!-- MODALS -->
    
    <!-- 1. CREATE USER MODAL -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Użytkownika</h3>
                <span class="close-modal" onclick="closeModal('createUserModal')">&times;</span>
            </div>
            <form id="createUserForm" class="modal-form">
                <label>Nazwa</label>
                <input type="text" id="new-username" class="edit-input" required>
                <label>Email</label>
                <input type="email" id="new-email" class="edit-input" required>
                <label>Hasło</label>
                <input type="password" id="new-password" class="edit-input" required>
                <label>Rola</label>
                <select id="new-role" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;">
                    <option value="student" selected>Student</option>
                    <option value="teacher">Nauczyciel</option>
                    <option value="manager">Dziekanat (Manager)</option>
                    <option value="admin">Administrator</option>
                </select>
                <div id="school-select-container" style="display: block;">
                    <label>Szkoła / Wydział</label>
                    <select id="new-user-school" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;">
                        <option value="" selected>-- Brak / Ogólne --</option>
                    </select>
                </div>
                <button type="submit" class="login-button full-width-btn" id="createBtn">Utwórz konto</button>
            </form>
        </div>
    </div>

    <!-- 2. ADD SCHOOL MODAL -->
    <div class="modal-overlay" id="addSchoolModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Szkołę/Wydział</h3>
                <span class="close-modal" onclick="closeModal('addSchoolModal')">&times;</span>
            </div>
            <form id="addSchoolForm" class="modal-form">
                <label>Nazwa Szkoły</label>
                <input type="text" id="school-name" class="edit-input" placeholder="np. Wydział Informatyki" required>
                <label>Adres (Opcjonalnie)</label>
                <input type="text" id="school-address" class="edit-input" placeholder="ul. Słoneczna 5">
                <button type="submit" class="login-button full-width-btn">Zapisz Szkołę</button>
            </form>
        </div>
    </div>

    <!-- 3. ADD CLASS MODAL -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Klasę/Grupę</h3>
                <span class="close-modal" onclick="closeModal('addClassModal')">&times;</span>
            </div>
            <form id="addClassForm" class="modal-form">
                <label>Wybierz Szkołę</label>
                <select id="class-school-select" class="edit-input" style="border:1px solid #ccc;" required>
                    <option value="" disabled selected>Ładowanie szkół...</option>
                </select>
                <label>Nazwa Klasy</label>
                <input type="text" id="class-name" class="edit-input" placeholder="np. 1A - Informatyka" required>
                <button type="submit" class="login-button full-width-btn">Zapisz Klasę</button>
            </form>
        </div>
    </div>

    <!-- 4. MANAGE STUDENTS MODAL -->
    <div class="modal-overlay" id="manageStudentsModal">
        <div class="modal-window" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Zarządzanie Uczniami</h3>
                <span class="close-modal" onclick="closeModal('manageStudentsModal')">&times;</span>
            </div>
            <div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-end;">
                <div id="manage-school-wrapper" style="flex: 1;">
                    <label style="font-size: 14px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 8px;">Szkoła:</label>
                    <select id="manage-school-select" class="edit-input" style="border:1px solid #ccc; margin:0;">
                        <option value="" disabled selected>Wybierz...</option>
                    </select>
                </div>
                <div id="manage-class-filter-wrapper" style="flex: 1; display: none;">
                    <label style="font-size: 14px; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 8px;">Filtruj widok:</label>
                    <select id="filter-class-select" class="edit-input" style="border:1px solid #ccc; margin:0;">
                        <option value="all" selected>Wszyscy uczniowie</option>
                        <option value="none" style="font-weight:bold;">⚠️ Tylko nieprzypisani</option>
                    </select>
                </div>
            </div>
            <div id="students-loading" style="display:none; text-align:center;">Ładowanie listy...</div>
            <div id="students-table-container" style="max-height: 400px; overflow-y: auto; display: none;">
                <table class="student-table">
                    <thead><tr><th>Imię i Nazwisko</th><th>Email</th><th>Przypisana Klasa</th><th>Akcja</th></tr></thead>
                    <tbody id="students-table-body"></tbody>
                </table>
                <p id="no-students-msg" style="text-align:center; color:#888; display:none; padding:20px;">Brak studentów spełniających kryteria.</p>
            </div>
        </div>
    </div>

    <!-- 5. ASSIGN COURSE MODAL (UPDATED with Level Filter) -->
    <div class="modal-overlay" id="assignCourseModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Przypisz Pakiet do Klasy</h3>
                <span class="close-modal" onclick="closeModal('assignCourseModal')">&times;</span>
            </div>
            <form id="assignCourseForm" class="modal-form">
                
                <!-- NEW FILTER DROPDOWN -->
                <div style="margin-bottom: 10px;">
                    <label style="font-size:12px; color:#555; font-weight:bold;">Filtruj wg poziomu:</label>
                    <select id="assign-filter-level" class="edit-input" style="border:1px solid #ccc; margin-top:5px; padding:8px;">
                        <option value="all" selected>Wszystkie</option>
                        <option value="1">Szkoła Podstawowa</option>
                        <option value="2">Szkoła Średnia</option>
                        <option value="3">Szkoła Wyższa</option>
                    </select>
                </div>

                <label>Wybierz Pakiet</label>
                <select id="assign-package-select" class="edit-input" style="border:1px solid #ccc; margin-bottom:15px;" required>
                    <option value="" disabled selected>Ładowanie pakietów...</option>
                </select>

                <label>Wybierz Klasę</label>
                <select id="assign-class-select" class="edit-input" style="border:1px solid #ccc;" required>
                    <option value="" disabled selected>Ładowanie klas...</option>
                </select>
                <button type="submit" class="login-button full-width-btn">Przypisz Pakiet</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUserRole = null;
        let currentUserSchoolId = null;
        let allPackagesCache = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const userId = session.user.id;
            const { data: profile } = await _supabase.from('users').select('username, role, school_id').eq('id', userId).single();

            if (profile) {
                currentUserRole = profile.role;
                currentUserSchoolId = profile.school_id;
                document.getElementById('profile-name-display').textContent = profile.username;
                document.getElementById('profile-role-display').textContent = profile.role.toUpperCase();
                document.getElementById('welcome-message').textContent = `Witaj, ${profile.username}!`;

                // --- ROLE VISIBILITY ---
                
                if (['admin', 'manager', 'teacher'].includes(currentUserRole)) {
                    document.getElementById('widget-assign-course').style.display = 'flex';
                    document.getElementById('widget-assign-course').onclick = () => openAssignCourseModal();
                }

                if (currentUserRole === 'admin') {
                    // SHOW Admin Tools
                    show('widget-admin-content'); 
                    show('widget-create-course');
                    show('widget-create-quiz');
                    show('widget-add-user');
                    show('widget-add-school');
                    show('widget-add-class');
                    show('widget-manage-students');
                    
                    // HIDE Student Tools
                    hide('widget-student-courses');
                    hide('widget-student-quizzes');
                    hide('widget-student-grades');

                    // Bindings
                    document.getElementById('widget-add-user').onclick = () => openCreateUserModal();
                    document.getElementById('widget-add-school').onclick = () => openModal('addSchoolModal');
                    document.getElementById('widget-add-class').onclick = () => openClassModal();
                    document.getElementById('widget-manage-students').onclick = () => openManageStudentsModal();
                }

                if (currentUserRole === 'manager') {
                    show('widget-add-user');
                    show('widget-add-class');
                    show('widget-manage-students');
                    document.getElementById('widget-add-user').onclick = () => openCreateUserModal();
                    document.getElementById('widget-add-class').onclick = () => openClassModal();
                    document.getElementById('widget-manage-students').onclick = () => openManageStudentsModal();
                }
            }

            const avatarTrigger = document.getElementById('avatarTrigger');
            const dropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            avatarTrigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
            window.addEventListener('click', () => { if (dropdown.classList.contains('show')) dropdown.classList.remove('show'); });
            logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.href = 'login.html'; });

            // Form Listeners
            document.getElementById('createUserForm').addEventListener('submit', createNewUser);
            document.getElementById('addSchoolForm').addEventListener('submit', addSchool);
            document.getElementById('addClassForm').addEventListener('submit', addClass);
            document.getElementById('assignCourseForm').addEventListener('submit', assignCourseToClass);
            document.getElementById('new-role').addEventListener('change', function() {
                const role = this.value;
                const schoolContainer = document.getElementById('school-select-container');
                if (role === 'admin') schoolContainer.style.display = 'none'; else schoolContainer.style.display = 'block';
            });
            document.getElementById('manage-school-select').addEventListener('change', function() { loadStudentsForSchool(this.value); });
            document.getElementById('filter-class-select').addEventListener('change', filterStudentsTable);
            document.getElementById('assign-filter-level').addEventListener('change', filterAssignPackages);
        });

        // --- FUNCTIONS (SAFE VERSIONS) ---
        function show(id) { 
            const el = document.getElementById(id); 
            if(el) el.style.display = 'flex'; 
            else console.warn("Missing element to show:", id);
        }
        function hide(id) { 
            const el = document.getElementById(id); 
            if(el) el.style.display = 'none'; 
            else console.warn("Missing element to hide:", id);
        }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- ASSIGN MODAL (UPDATED) ---
        async function openAssignCourseModal() {
            openModal('assignCourseModal');
            const pkgSelect = document.getElementById('assign-package-select');
            const classSelect = document.getElementById('assign-class-select');
            
            // 1. Load Packages with Level
            pkgSelect.innerHTML = '<option value="" disabled selected>Ładowanie...</option>';
            const { data: pkgs, error: pkgErr } = await _supabase.from('packages').select('id, title, level');
            
            if (pkgErr) {
                alert("Błąd: " + pkgErr.message);
                pkgSelect.innerHTML = '<option value="" disabled>Błąd</option>';
            } else if (pkgs) {
                allPackagesCache = pkgs; // Store for filtering
                renderPackageOptions(); // Render all initially
            }

            // 2. Load Classes
            classSelect.innerHTML = '<option value="" disabled selected>Ładowanie...</option>';
            let query = _supabase.from('classes').select('id, name');
            if ((currentUserRole === 'teacher' || currentUserRole === 'manager') && currentUserSchoolId) {
                query = query.eq('school_id', currentUserSchoolId);
            }
            const { data: classes, error: clsErr } = await query;
            if (classes && classes.length > 0) {
                classSelect.innerHTML = '<option value="" selected>-- Wybierz Klasę --</option>';
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    classSelect.appendChild(opt);
                });
            } else {
                classSelect.innerHTML = '<option value="" disabled>Brak klas</option>';
            }
        }

        function filterAssignPackages() {
            renderPackageOptions();
        }

        function renderPackageOptions() {
            const pkgSelect = document.getElementById('assign-package-select');
            const filterLevel = document.getElementById('assign-filter-level').value;
            
            pkgSelect.innerHTML = '<option value="" selected>-- Wybierz Pakiet --</option>';
            
            // Filter
            const filtered = (filterLevel === 'all') 
                ? allPackagesCache 
                : allPackagesCache.filter(p => p.level == filterLevel); // loose equality for string/int

            if (filtered.length > 0) {
                const lvlMap = {1: 'Podst.', 2: 'Średnia', 3: 'Wyższa'};
                filtered.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    const lvlLabel = lvlMap[p.level] || '';
                    opt.textContent = `[${lvlLabel}] ${p.title}`;
                    pkgSelect.appendChild(opt);
                });
            } else {
                pkgSelect.innerHTML = '<option value="" disabled>Brak pakietów dla tego poziomu</option>';
            }
        }

        async function assignCourseToClass(e) {
            e.preventDefault();
            const packageId = document.getElementById('assign-package-select').value;
            const classId = document.getElementById('assign-class-select').value;
            if(!packageId || !classId) return alert("Wybierz pakiet i klasę!");
            const { error } = await _supabase.from('package_classes').insert({ package_id: packageId, class_id: classId });
            if(error) { if(error.code === '23505') alert("Już przypisano!"); else alert("Błąd: " + error.message); } 
            else { alert("✅ Pakiet przypisany!"); closeModal('assignCourseModal'); }
        }
        // --- EXISTING FUNCTIONS (Add School, Class, User, etc) ---
        async function addSchool(e) {
            e.preventDefault();
            const name = document.getElementById('school-name').value;
            const address = document.getElementById('school-address').value;
            const { error } = await _supabase.from('schools').insert({ name, address });
            if (error) alert("Błąd: " + error.message);
            else { alert("Szkoła dodana!"); closeModal('addSchoolModal'); document.getElementById('addSchoolForm').reset(); }
        }

        async function addClass(e) {
            e.preventDefault();
            const schoolId = document.getElementById('class-school-select').value;
            const name = document.getElementById('class-name').value;
            if (!schoolId) return alert("Wybierz szkołę!");
            const { error } = await _supabase.from('classes').insert({ school_id: schoolId, name });
            if (error) alert("Błąd: " + error.message);
            else { alert("Klasa dodana!"); closeModal('addClassModal'); document.getElementById('addClassForm').reset(); }
        }

        async function openCreateUserModal() {
            openModal('createUserModal');
            const schoolSelect = document.getElementById('new-user-school');
            const roleSelect = document.getElementById('new-role');
            
            if (currentUserRole === 'manager') {
                Array.from(roleSelect.options).forEach(opt => {
                    if (opt.value === 'admin' || opt.value === 'manager') { opt.style.display = 'none'; opt.disabled = true; }
                    else { opt.style.display = ''; opt.disabled = false; }
                });
                if (roleSelect.value === 'admin' || roleSelect.value === 'manager') roleSelect.value = 'student';
            } else {
                Array.from(roleSelect.options).forEach(opt => { opt.style.display = ''; opt.disabled = false; });
            }

            const { data: schools } = await _supabase.from('schools').select('id, name');
            schoolSelect.innerHTML = '<option value="" selected>-- Brak / Ogólne --</option>';
            if (schools) {
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    schoolSelect.appendChild(opt);
                });
            }
            if (currentUserRole === 'manager' && currentUserSchoolId) schoolSelect.value = currentUserSchoolId;
        }

        async function createNewUser(e) {
            e.preventDefault();
            const btn = document.getElementById('createBtn');
            const originalText = btn.textContent;
            btn.textContent = "Tworzenie...";
            btn.disabled = true;

            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const username = document.getElementById('new-username').value;
            const role = document.getElementById('new-role').value;
            const schoolId = document.getElementById('new-user-school').value;

            try {
                const tempSupabase = supabase.createClient(supabaseUrl, supabaseKey, {
                    auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                });
                const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                    email: email, password: password,
                    options: { data: { username: username, role: role, school_id: schoolId || null, class_id: null } }
                });
                if (authError) throw authError;
                alert(`✅ Sukces! Utworzono użytkownika: ${username}`);
                closeModal('createUserModal');
                document.getElementById('createUserForm').reset();
            } catch (err) { alert("Błąd: " + err.message); } 
            finally { btn.textContent = originalText; btn.disabled = false; }
        }

        async function openClassModal() {
            openModal('addClassModal');
            const select = document.getElementById('class-school-select');
            if (currentUserRole === 'manager' && currentUserSchoolId) {
                select.innerHTML = ''; 
                const { data: school } = await _supabase.from('schools').select('id, name').eq('id', currentUserSchoolId).single();
                const opt = document.createElement('option');
                opt.value = school.id;
                opt.textContent = school.name;
                opt.selected = true;
                select.appendChild(opt);
                select.disabled = true; 
                return;
            }
            if (currentUserRole === 'admin' && select.options.length <= 1) {
                const { data: schools } = await _supabase.from('schools').select('id, name');
                if (schools) {
                    select.innerHTML = '<option value="" disabled selected>-- Wybierz Szkołę --</option>';
                    schools.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name;
                        select.appendChild(opt);
                    });
                }
            }
        }

        async function openManageStudentsModal() {
            openModal('manageStudentsModal');
            const schoolSelect = document.getElementById('manage-school-select');
            const filterWrapper = document.getElementById('manage-class-filter-wrapper');
            const tableContainer = document.getElementById('students-table-container');
            
            tableContainer.style.display = 'none';
            filterWrapper.style.display = 'none'; // Hide filter until school is active
            document.getElementById('students-table-body').innerHTML = '';

            if (currentUserRole === 'manager' && currentUserSchoolId) {
                schoolSelect.parentElement.style.display = 'none'; 
                loadStudentsForSchool(currentUserSchoolId);
            } else if (currentUserRole === 'admin') {
                schoolSelect.parentElement.style.display = 'block';
                const { data: schools } = await _supabase.from('schools').select('id, name');
                schoolSelect.innerHTML = '<option value="" disabled selected>Wybierz...</option>';
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.name;
                    schoolSelect.appendChild(opt);
                });
            }
        }

        async function loadStudentsForSchool(schoolId) {
            if (!schoolId) return;
            const tableBody = document.getElementById('students-table-body');
            const container = document.getElementById('students-table-container');
            const msg = document.getElementById('no-students-msg');
            const loading = document.getElementById('students-loading');
            
            // Filter elements
            const filterWrapper = document.getElementById('manage-class-filter-wrapper');
            const filterSelect = document.getElementById('filter-class-select');

            loading.style.display = 'block';
            container.style.display = 'none';
            msg.style.display = 'none';
            filterWrapper.style.display = 'none'; // Hide while loading
            tableBody.innerHTML = '';

            const { data: students } = await _supabase.from('users').select('id, username, email, class_id').eq('school_id', schoolId).eq('role', 'student');
            const { data: classes } = await _supabase.from('classes').select('id, name').eq('school_id', schoolId);

            loading.style.display = 'none';
            container.style.display = 'block';
            filterWrapper.style.display = 'block'; // Show filter

            // 1. Populate Class Filter Dropdown
            // Reset filter to "All"
            filterSelect.value = "all";
            // Clear old class options but keep static ones (All, None)
            while (filterSelect.options.length > 2) {
                filterSelect.remove(2);
            }
            if (classes) {
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    filterSelect.appendChild(opt);
                });
            }

            if (!students || students.length === 0) { msg.style.display = 'block'; return; }

            // 2. Render Rows
            students.forEach(student => {
                const tr = document.createElement('tr');
                // STORE CLASS ID IN DATA ATTRIBUTE FOR FILTERING
                tr.setAttribute('data-class-id', student.class_id || 'none');
                
                const tdName = document.createElement('td'); tdName.innerHTML = `<b>${student.username}</b>`;
                const tdEmail = document.createElement('td'); tdEmail.textContent = student.email;
                const tdClass = document.createElement('td');
                const select = document.createElement('select');
                select.className = 'class-select-small';
                const defOpt = document.createElement('option'); defOpt.value = ""; defOpt.textContent = "-- Brak klasy --";
                if (!student.class_id) defOpt.selected = true;
                select.appendChild(defOpt);
                if (classes) {
                    classes.forEach(c => {
                        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name;
                        if (student.class_id === c.id) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
                tdClass.appendChild(select);
                const tdAction = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = 'save-mini-btn'; btn.textContent = 'Zapisz';
                btn.onclick = () => updateStudentClass(student.id, select.value, btn);
                tdAction.appendChild(btn);

                tr.appendChild(tdName); tr.appendChild(tdEmail); tr.appendChild(tdClass); tr.appendChild(tdAction);
                tableBody.appendChild(tr);
            });
        }

        // NEW FILTER FUNCTION
        function filterStudentsTable() {
            const filterValue = document.getElementById('filter-class-select').value;
            const rows = document.querySelectorAll('#students-table-body tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const rowClassId = row.getAttribute('data-class-id');
                
                if (filterValue === 'all') {
                    row.style.display = '';
                    visibleCount++;
                } else if (filterValue === 'none') {
                    // Show if classId is missing or explicit 'none' string
                    if (rowClassId === 'none' || !rowClassId) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                } else {
                    // Specific class ID
                    if (rowClassId == filterValue) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });

            // Show "No students" message if filter hides everything
            const msg = document.getElementById('no-students-msg');
            if (visibleCount === 0) {
                msg.style.display = 'block';
                msg.textContent = 'Brak studentów w wybranej grupie.';
            } else {
                msg.style.display = 'none';
            }
        }

        async function updateStudentClass(userId, classId, btn) {
            const originalText = btn.textContent;
            btn.textContent = "..."; btn.disabled = true;
            const finalClassId = classId ? parseInt(classId) : null;
            const { error } = await _supabase.from('users').update({ class_id: finalClassId }).eq('id', userId);
            
            if (error) { 
                alert("Błąd: " + error.message); 
                btn.textContent = originalText; 
            } else { 
                btn.textContent = "✔ OK"; 
                btn.style.background = "green"; 
                
                // UPDATE DATA ATTRIBUTE TO REFLECT CHANGE FOR FILTER
                const row = btn.closest('tr');
                if (row) {
                    row.setAttribute('data-class-id', finalClassId || 'none');
                }

                setTimeout(() => { 
                    btn.textContent = "Zapisz"; 
                    btn.style.background = ""; 
                    btn.disabled = false; 
                }, 1500); 
            }
        }
    </script>
</body>
</html>







