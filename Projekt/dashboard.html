<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Pulpit</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- STYLE DLA MODALI I LIST --- */
        
        /* Styl listy edycji klas */
        .class-edit-item {
            border-bottom: 1px solid var(--border-color);
            padding: 12px;
            transition: background 0.2s;
        }
        .class-edit-item:hover { background: var(--hover-bg); }

        .class-row-header {
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 8px; /* Odstƒôp od pakiet√≥w */
        }

        /* Przyciski w edycji klasy */
        .save-mini-btn { 
            padding: 5px 10px; font-size: 12px; background: #4CAF50; color: white; 
            border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; 
        }
        .delete-mini-btn { 
            cursor: pointer; color: var(--accent-color); font-size: 18px; margin-left: 10px; 
        }

        /* --- STYL DLA "CHIP√ìW" (PAKIET√ìW) --- */
        .packages-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding-left: 2px;
        }

        .pkg-chip {
            display: inline-flex;
            align-items: center;
            background-color: rgba(33, 150, 243, 0.1); /* Jasny niebieski */
            color: #1565C0;
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 500;
        }

        .pkg-chip-remove {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
            color: #1565C0;
            opacity: 0.6;
            font-size: 14px;
            line-height: 1;
        }
        .pkg-chip-remove:hover { opacity: 1; color: red; }

        /* Obs≈Çuga trybu ciemnego */
        @media (prefers-color-scheme: dark) {
            .pkg-chip {
                background-color: rgba(33, 150, 243, 0.2);
                color: #90caf9;
                border-color: rgba(33, 150, 243, 0.5);
            }
            .pkg-chip-remove { color: #90caf9; }
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="#" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Pulpit</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <h1 id="welcome-message">Witaj!</h1>
                    <p>Wybierz modu≈Ç, aby kontynuowaƒá.</p>
                </div>
            </div>

            <div class="dashboard-grid">
                
                <a href="admin_content.html" id="widget-admin-content" class="widget-tile" style="display: none; border: 2px solid #333;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23333%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z%22></path><polyline points=%2214 2 14 8 20 8%22></polyline><line x=%2216%22 y1=%2213%22 x2=%228%22 y2=%2213%22></line><line x=%2216%22 y1=%2217%22 x2=%228%22 y2=%2217%22></line><polyline points=%2210 9 9 9 8 9%22></polyline></svg>');"></div>
                    <h3>Baza Tre≈õci</h3>
                    <p class="course-meta">PrzeglƒÖdaj i Edytuj</p>
                </a>

                <a href="create_course.html" id="widget-create-course" class="widget-tile" style="display: none; border: 2px dashed var(--accent-color);">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23f04a4a%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%223%22 width=%2218%22 height=%2218%22 rx=%222%22 ry=%222%22></rect><line x=%2212%22 y=%228%22 x2=%2212%22 y2=%2216%22></line><line x=%228%22 y=%2212%22 x2=%2216%22 y2=%2212%22></line></svg>');"></div>
                    <h3 style="color: var(--accent-color);">Utw√≥rz Kurs</h3>
                    <p class="course-meta">Administrator</p>
                </a>

                <a href="create_quiz.html" id="widget-create-quiz" class="widget-tile" style="display: none; border: 2px dashed #9C27B0;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239C27B0%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z%22></path><polyline points=%2214 2 14 8 20 8%22></polyline><line x=%2212%22 y=%2218%22 x2=%2212%22 y2=%2218%22></line><line x=%2212%22 y=%2214%22 x2=%2212%22 y2=%2212%22></line></svg>');"></div>
                    <h3 style="color: #9C27B0;">Utw√≥rz Quiz</h3>
                    <p class="course-meta">Administrator</p>
                </a>
                
                <div id="widget-add-user" class="widget-tile" style="display: none; border: 2px dashed #555; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23555%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%228.5%22 cy=%227%22 r=%224%22></circle><line x=%2220%22 y=%2218%22 x2=%2220%22 y2=%2214%22></line><line x=%2223%22 y=%2211%22 x2=%2217%22 y2=%2211%22></line></svg>');"></div>
                    <h3 style="color: #555;">Dodaj U≈ºytkownika</h3>
                    <p class="course-meta">Admin & Manager</p>
                </div>

                <div id="widget-add-school" class="widget-tile" style="display: none; border: 2px dashed #2196F3; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%232196F3%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M3 21h18M5 21V7l8-4 8 4v14M8 21v-4h8v4%22></path></svg>');"></div>
                    <h3 style="color: #2196F3;">Dodaj Szko≈Çƒô</h3>
                    <p class="course-meta">Administrator</p>
                </div>

                <div id="widget-add-class" class="widget-tile" style="display: none; border: 2px dashed #4CAF50; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%234CAF50%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%229%22 cy=%227%22 r=%224%22></circle><path d=%22M23 21v-2a4 4 0 0 0-3-3.87%22></path><path d=%22M16 3.13a4 4 0 0 1 0 7.75%22></path></svg>');"></div>
                    <h3 style="color: #4CAF50;">Dodaj Klasƒô</h3>
                    <p class="course-meta">Admin & Manager</p>
                </div>

                <div id="widget-manage-classes" class="widget-tile" style="display: none; border: 2px dashed #009688; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23009688%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7%22></path><path d=%22M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z%22></path></svg>');"></div>
                    <h3 style="color: #009688;">ZarzƒÖdzaj Klasami</h3>
                    <p class="course-meta">Edycja i Usuwanie</p>
                </div>

                <div id="widget-manage-students" class="widget-tile" style="display: none; border: 2px dashed #FF9800; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23FF9800%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%229%22 cy=%227%22 r=%224%22></circle><path d=%22M23 21v-2a4 4 0 0 0-3-3.87%22></path><path d=%22M16 3.13a4 4 0 0 1 0 7.75%22></path></svg>');"></div>
                    <h3 style="color: #FF9800;">ZarzƒÖdzaj Uczniami</h3>
                    <p class="course-meta">Edycja i Usuwanie</p>
                </div>

                <div id="widget-assign-course" class="widget-tile" style="display: none; border: 2px dashed #9C27B0; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%239C27B0%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M4 19.5A2.5 2.5 0 0 1 6.5 17H20%22></path><path d=%22M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z%22></path><path d=%22M12 11h5%22></path><path d=%22M12 8h5%22></path></svg>');"></div>
                    <h3 style="color: #9C27B0;">Przypisz Materia≈Ç</h3>
                    <p class="course-meta">Dodaj pakiet do klasy</p>
                </div>
                
                <a href="teacher_results.html" id="widget-teacher-results" class="widget-tile" style="display: none; border: 2px solid #673AB7; text-decoration: none; color: inherit;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23673AB7%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z%22></path><polyline points=%2214 2 14 8 20 8%22></polyline><line x=%2216%22 y1=%2213%22 x2=%228%22 y2=%2213%22></line><line x=%2216%22 y1=%2217%22 x2=%228%22 y2=%2217%22></line><polyline points=%2210 9 9 9 8 9%22></polyline></svg>');"></div>
                    <h3 style="color: #673AB7;">Wyniki Uczni√≥w</h3>
                    <p class="course-meta">PodglƒÖd i Poprawy</p>
                </a>

                <a href="teacher_grades.html" id="widget-teacher-grades" class="widget-tile" style="display: none; border: 2px solid #FF9800; text-decoration: none; color: inherit;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23FF9800%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2%22></path><rect x=%228%22 y=%222%22 width=%228%22 height=%224%22 rx=%221%22 ry=%221%22></rect><path d=%22M9 14l2 2 4-4%22></path></svg>');"></div>
                    <h3 style="color: #FF9800;">Dziennik Ocen</h3>
                    <p class="course-meta">Wystawianie i edycja</p>
                </a>

                <a href="courses_list.html" id="widget-student-courses" class="widget-tile">
                    <div class="widget-icon icon-course-active"></div>
                    <h3>Moje Przedmioty</h3>
                    <p class="course-meta">Przejd≈∫ do nauki</p>
                </a>

                <a href="grades.html" id="widget-student-grades" class="widget-tile">
                    <div class="widget-icon icon-grades"></div>
                    <h3>Moje Oceny</h3>
                    <p class="course-meta">Sprawd≈∫ wyniki</p>
                </a>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyƒá opcje"></div>
                <div class="dropdown-menu" id="profileDropdown">
                    <div class="dropdown-item" id="logoutBtn">
                        <div class="icon-logout"></div>
                        Wyloguj siƒô
                    </div>
                </div>
                <h2 class="profile-name" id="profile-name-display">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
                <p style="font-size: 13px; color: #888; margin-top: 5px; max-width: 200px; line-height: 1.4;" id="profile-school-display"></p>
            </div>
        </aside>
    </div>

    <div class="modal-overlay" id="createUserModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj U≈ºytkownika</h3>
                <span class="close-modal" onclick="closeModal('createUserModal')">&times;</span>
            </div>
            <form id="createUserForm" class="modal-form">
                <label>Nazwa (Imiƒô i Nazwisko)</label>
                <input type="text" id="new-username" class="edit-input" required>
                
                <label>Rola</label>
                <select id="new-role" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;">
                    <option value="student" selected>Student</option>
                    <option value="teacher">Nauczyciel</option>
                    <option value="manager">Dziekanat (Manager)</option>
                    <option value="admin">Administrator</option>
                </select>

                <div id="school-select-container" style="display: block;">
                    <label>Typ Szko≈Çy</label>
                    <select id="new-user-level-filter" class="edit-input" style="border:1px solid #ccc; margin-bottom: 10px;">
                        <option value="" disabled selected>-- Wybierz Typ --</option>
                        <option value="1">Szko≈Ça Podstawowa</option>
                        <option value="2">Szko≈Ça ≈örednia</option>
                        <option value="3">Szko≈Ça Wy≈ºsza</option>
                    </select>

                    <label>Szko≈Ça / Wydzia≈Ç</label>
                    <select id="new-user-school" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;" disabled>
                        <option value="" selected disabled>-- Najpierw wybierz typ --</option>
                    </select>

                    <div id="class-select-container" style="display:none;">
                        <label>Klasa (Opcjonalnie)</label>
                        <select id="new-user-class" class="edit-input" style="border:1px solid #ccc; margin-bottom: 15px;" disabled>
                            <option value="" selected disabled>-- Najpierw wybierz szko≈Çƒô --</option>
                        </select>
                    </div>
                </div>

                <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                    <label style="margin:0; font-size:12px; color:#555; text-transform:uppercase;">Login (Generowany automatycznie)</label>
                    <input type="text" id="new-email" class="edit-input" 
                           style="background:transparent; border:none; font-weight:bold; color:#333; margin:0; padding:5px 0; width:100%;" 
                           readonly placeholder="Wype≈Çnij formularz..." required>
                </div>

                <label>Has≈Ço</label>
                <input type="password" id="new-password" class="edit-input" required placeholder="Has≈Ço startowe">
                
                <button type="submit" class="login-button full-width-btn" id="createBtn">Utw√≥rz konto</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="addSchoolModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Szko≈Çƒô</h3>
                <span class="close-modal" onclick="closeModal('addSchoolModal')">&times;</span>
            </div>
            <form id="addSchoolForm" class="modal-form">
                <label>Nazwa Szko≈Çy</label>
                <input type="text" id="school-name" class="edit-input" placeholder="np. Liceum nr 1" required>
                <label>Skr√≥t (max 5 znak√≥w)</label>
                <input type="text" id="school-abbr" class="edit-input" placeholder="LO1" maxlength="5" style="text-transform:uppercase;" required>
                <label>Poziom Szko≈Çy</label>
                <select id="school-level" class="edit-input" style="border:1px solid #ccc;" required>
                    <option value="1">Szko≈Ça Podstawowa</option>
                    <option value="2">Szko≈Ça ≈örednia</option>
                    <option value="3">Szko≈Ça Wy≈ºsza</option>
                </select>
                <label>Adres</label>
                <input type="text" id="school-address" class="edit-input">
                <button type="submit" class="login-button full-width-btn">Zapisz Szko≈Çƒô</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="addClassModal"><div class="modal-window"><div class="modal-header"><h3 class="modal-title">Dodaj Klasƒô/Grupƒô</h3><span class="close-modal" onclick="closeModal('addClassModal')">&times;</span></div><form id="addClassForm" class="modal-form"><label>Wybierz Szko≈Çƒô</label><select id="class-school-select" class="edit-input" style="border:1px solid #ccc;" required><option value="" disabled selected>≈Åadowanie szk√≥≈Ç...</option></select><label>Nazwa Klasy</label><input type="text" id="class-name" class="edit-input" placeholder="np. 1A - Informatyka" required><button type="submit" class="login-button full-width-btn">Zapisz Klasƒô</button></form></div></div>
    
    <div class="modal-overlay" id="manageStudentsModal"><div class="modal-window" style="max-width: 900px;"><div class="modal-header"><h3 class="modal-title">ZarzƒÖdzanie Uczniami</h3><span class="close-modal" onclick="closeModal('manageStudentsModal')">&times;</span></div>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <div style="flex:1;">
                <label>Typ Szko≈Çy</label>
                <select id="manage-level-filter" class="edit-input" style="margin:0;"><option value="" disabled selected>-- Wybierz --</option><option value="1">Podst.</option><option value="2">≈örednia</option><option value="3">Wy≈ºsza</option><option value="all">Wszystkie</option></select>
            </div>
            <div id="manage-school-wrapper" style="flex: 2;">
                <label>Szko≈Ça</label>
                <select id="manage-school-select" class="edit-input" style="margin:0;"><option value="" disabled selected>Najpierw typ...</option></select>
            </div>
            <div id="manage-class-filter-wrapper" style="flex: 1; display: none;">
                <label>Filtruj klasƒô</label>
                <select id="filter-class-select" class="edit-input" style="margin:0;"><option value="all" selected>Wszyscy</option></select>
            </div>
        </div>
        <div id="students-loading" style="display:none; text-align:center;">≈Åadowanie listy...</div>
        <div id="students-table-container" style="max-height: 400px; overflow-y: auto; display: none;">
            <table class="student-table"><thead><tr><th>Imiƒô i Nazwisko</th><th>Login</th><th>Klasa</th><th>Akcje</th></tr></thead><tbody id="students-table-body"></tbody></table>
            <p id="no-students-msg" style="text-align:center; color:#888; display:none; padding:20px;">Brak student√≥w.</p>
        </div></div></div>
    
    <div class="modal-overlay" id="assignCourseModal"><div class="modal-window"><div class="modal-header"><h3 class="modal-title">Przypisz Pakiet do Klasy</h3><span class="close-modal" onclick="closeModal('assignCourseModal')">&times;</span></div><form id="assignCourseForm" class="modal-form"><div style="margin-bottom: 10px;">
        <label>1. Wybierz Szko≈Çƒô</label><select id="assign-school-select" class="edit-input" style="border:1px solid #ccc; margin-bottom:10px;"><option value="">-- Wybierz --</option></select>
        <label>2. Wybierz Klasƒô</label><select id="assign-class-select" class="edit-input" style="border:1px solid #ccc; margin-bottom:10px;" disabled><option value="">-- Wybierz szko≈Çƒô najpierw --</option></select>
        <label>3. Wybierz Pakiet</label><select id="assign-package-select" class="edit-input" style="border:1px solid #ccc;" required><option value="" disabled selected>-- Wybierz Pakiet --</option></select>
    </div><button type="submit" class="login-button full-width-btn">Przypisz Pakiet</button></form></div></div>

    <div class="modal-overlay" id="manageClassesModal">
        <div class="modal-window" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Edycja Klas</h3>
                <span class="close-modal" onclick="closeModal('manageClassesModal')">&times;</span>
            </div>
            
            <label>Wybierz Szko≈Çƒô, aby edytowaƒá klasy:</label>
            <select id="manage-class-school-select" class="edit-input" style="border:1px solid #ccc; margin-bottom:20px;">
                <option value="">≈Åadowanie szk√≥≈Ç...</option>
            </select>

            <div id="classes-list-container" style="max-height: 400px; overflow-y: auto;">
                <p style="color:#888; text-align:center;">Wybierz szko≈Çƒô, aby zobaczyƒá listƒô.</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUserRole = null;
        let currentUserSchoolId = null;
        let schoolsCache = [];
        let generatedMemberCode = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const userId = session.user.id;
            const { data: profile } = await _supabase.from('users').select('username, role, school_id, schools(name), classes(name)').eq('id', userId).single();

            if (profile) {
                currentUserRole = profile.role;
                currentUserSchoolId = profile.school_id;
                document.getElementById('profile-name-display').textContent = profile.username;
                const roleMap = { 'student': 'UCZE≈É', 'teacher': 'NAUCZYCIEL', 'manager': 'DZIEKANAT', 'admin': 'ADMIN' };
                document.getElementById('profile-role-display').textContent = (roleMap[profile.role] || profile.role).toUpperCase();
                
                let schoolInfo = "";
                if (profile.schools && profile.schools.name) schoolInfo = profile.schools.name;
                if (profile.classes && profile.classes.name) schoolInfo += `<br><span style="color:var(--accent-color); font-weight:bold;">${profile.classes.name}</span>`;
                document.getElementById('profile-school-display').innerHTML = schoolInfo;
                document.getElementById('welcome-message').textContent = `Witaj, ${profile.username}!`;

                // --- ROLE VISIBILITY ---
                if (['admin', 'manager', 'teacher'].includes(currentUserRole)) {
                    show('widget-assign-course');
                    show('widget-teacher-results');
                    show('widget-teacher-grades'); // Poka≈º Dziennik
                    document.getElementById('widget-assign-course').onclick = () => openAssignCourseModal();
                }

                if (currentUserRole === 'admin') {
                    ['widget-admin-content', 'widget-create-course', 'widget-create-quiz', 'widget-add-user', 'widget-add-school', 'widget-add-class', 'widget-manage-students', 'widget-manage-classes'].forEach(show);
                    ['widget-student-courses', 'widget-student-grades'].forEach(hide);
                    
                    document.getElementById('widget-add-user').onclick = () => openCreateUserModal();
                    document.getElementById('widget-add-school').onclick = () => openModal('addSchoolModal');
                    document.getElementById('widget-add-class').onclick = () => openClassModal();
                    document.getElementById('widget-manage-students').onclick = () => openManageStudentsModal();
                    document.getElementById('widget-manage-classes').onclick = () => openManageClassesModal();
                }

                if (currentUserRole === 'manager') {
                    show('widget-add-user');
                    show('widget-add-class');
                    show('widget-manage-students');
                    show('widget-manage-classes');
                    document.getElementById('widget-add-user').onclick = () => openCreateUserModal();
                    document.getElementById('widget-add-class').onclick = () => openClassModal();
                    document.getElementById('widget-manage-students').onclick = () => openManageStudentsModal();
                    document.getElementById('widget-manage-classes').onclick = () => openManageClassesModal();
                }
            }

            // Dropdown & Logout
            document.getElementById('avatarTrigger').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('profileDropdown').classList.toggle('show'); });
            window.addEventListener('click', () => document.getElementById('profileDropdown').classList.remove('show'));
            document.getElementById('logoutBtn').addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.href = 'login.html'; });

            // Listeners for Forms
            document.getElementById('createUserForm').addEventListener('submit', createNewUser);
            document.getElementById('addSchoolForm').addEventListener('submit', addSchool);
            document.getElementById('addClassForm').addEventListener('submit', addClass);
            document.getElementById('assignCourseForm').addEventListener('submit', assignCourseToClass);
            
            // Filters & Logic
            document.getElementById('new-role').addEventListener('change', handleRoleChange);
            document.getElementById('new-user-level-filter').addEventListener('change', filterNewUserSchools);
            document.getElementById('new-user-school').addEventListener('change', async function() {
                await loadClassesForSchool(this.value); 
                generateEmail();
            });
            document.getElementById('new-user-class').addEventListener('change', generateEmail);

            // MANAGE STUDENTS Logic
            document.getElementById('manage-level-filter').addEventListener('change', filterManageStudentSchools);
            document.getElementById('manage-school-select').addEventListener('change', function() { loadStudentsForSchool(this.value); });
            document.getElementById('filter-class-select').addEventListener('change', filterStudentsTable);

            // MANAGE CLASSES Logic
            document.getElementById('manage-class-school-select').addEventListener('change', function() { loadClassesForEdit(this.value); });

            // ASSIGN PACKAGE Logic (Fixed with parseInt)
            document.getElementById('assign-school-select').addEventListener('change', async function() {
                const sid = parseInt(this.value); 
                console.log("Wybrano szko≈Çƒô do pakietu:", sid);

                const cSelect = document.getElementById('assign-class-select');
                cSelect.disabled = true; 
                cSelect.innerHTML = '<option>≈Åadowanie...</option>';
                
                const { data, error } = await _supabase.from('classes').select('id, name').eq('school_id', sid).order('name');

                if (error) { console.error(error); cSelect.innerHTML = '<option>B≈ÇƒÖd</option>'; return; }

                cSelect.innerHTML = '<option value="" disabled selected>-- Wybierz Klasƒô --</option>';
                if (data && data.length > 0) {
                    data.forEach(c => cSelect.add(new Option(c.name, c.id)));
                    cSelect.disabled = false;
                } else {
                    cSelect.innerHTML = '<option value="" disabled selected>Brak klas</option>';
                }
            });
        });

        // --- COMMON FUNCTIONS ---
        function show(id) { const el=document.getElementById(id); if(el)el.style.display='flex'; }
        function hide(id) { const el=document.getElementById(id); if(el)el.style.display='none'; }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- LOAD SCHOOLS CACHE ---
        async function ensureSchoolsCache() {
            if (schoolsCache.length === 0) {
                const { data } = await _supabase.from('schools').select('id, name, level, abbreviation');
                schoolsCache = data || [];
            }
        }

        // --- USER CREATION ---
        async function openCreateUserModal() {
            openModal('createUserModal');
            await ensureSchoolsCache();
            document.getElementById('new-user-level-filter').value = "";
            const sSelect = document.getElementById('new-user-school');
            sSelect.innerHTML = '<option value="" disabled selected>-- Wybierz typ najpierw --</option>';
            sSelect.disabled = true;
            document.getElementById('class-select-container').style.display = 'none';
        }

        function handleRoleChange() {
            const role = document.getElementById('new-role').value;
            const schoolContainer = document.getElementById('school-select-container');
            const classContainer = document.getElementById('class-select-container');
            const emailInput = document.getElementById('new-email');

            if (role === 'admin') {
                schoolContainer.style.display = 'none';
                emailInput.removeAttribute('readonly');
                emailInput.value = "";
                emailInput.placeholder = "Wpisz email administratora";
            } else {
                schoolContainer.style.display = 'block';
                emailInput.setAttribute('readonly', true);
                emailInput.placeholder = "Wybierz szko≈Çƒô...";
                classContainer.style.display = (role === 'student') ? 'block' : 'none';
                if(document.getElementById('new-user-school').value) generateEmail();
            }
        }

        function filterNewUserSchools() {
            const lvl = document.getElementById('new-user-level-filter').value;
            const sSelect = document.getElementById('new-user-school');
            sSelect.innerHTML = '<option value="" disabled selected>-- Wybierz Szko≈Çƒô --</option>';
            const filtered = schoolsCache.filter(s => s.level == lvl);
            filtered.forEach(s => sSelect.add(new Option(s.name, s.id)));
            sSelect.disabled = false;
        }

        async function loadClassesForSchool(schoolId) {
            const cSelect = document.getElementById('new-user-class');
            cSelect.innerHTML = '<option>≈Åadowanie...</option>';
            cSelect.disabled = true;
            const { data } = await _supabase.from('classes').select('id, name').eq('school_id', schoolId);
            cSelect.innerHTML = '<option value="" selected>-- Brak / Nie dotyczy --</option>';
            if(data) data.forEach(c => cSelect.add(new Option(c.name, c.id)));
            cSelect.disabled = false;
        }

        async function generateEmail() {
            const role = document.getElementById('new-role').value;
            const schoolId = document.getElementById('new-user-school').value;
            const emailInput = document.getElementById('new-email');
            if (role === 'admin' || !schoolId) return;
            emailInput.value = "Generowanie ID...";
            
            const school = schoolsCache.find(s => s.id == schoolId);
            const abbr = school ? school.abbreviation : "SZKOLA";
            const { count } = await _supabase.from('users').select('*', { count: 'exact', head: true }).eq('school_id', schoolId).eq('role', role);
            
            const nextNum = (count || 0) + 1;
            generatedMemberCode = nextNum;
            const padCode = String(nextNum).padStart(4, '0');
            const suffix = (role === 'student') ? 'student' : 'kadra';
            emailInput.value = `${padCode}.${abbr}-${suffix}@muczelnia.pl`;
        }

        async function createNewUser(e) {
            e.preventDefault();
            const btn = document.getElementById('createBtn');
            btn.disabled = true; btn.textContent = "Tworzenie...";
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const username = document.getElementById('new-username').value;
            const role = document.getElementById('new-role').value;
            const schoolId = document.getElementById('new-user-school').value;
            const classId = document.getElementById('new-user-class').value || null;

            const tempSupabase = supabase.createClient(supabaseUrl, supabaseKey, { auth: { persistSession: false } });
            const { error } = await tempSupabase.auth.signUp({
                email: email, password: password,
                options: { data: { username: username, role: role, school_id: schoolId || null, class_id: classId, member_code: generatedMemberCode } }
            });
            if (error) alert("B≈ÇƒÖd: " + error.message);
            else { alert(`‚úÖ Utworzono konto: ${email}`); closeModal('createUserModal'); document.getElementById('createUserForm').reset(); }
            btn.disabled = false; btn.textContent = "Utw√≥rz konto";
        }

        // --- SCHOOL & CLASS CREATION ---
        async function addSchool(e) {
            e.preventDefault();
            const { error } = await _supabase.from('schools').insert({
                name: document.getElementById('school-name').value,
                abbreviation: document.getElementById('school-abbr').value,
                level: document.getElementById('school-level').value,
                address: document.getElementById('school-address').value
            });
            if (error) alert(error.message); else { alert("Dodano"); closeModal('addSchoolModal'); schoolsCache=[]; }
        }

        async function openClassModal(){ 
            openModal('addClassModal'); 
            const s = document.getElementById('class-school-select');
            const {data} = await _supabase.from('schools').select('id, name');
            s.innerHTML = '<option value="">-- Wybierz --</option>';
            data.forEach(x => s.add(new Option(x.name, x.id)));
        }

        async function addClass(e){
            e.preventDefault(); 
            const {error} = await _supabase.from('classes').insert({
                school_id: document.getElementById('class-school-select').value, 
                name: document.getElementById('class-name').value
            }); 
            if(error) alert(error.message); else {alert("Dodano"); closeModal('addClassModal');}
        }

        // --- MANAGE STUDENTS (FIXED) ---
        async function openManageStudentsModal() { 
            openModal('manageStudentsModal'); 
            await ensureSchoolsCache(); // Upewnij siƒô, ≈ºe mamy szko≈Çy
            
            // Reset filters
            document.getElementById('manage-level-filter').value = "";
            document.getElementById('manage-school-select').innerHTML = '<option value="" disabled selected>Najpierw typ...</option>';
        }

        function filterManageStudentSchools() {
            const lvl = document.getElementById('manage-level-filter').value;
            const sSelect = document.getElementById('manage-school-select');
            sSelect.innerHTML = '<option value="" disabled selected>Wybierz...</option>';
            
            const filtered = (lvl === 'all') ? schoolsCache : schoolsCache.filter(s => s.level == lvl);
            filtered.forEach(s => sSelect.add(new Option(s.name, s.id)));
        }

        async function loadStudentsForSchool(sid) { 
            const tb = document.getElementById('students-table-body');
            const loading = document.getElementById('students-loading');
            const container = document.getElementById('students-table-container');
            const classFilter = document.getElementById('filter-class-select');
            
            loading.style.display = 'block'; container.style.display = 'none'; tb.innerHTML = '';
            
            const { data: students, error } = await _supabase.from('users').select('id, username, email, class_id').eq('school_id', sid).eq('role', 'student');
            if(error) console.error("Error loading students:", error);

            const { data: classes } = await _supabase.from('classes').select('id, name').eq('school_id', sid);
            
            classFilter.innerHTML = '<option value="all">Wszyscy</option>';
            if(classes) classes.forEach(c => classFilter.add(new Option(c.name, c.id)));

            loading.style.display = 'none'; container.style.display = 'block';

            if (!students || students.length === 0) { document.getElementById('no-students-msg').style.display = 'block'; return; }
            document.getElementById('no-students-msg').style.display = 'none';

            students.forEach(s => {
                const tr = document.createElement('tr');
                tr.dataset.classId = s.class_id || 'none';
                
                const classSel = document.createElement('select');
                classSel.className = 'class-select-small';
                classSel.add(new Option('-- Brak --', ''));
                if(classes) classes.forEach(c => {
                    const opt = new Option(c.name, c.id);
                    if(s.class_id === c.id) opt.selected = true;
                    classSel.add(opt);
                });

                const actionsTd = document.createElement('td');
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'üíæ'; saveBtn.className = 'action-icon'; saveBtn.style.border="none"; saveBtn.style.background="transparent";
                saveBtn.onclick = async () => {
                    const cid = classSel.value ? parseInt(classSel.value) : null;
                    await _supabase.from('users').update({class_id: cid}).eq('id', s.id);
                    tr.dataset.classId = cid || 'none';
                    alert("Zapisano klasƒô");
                };

                const delBtn = document.createElement('span');
                delBtn.textContent = '‚ùå'; delBtn.className = 'action-icon'; delBtn.style.color = "red";
                delBtn.onclick = async () => {
                    if(confirm(`UsunƒÖƒá u≈ºytkownika ${s.username}?`)) {
                        const { error } = await _supabase.from('users').delete().eq('id', s.id);
                        if(error) alert("B≈ÇƒÖd: " + error.message); else tr.remove();
                    }
                };

                actionsTd.appendChild(saveBtn);
                actionsTd.appendChild(delBtn);
                tr.innerHTML = `<td><b>${s.username}</b></td><td>${s.email}</td>`;
                const tdClass = document.createElement('td'); tdClass.appendChild(classSel);
                tr.appendChild(tdClass);
                tr.appendChild(actionsTd);
                tb.appendChild(tr);
            });
        }

        function filterStudentsTable() {
            const val = document.getElementById('filter-class-select').value;
            const rows = document.querySelectorAll('#students-table-body tr');
            rows.forEach(r => {
                const cid = r.dataset.classId;
                if(val === 'all' || (val === 'none' && (!cid || cid === 'none')) || cid == val) r.style.display = '';
                else r.style.display = 'none';
            });
        }

        // --- MANAGE CLASSES (Z CHIPAMI) ---
        async function openManageClassesModal() {
            openModal('manageClassesModal');
            const sSelect = document.getElementById('manage-class-school-select');
            document.getElementById('classes-list-container').innerHTML = '';
            
            const { data } = await _supabase.from('schools').select('id, name').order('name');
            sSelect.innerHTML = '<option value="" disabled selected>-- Wybierz Szko≈Çƒô --</option>';
            data.forEach(s => sSelect.add(new Option(s.name, s.id)));
        }

        async function loadClassesForEdit(schoolId) {
            const container = document.getElementById('classes-list-container');
            container.innerHTML = '<p style="padding:10px; text-align:center;">≈Åadowanie klas i pakiet√≥w...</p>';
            
            const { data: classes, error } = await _supabase.from('classes')
                .select(`id, name, package_classes (id, packages ( title ))`)
                .eq('school_id', schoolId)
                .order('name');

            container.innerHTML = '';
            if (error) { console.error(error); container.innerHTML = '<p style="color:red; text-align:center;">B≈ÇƒÖd ≈Çadowania.</p>'; return; }
            if(!classes || classes.length === 0) { container.innerHTML = '<p style="color:#888; text-align:center;">Brak klas.</p>'; return; }

            classes.forEach(c => {
                const wrapper = document.createElement('div');
                wrapper.className = 'class-edit-item';

                // G√≥rny wiersz
                const header = document.createElement('div');
                header.className = 'class-row-header';

                const input = document.createElement('input');
                input.type = "text"; input.value = c.name; input.className = "edit-input"; 
                input.style.margin = "0"; input.style.width = "60%";

                const acts = document.createElement('div');
                const btnSave = document.createElement('button');
                btnSave.innerText = "Zapisz"; btnSave.className = "save-mini-btn";
                btnSave.onclick = async () => { await _supabase.from('classes').update({name: input.value}).eq('id', c.id); alert("Zapisano!"); };

                const btnDel = document.createElement('span');
                btnDel.innerText = "üóëÔ∏è"; btnDel.className = "delete-mini-btn";
                btnDel.onclick = async () => { if(confirm("UsunƒÖƒá klasƒô?")) { const {error} = await _supabase.from('classes').delete().eq('id', c.id); if(error)alert(error.message); else wrapper.remove(); }};

                acts.appendChild(btnSave); acts.appendChild(btnDel);
                header.appendChild(input); header.appendChild(acts);

                // Chipy
                const pkgContainer = document.createElement('div');
                pkgContainer.className = 'packages-container';
                if (c.package_classes && c.package_classes.length > 0) {
                    c.package_classes.forEach(pc => {
                        if (pc.packages) {
                            const chip = document.createElement('div');
                            chip.className = 'pkg-chip';
                            chip.innerHTML = `üì¶ ${pc.packages.title} <span class="pkg-chip-remove" onclick="unlinkPackageFromClass(${pc.id}, this)">√ó</span>`;
                            pkgContainer.appendChild(chip);
                        }
                    });
                } else {
                    pkgContainer.innerHTML = '<small style="color:var(--text-muted); font-size:10px;">Brak pakiet√≥w</small>';
                }

                wrapper.appendChild(header);
                wrapper.appendChild(pkgContainer);
                container.appendChild(wrapper);
            });
        }

        async function unlinkPackageFromClass(linkId, element) {
            if(!confirm("OdpiƒÖƒá ten pakiet?")) return;
            const { error } = await _supabase.from('package_classes').delete().eq('id', linkId);
            if(error) alert("B≈ÇƒÖd: " + error.message); else element.parentElement.remove();
        }

        // --- ASSIGN COURSE (FIXED) ---
        async function openAssignCourseModal() {
            openModal('assignCourseModal');
            const { data } = await _supabase.from('schools').select('id, name');
            const sSelect = document.getElementById('assign-school-select');
            sSelect.innerHTML = '<option value="" disabled selected>-- Wybierz Szko≈Çƒô --</option>';
            data.forEach(s => sSelect.add(new Option(s.name, s.id)));
            
            const { data: pkgs } = await _supabase.from('packages').select('id, title');
            const pSelect = document.getElementById('assign-package-select');
            pSelect.innerHTML = '<option value="" disabled selected>-- Wybierz Pakiet --</option>';
            pkgs.forEach(p => pSelect.add(new Option(p.title, p.id)));
        }

        async function assignCourseToClass(e) {
            e.preventDefault();
            const pid = document.getElementById('assign-package-select').value;
            const cid = document.getElementById('assign-class-select').value;
            if(!cid) return alert("Wybierz klasƒô!");
            const {error} = await _supabase.from('package_classes').insert({package_id:pid, class_id:cid});
            if(error) alert("B≈ÇƒÖd: "+error.message); else { alert("Przypisano!"); closeModal('assignCourseModal'); }
        }

    </script>
</body>
</html>
