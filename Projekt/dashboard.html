<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Pulpit</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="layout-wrapper">
        <!-- LEFT SIDEBAR -->
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="#" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Pulpit</span></a></li>
                </ul>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <h1 id="welcome-message">Witaj!</h1>
                    <p>Wybierz moduł, aby kontynuować.</p>
                </div>
            </div>

            <!-- STATIC DASHBOARD GRID -->
            <div class="dashboard-grid">
                
                <!-- 0. ADMIN TILE - CREATE COURSE (Visible only to Admin) -->
                <a href="create_course.html" id="admin-create-course-widget" class="widget-tile" style="display: none; border: 2px dashed var(--accent-color);">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23f04a4a%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><rect x=%223%22 y=%223%22 width=%2218%22 height=%2218%22 rx=%222%22 ry=%222%22></rect><line x1=%2212%22 y1=%228%22 x2=%2212%22 y2=%2216%22></line><line x1=%228%22 y1=%2212%22 x2=%2216%22 y2=%2212%22></line></svg>');"></div>
                    <h3 style="color: var(--accent-color);">Utwórz Kurs</h3>
                    <p class="course-meta">Panel Administratora</p>
                </a>
                
                <!-- 0b. ADMIN TILE - ADD USER (From previous step) -->
                <div id="admin-widget" class="widget-tile" style="display: none; border: 2px dashed #888; cursor: pointer;">
                    <div class="widget-icon" style="background-image: url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23888%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><path d=%22M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2%22></path><circle cx=%228.5%22 cy=%227%22 r=%224%22></circle><line x1=%2220%22 y1=%228%22 x2=%2220%22 y2=%2214%22></line><line x1=%2223%22 y1=%2211%22 x2=%2217%22 y2=%2211%22></line></svg>');"></div>
                    <h3 style="color: #888;">Dodaj Użytkownika</h3>
                    <p class="course-meta">Panel Administratora</p>
                </div>

                <!-- 1. LINK TO COURSES LIST -->
                <a href="courses_list.html" class="widget-tile">
                    <div class="widget-icon icon-course-active"></div>
                    <h3>Moje Kursy</h3>
                    <p class="course-meta">Przejdź do listy zajęć</p>
                </a>

                <!-- 2. OTHER TOOLS -->
                <a href="#" class="widget-tile" onclick="alert('Moduł ćwiczeń w budowie!')">
                    <div class="widget-icon icon-notes"></div>
                    <h3>Ćwiczenia</h3>
                    <p class="course-meta">Testy i Quizy</p>
                </a>

                <a href="#" class="widget-tile">
                    <div class="widget-icon icon-calendar"></div>
                    <h3>Kalendarz</h3>
                </a>

                <a href="#" class="widget-tile">
                    <div class="widget-icon icon-grades"></div>
                    <h3>Oceny</h3>
                </a>
            </div>
        </main>

        <!-- RIGHT SIDEBAR -->
        <aside class="sidebar-right">
            <div class="profile-card">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje"></div>
                <div class="dropdown-menu" id="profileDropdown">
                    <div class="dropdown-item" id="logoutBtn">
                        <div class="icon-logout"></div>
                        Wyloguj się
                    </div>
                </div>
                <h2 class="profile-name" id="profile-name-display">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
            </div>
        </aside>
    </div>

    <!-- CREATE USER MODAL (Previous Code) -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj nowego użytkownika</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <form id="createUserForm" class="modal-form">
                <label>Nazwa</label>
                <input type="text" id="new-username" class="edit-input" required style="border:1px solid #ccc;">
                <label>Email</label>
                <input type="email" id="new-email" class="edit-input" required style="border:1px solid #ccc;">
                <label>Hasło</label>
                <input type="password" id="new-password" class="edit-input" required style="border:1px solid #ccc;">
                <label>Rola</label>
                <select id="new-role" style="width:100%; padding:10px; border-radius:50px; border:1px solid #ccc; margin-bottom:15px;">
                    <option value="student">Student</option>
                    <option value="teacher">Nauczyciel</option>
                    <option value="admin">Administrator</option>
                </select>
                <button type="submit" class="login-button full-width-btn" id="createBtn">Utwórz konto</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth Check
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const userId = session.user.id;
            
            // 2. Fetch Profile
            const { data: profile } = await _supabase
                .from('users')
                .select('username, role')
                .eq('id', userId)
                .single();

            if (profile) {
                document.getElementById('profile-name-display').textContent = profile.username;
                document.getElementById('profile-role-display').textContent = profile.role.toUpperCase();
                document.getElementById('welcome-message').textContent = `Witaj, ${profile.username}!`;

                // 3. CHECK ROLE - Show Admin Buttons
                if (profile.role === 'admin') {
                    // Show Create Course Button
                    document.getElementById('admin-create-course-widget').style.display = 'flex';
                    
                    // Show Add User Button (From previous task)
                    const adminUserWidget = document.getElementById('admin-widget');
                    adminUserWidget.style.display = 'flex';
                    adminUserWidget.addEventListener('click', openModal);
                }
            }

            // Dropdown & Logout
            const avatarTrigger = document.getElementById('avatarTrigger');
            const dropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            avatarTrigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
            window.addEventListener('click', () => { if (dropdown.classList.contains('show')) dropdown.classList.remove('show'); });
            logoutBtn.addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.href = 'login.html'; });

            // Create User Logic
            document.getElementById('createUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createNewUser();
            });
        });

        // Modal Logic
        function openModal() { document.getElementById('createUserModal').classList.add('active'); }
        function closeModal() { document.getElementById('createUserModal').classList.remove('active'); }

        async function createNewUser() {
            // ... (Your existing create user logic here) ...
             const btn = document.getElementById('createBtn');
            const originalText = btn.textContent;
            btn.textContent = "Tworzenie...";
            btn.disabled = true;

            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const username = document.getElementById('new-username').value;
            const role = document.getElementById('new-role').value;

            try {
                const tempSupabase = supabase.createClient(supabaseUrl, supabaseKey, {
                    auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                });

                const { data: authData, error: authError } = await tempSupabase.auth.signUp({
                    email: email, password: password,
                    options: { data: { username: username, role: role } }
                });

                if (authError) throw authError;
                alert(`✅ Sukces! Utworzono użytkownika: ${username}`);
                closeModal();
                document.getElementById('createUserForm').reset();
            } catch (err) { alert("Błąd: " + err.message); } 
            finally { btn.textContent = originalText; btn.disabled = false; }
        }
    </script>
</body>
</html>
