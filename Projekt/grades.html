<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>mUczelnia - Moje Oceny</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .subject-group { margin-bottom: 15px; background: var(--panel-bg); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border-color); }
        .subject-header { padding: 15px 20px; background: var(--hover-bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 16px; }
        .subject-header:hover { background: rgba(0,0,0,0.05); }
        .grades-list { display: none; padding: 15px; }
        .grades-list.active { display: block; animation: fadeIn 0.3s; }
        
        .grade-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .grade-item:last-child { border-bottom: none; }
        
        .grade-value { font-size: 18px; font-weight: bold; color: var(--accent-color); width: 50px; text-align: center; }
        .grade-details { flex: 1; margin-left: 15px; }
        .grade-cat { font-size: 14px; font-weight: bold; color: var(--text-main); }
        .grade-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .grade-date { font-size: 12px; color: var(--text-muted); width: 80px; text-align: right; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- STYL DLA RODZICA (DODANY) --- */
        .parent-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.02);
            border-radius: 12px;
            display: none; /* Domyślnie ukryte */
            border: 1px solid var(--border-color);
        }
        .child-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            min-width: 250px;
            background: var(--panel-bg);
            color: var(--text-main);
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="grades.html" class="nav-link active"><span>Oceny</span></a></li>
                    <li class="nav-item"><a href="schedule.html" class="nav-link"><span>Plan Zajęć</span></a></li>
                    <li class="nav-item"><a href="student_behavior.html" class="nav-link"><span>Zachowanie</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <h1>Oceny</h1>
                    <p>Wykaz ocen z podziałem na przedmioty.</p>
                </div>
            </div>

            <div id="parent-controls" class="parent-controls">
                <label for="childSelect" style="margin-right: 10px; font-weight: 600;">Wybierz dziecko:</label>
                <select id="childSelect" class="child-select" onchange="changeChild()">
                    <option value="" disabled selected>Ładowanie listy...</option>
                </select>
            </div>

            <div id="grades-container">
                </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        // --- GŁÓWNA FUNKCJA ---
        async function init() {
            // 1. Sprawdź sesję
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            // 2. Pobierz rolę użytkownika
            const { data: userDetails } = await _supabase
                .from('users')
                .select('id, role, username')
                .eq('id', session.user.id)
                .single();

            currentUser = userDetails;

            // 3. Rozdzielenie widoku (Rodzic / Uczeń)
            if (currentUser.role === 'parent') {
                setupParentView();
            } else {
                // Uczeń widzi swoje oceny
                fetchAndRenderGrades(currentUser.id);
            }
        }

        // --- WIDOK RODZICA ---
        async function setupParentView() {
            // Pokaż panel wyboru
            document.getElementById('parent-controls').style.display = 'block';

            // Pobierz dzieci
            const { data: relations } = await _supabase.from('parent_children').select('child_id').eq('parent_id', currentUser.id);
            
            if (!relations || relations.length === 0) {
                document.getElementById('grades-container').innerHTML = '<p style="text-align:center">Brak przypisanych dzieci.</p>';
                return;
            }

            const childIds = relations.map(r => r.child_id);
            const { data: children } = await _supabase.from('users').select('id, username').in('id', childIds);

            const select = document.getElementById('childSelect');
            select.innerHTML = '';

            children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = child.username;
                select.appendChild(option);
            });

            // Wybierz pierwsze dziecko domyślnie
            if (children.length > 0) {
                select.value = children[0].id;
                fetchAndRenderGrades(children[0].id);
            }
        }

        function changeChild() {
            const childId = document.getElementById('childSelect').value;
            fetchAndRenderGrades(childId);
        }

        // --- POBIERANIE I WYŚWIETLANIE OCEN (WSPÓLNE) ---
        async function fetchAndRenderGrades(targetUserId) {
            const container = document.getElementById('grades-container');
            container.innerHTML = '<p style="text-align:center; margin-top:20px;">Pobieranie ocen...</p>';

            // ZAPYTANIE Z JOINEM DO PACKAGES
            // packages(title) weźmie tytuł przedmiotu skojarzony z package_id
            const { data: grades, error } = await _supabase
                .from('grades')
                .select('*, packages(title)')
                .eq('user_id', targetUserId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                container.innerHTML = `<p style="text-align:center; color:red">Błąd: ${error.message}</p>`;
                return;
            }

            if (!grades || grades.length === 0) {
                container.innerHTML = '<p style="text-align:center">Brak ocen.</p>';
                return;
            }

            // Grupowanie ocen po przedmiotach
            const subjects = {};

            grades.forEach(g => {
                // Jeśli packages istnieje (join zadziałał), bierzemy title. Jeśli nie - "Inne".
                // Dzięki polityce SQL w kroku 1, to powinno teraz działać poprawnie.
                let title = 'Inne';
                if (g.packages && g.packages.title) {
                    title = g.packages.title;
                }

                if (!subjects[title]) {
                    subjects[title] = [];
                }
                subjects[title].push(g);
            });

            // Renderowanie HTML (Twój oryginalny kod)
            container.innerHTML = '';
            
            Object.keys(subjects).sort().forEach(title => {
                const list = subjects[title];
                
                // Liczenie średniej
                let sum = 0; 
                let count = 0;
                list.forEach(g => {
                    const val = parseFloat(g.grade);
                    if (!isNaN(val)) { sum += val; count++; }
                });
                const avg = count > 0 ? (sum / count).toFixed(2) : "-";

                const section = document.createElement('div');
                section.className = 'subject-group';
                section.innerHTML = `
                    <div class="subject-header" onclick="this.nextElementSibling.classList.toggle('active')">
                        <span>${title}</span>
                        <span style="font-weight:normal; font-size:14px; color:var(--text-muted);">Średnia: <b>${avg}</b> ▼</span>
                    </div>
                    <div class="grades-list">
                        ${list.map(g => `
                            <div class="grade-item">
                                <div class="grade-value">${g.grade}</div>
                                <div class="grade-details">
                                    <div class="grade-cat">${g.category || 'Ocena'} <span style="font-weight:normal; font-size:12px; color:#888;">(Waga: ${g.weight})</span></div>
                                    <div class="grade-desc">${g.description || ''}</div>
                                </div>
                                <div class="grade-date">${new Date(g.created_at).toLocaleDateString()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
