<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>mUczelnia - Moje Oceny</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .subject-group { margin-bottom: 15px; background: var(--panel-bg); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border-color); }
        .subject-header { padding: 15px 20px; background: var(--hover-bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 16px; }
        .subject-header:hover { background: rgba(0,0,0,0.05); }
        .grades-list { display: none; padding: 15px; }
        .grades-list.active { display: block; animation: fadeIn 0.3s; }
        
        .grade-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .grade-item:last-child { border-bottom: none; }
        
        .grade-value { font-size: 18px; font-weight: bold; color: var(--accent-color); width: 50px; text-align: center; }
        .grade-details { flex: 1; margin-left: 10px; }
        .grade-cat { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: bold; }
        .grade-desc { font-size: 14px; color: var(--text-main); }
        .grade-date { font-size: 12px; color: var(--text-muted); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Oceny</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted);">← Wróć</a>
                    <h1>Moje Oceny</h1>
                </div>
            </div>
            <div id="grades-container">Ładowanie...</div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const container = document.getElementById('grades-container');
            
            // 1. Pobierz oceny z informacją o pakiecie (przedmiocie)
            const { data: grades } = await _supabase
                .from('grades')
                .select('id, grade, weight, category, description, created_at, package_id, packages(title)')
                .eq('user_id', session.user.id)
                .order('created_at', { ascending: false });

            if (!grades || grades.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:40px; color:var(--text-muted);">Brak ocen.</p>';
                return;
            }

            // 2. Grupuj oceny po Przedmiotach (Pakietach)
            const subjects = {};
            grades.forEach(g => {
                // Jeśli ocena nie ma pakietu, wrzuć do "Inne"
                const pkgTitle = g.packages ? g.packages.title : "Inne / Ogólne";
                if (!subjects[pkgTitle]) subjects[pkgTitle] = [];
                subjects[pkgTitle].push(g);
            });

            container.innerHTML = '';
            
            // 3. Renderuj
            for (const [title, list] of Object.entries(subjects)) {
                // Oblicz średnią (uproszczona)
                let sum = 0; let count = 0;
                list.forEach(g => {
                    const val = parseFloat(g.grade);
                    if (!isNaN(val)) { sum += val; count++; }
                });
                const avg = count > 0 ? (sum / count).toFixed(2) : "-";

                const section = document.createElement('div');
                section.className = 'subject-group';
                section.innerHTML = `
                    <div class="subject-header" onclick="this.nextElementSibling.classList.toggle('active')">
                        <span>${title}</span>
                        <span style="font-weight:normal; font-size:14px; color:var(--text-muted);">Średnia: <b>${avg}</b> ▼</span>
                    </div>
                    <div class="grades-list">
                        ${list.map(g => `
                            <div class="grade-item">
                                <div class="grade-value">${g.grade}</div>
                                <div class="grade-details">
                                    <div class="grade-cat">${g.category || 'Ocena'} (Waga: ${g.weight})</div>
                                    <div class="grade-desc">${g.description || ''}</div>
                                </div>
                                <div class="grade-date">${new Date(g.created_at).toLocaleDateString()}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            }
        });
    </script>
</body>
</html>
