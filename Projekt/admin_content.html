<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Baza Tre≈õci</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .search-bar-container { margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-input { flex-grow: 1; padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border-color); font-size: 16px; outline: none; background: var(--panel-bg); color: var(--text-main); }
        .filter-btn { padding: 0 25px; border-radius: 50px; border: 1px solid var(--border-color); background: var(--panel-bg); cursor: pointer; color: var(--text-muted); font-weight: bold; transition: 0.2s; }
        .filter-btn:hover { background: var(--hover-bg); }
        .filter-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        
        .action-icon-btn {
            position: absolute; top: 10px; width: 30px; height: 30px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; 
            cursor: pointer; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .action-icon-btn:hover { transform: scale(1.1); }
        .edit-icon { right: 45px; color: #333; }
        .delete-icon { right: 10px; color: #F44336; }

        /* Style dla managera pakiet√≥w */
        .pkg-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--bg-color); padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color);
        }
        .linked-course-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; font-size: 13px;
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Baza Tre≈õci</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">‚Üê Wr√≥ƒá do pulpitu</a>
                    <h1>ZarzƒÖdzanie Tre≈õciƒÖ</h1>
                    <p>Edytuj kursy, quizy i pakiety.</p>
                </div>
            </div>

            <div class="search-bar-container">
                <input type="text" class="search-input" id="search-input" placeholder="Szukaj kursu lub quizu..." oninput="filterContent()">
                <button class="filter-btn active" onclick="filterType('all')" id="btn-all">Wszystko</button>
                <button class="filter-btn" onclick="filterType('course')" id="btn-course">Kursy</button>
                <button class="filter-btn" onclick="filterType('quiz')" id="btn-quiz">Quizy</button>
                <button class="login-button" style="width: auto; margin:0;" onclick="openPackageManager()">üì¶ Pakiety</button>
            </div>

            <div class="dashboard-grid" id="content-grid">
                </div>
        </main>
    </div>

    <div class="modal-overlay" id="packagesListModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">ZarzƒÖdzaj Pakietami</h3>
                <span class="close-modal" onclick="closeModal('packagesListModal')">&times;</span>
            </div>
            <div id="packages-list-container" style="max-height: 400px; overflow-y: auto;">≈Åadowanie...</div>
            <button class="login-button full-width-btn" onclick="openEditPackage(null)" style="margin-top:15px;">+ Stw√≥rz Nowy Pakiet</button>
        </div>
    </div>

    <div class="modal-overlay" id="editPackageModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title" id="pkg-modal-title">Edycja Pakietu</h3>
                <span class="close-modal" onclick="closeModal('editPackageModal')">&times;</span>
            </div>
            <form id="pkgForm">
                <input type="hidden" id="edit-pkg-id">
                
                <label>Nazwa Pakietu</label>
                <input type="text" id="edit-pkg-title" class="edit-input" required>
                
                <label>Opis Pakietu</label>
                <textarea id="edit-pkg-desc" class="edit-input" style="min-height: 80px;" placeholder="Kr√≥tki opis..."></textarea>
                
                <label>Poziom</label>
                <select id="edit-pkg-level" class="edit-input">
                    <option value="1">Podstawowy</option>
                    <option value="2">≈öredni</option>
                    <option value="3">Wy≈ºszy</option>
                </select>

                <div id="linked-courses-section" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                    <label style="margin-bottom: 5px;">Podpiƒôte elementy:</label>
                    <div id="linked-courses-list" style="background: #f9f9f9; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto;">
                        </div>
                </div>

                <button type="submit" class="login-button full-width-btn" style="margin-top: 15px;">Zapisz Zmiany</button>
                <button type="button" class="login-button full-width-btn" style="background: #f44336; margin-top: 10px;" id="btn-delete-pkg" onclick="deletePackage()">Usu≈Ñ Pakiet</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let allContent = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            fetchContent();

            document.getElementById('pkgForm').addEventListener('submit', savePackage);
        });

        // --- 1. WY≈öWIETLANIE TRE≈öCI ---
        async function fetchContent() {
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '<p style="padding:20px;">≈Åadowanie...</p>';

            const { data: courses } = await _supabase
                .from('courses')
                .select(`id, title, type, created_at, packages(title)`)
                .order('created_at', { ascending: false });

            allContent = courses || [];
            filterContent();
        }

        function filterType(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
            filterContent();
        }

        function filterContent() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '';

            const filtered = allContent.filter(c => {
                const matchesType = currentFilter === 'all' || c.type === currentFilter;
                const matchesSearch = c.title.toLowerCase().includes(search);
                return matchesType && matchesSearch;
            });

            if (filtered.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#888;">Brak wynik√≥w.</div>'; return; }

            filtered.forEach(c => {
                const isQuiz = c.type === 'quiz';
                const editUrl = isQuiz ? `create_quiz.html?id=${c.id}` : `create_course.html?id=${c.id}`;
                const icon = isQuiz ? 'üìù' : 'üìö';
                const color = isQuiz ? '#9C27B0' : '#f04a4a';
                const pkg = c.packages ? `<div style="font-size:11px; margin-bottom:5px; color:#666;">üì¶ ${c.packages.title}</div>` : '<div style="font-size:11px; margin-bottom:5px; color:#ccc;">Brak pakietu</div>';

                const tile = document.createElement('div');
                tile.className = 'widget-tile';
                tile.style.position = 'relative'; // Dla pozycjonowania ikon
                
                tile.innerHTML = `
                    <div class="action-icon-btn edit-icon" onclick="window.location.href='${editUrl}'" title="Edytuj">‚úèÔ∏è</div>
                    <div class="action-icon-btn delete-icon" onclick="deleteContent(${c.id}, '${c.type}')" title="Usu≈Ñ">üóëÔ∏è</div>
                    
                    <div style="font-size:40px; margin-bottom:10px;">${icon}</div>
                    ${pkg}
                    <h3 style="color:${color}">${c.title}</h3>
                `;
                grid.appendChild(tile);
            });
        }

        // --- 2. USUWANIE TRE≈öCI (KURS/QUIZ) ---
        async function deleteContent(id, type) {
            if(!confirm(`Czy na pewno chcesz usunƒÖƒá ten ${type === 'quiz' ? 'quiz' : 'kurs'}?\nOperacja jest nieodwracalna!`)) return;

            // Supabase Cascade powinno usunƒÖƒá lekcje/pytania, ale dla pewno≈õci usuwamy g≈Ç√≥wny rekord
            const { error } = await _supabase.from('courses').delete().eq('id', id);
            
            if (error) alert("B≈ÇƒÖd: " + error.message);
            else {
                alert("Usuniƒôto pomy≈õlnie.");
                fetchContent(); // Od≈õwie≈º listƒô
            }
        }

        // --- 3. ZARZƒÑDZANIE PAKIETAMI ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function openPackageManager() {
            openModal('packagesListModal');
            const container = document.getElementById('packages-list-container');
            container.innerHTML = '≈Åadowanie...';

            const { data: pkgs } = await _supabase.from('packages').select('*').order('title');
            container.innerHTML = '';

            if (!pkgs || pkgs.length === 0) {
                container.innerHTML = '<p>Brak pakiet√≥w.</p>';
                return;
            }

            pkgs.forEach(p => {
                const div = document.createElement('div');
                div.className = 'pkg-item';
                div.innerHTML = `
                    <span><b>${p.title}</b> <small>(${p.level === 1 ? 'Podst.' : (p.level===2 ? '≈ör.' : 'Wy≈º.')})</small></span>
                    <button class="login-button" style="width:auto; height:30px; font-size:12px; margin:0;" onclick="openEditPackage(${p.id})">Edytuj</button>
                `;
                container.appendChild(div);
            });
        }

        async function openEditPackage(id) {
            closeModal('packagesListModal');
            openModal('editPackageModal');
            
            const titleInput = document.getElementById('edit-pkg-title');
            const descInput = document.getElementById('edit-pkg-desc');
            const levelInput = document.getElementById('edit-pkg-level');
            const idInput = document.getElementById('edit-pkg-id');
            const deleteBtn = document.getElementById('btn-delete-pkg');
            const linkedDiv = document.getElementById('linked-courses-section');
            const linkedList = document.getElementById('linked-courses-list');

            if (id) {
                // TRYB EDYCJI
                document.getElementById('pkg-modal-title').innerText = "Edycja Pakietu";
                deleteBtn.style.display = 'block';
                linkedDiv.style.display = 'block';
                idInput.value = id;

                // Pobierz dane
                const { data: pkg } = await _supabase.from('packages').select('*').eq('id', id).single();
                titleInput.value = pkg.title;
                descInput.value = pkg.description || "";
                levelInput.value = pkg.level;

                // Pobierz podpiƒôte elementy
                const { data: courses } = await _supabase.from('courses').select('id, title, type').eq('package_id', id);
                linkedList.innerHTML = '';
                if(courses && courses.length > 0) {
                    courses.forEach(c => {
                        const row = document.createElement('div');
                        row.className = 'linked-course-item';
                        row.innerHTML = `
                            <span>${c.type === 'quiz' ? 'üìù' : 'üìö'} ${c.title}</span>
                            <span style="color:red; cursor:pointer; font-weight:bold;" onclick="unlinkCourse(${c.id}, this)" title="Odepnij">√ó</span>
                        `;
                        linkedList.appendChild(row);
                    });
                } else {
                    linkedList.innerHTML = '<small style="color:#888;">Brak element√≥w w pakiecie.</small>';
                }

            } else {
                // TRYB TWORZENIA
                document.getElementById('pkg-modal-title').innerText = "Nowy Pakiet";
                deleteBtn.style.display = 'none';
                linkedDiv.style.display = 'none';
                idInput.value = "";
                titleInput.value = "";
                descInput.value = "";
                levelInput.value = "1";
            }
        }

        async function savePackage(e) {
            e.preventDefault();
            const id = document.getElementById('edit-pkg-id').value;
            const title = document.getElementById('edit-pkg-title').value;
            const desc = document.getElementById('edit-pkg-desc').value;
            const level = document.getElementById('edit-pkg-level').value;

            let error;
            if (id) {
                // Update
                const { err } = await _supabase.from('packages').update({ title, description: desc, level }).eq('id', id);
                error = err;
            } else {
                // Insert
                const { err } = await _supabase.from('packages').insert({ title, description: desc, level });
                error = err;
            }

            if (error) alert("B≈ÇƒÖd: " + error.message);
            else {
                alert("Zapisano!");
                closeModal('editPackageModal');
                fetchContent(); // Od≈õwie≈º g≈Ç√≥wny widok (bo mog≈Çy zmieniƒá siƒô nazwy pakiet√≥w na kafelkach)
            }
        }

        async function deletePackage() {
            const id = document.getElementById('edit-pkg-id').value;
            if(!confirm("UsunƒÖƒá ten pakiet? Kursy wewnƒÖtrz NIE zostanƒÖ usuniƒôte, ale zostanƒÖ odpiƒôte.")) return;

            const { error } = await _supabase.from('packages').delete().eq('id', id);
            if(error) alert("B≈ÇƒÖd: " + error.message);
            else {
                alert("Pakiet usuniƒôty.");
                closeModal('editPackageModal');
                fetchContent();
            }
        }

        async function unlinkCourse(courseId, el) {
            if(!confirm("OdpiƒÖƒá ten element od pakietu?")) return;
            // Ustaw package_id na null
            const { error } = await _supabase.from('courses').update({ package_id: null }).eq('id', courseId);
            if(error) alert("B≈ÇƒÖd: " + error.message);
            else el.parentElement.remove();
        }

    </script>
</body>
</html>
