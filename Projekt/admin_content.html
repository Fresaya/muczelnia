<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Baza Tre≈õci</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Lokalne style dla wyszukiwarki, je≈õli nie ma ich w style.css */
        .search-bar-container { margin-bottom: 30px; display: flex; gap: 10px; }
        .search-input { flex-grow: 1; padding: 12px 20px; border-radius: 50px; border: 1px solid #e0e0e0; font-size: 16px; outline: none; }
        .filter-btn { padding: 0 25px; border-radius: 50px; border: 1px solid #e0e0e0; background: #fff; cursor: pointer; color: #888; }
        .filter-btn.active { background: #f04a4a; color: white; border-color: #f04a4a; }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Baza Tre≈õci</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:#888; font-size:14px;">‚Üê Wr√≥ƒá do pulpitu</a>
                    <h1>Baza Tre≈õci</h1>
                    <p>ZarzƒÖdzaj wszystkimi kursami i quizami w jednym miejscu.</p>
                </div>
            </div>

            <!-- SZUKAJ I FILTRUJ -->
            <div class="search-bar-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Szukaj po tytule...">
                <button class="filter-btn active" onclick="setFilter('all')">Wszystko</button>
                <button class="filter-btn" onclick="setFilter('course')">Kursy</button>
                <button class="filter-btn" onclick="setFilter('quiz')">Quizy</button>
            </div>

            <!-- GRID WYNIK√ìW -->
            <div class="dashboard-grid" id="content-grid">
                <div style="grid-column: 1/-1; text-align:center; color:#888;">≈Åadowanie bazy danych...</div>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card">
                <div class="avatar"></div>
                <h2 class="profile-name" id="profile-name-display">...</h2>
                <p class="profile-id">ADMINISTRATOR</p>
            </div>
        </aside>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let allContent = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            // Sprawd≈∫ uprawnienia
            const { data: profile } = await _supabase.from('users').select('username, role').eq('id', session.user.id).single();
            if (profile.role !== 'admin') { alert("Brak dostƒôpu"); window.location.href = 'dashboard.html'; return; }
            document.getElementById('profile-name-display').textContent = profile.username;

            // Pobierz dane
            const { data: courses } = await _supabase.from('courses').select('id, title, type, packages(title)').order('created_at', { ascending: false });
            allContent = courses || [];
            renderContent(allContent);

            // Szukanie
            document.getElementById('searchInput').addEventListener('input', (e) => filterContent(e.target.value));
        });

        window.setFilter = function(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            filterContent(document.getElementById('searchInput').value);
        }

        function filterContent(term) {
            const lower = term.toLowerCase();
            const filtered = allContent.filter(item => {
                if (currentFilter !== 'all' && item.type !== currentFilter) return false;
                const titleMatch = item.title.toLowerCase().includes(lower);
                const pkgMatch = item.packages?.title.toLowerCase().includes(lower);
                return titleMatch || pkgMatch;
            });
            renderContent(filtered);
        }

        function renderContent(items) {
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '';
            if (items.length === 0) { grid.innerHTML = '<div style="color:#888; text-align:center; grid-column:1/-1;">Brak wynik√≥w.</div>'; return; }

            items.forEach(c => {
                const isQuiz = c.type === 'quiz';
                const editUrl = isQuiz ? `create_quiz.html?id=${c.id}` : `create_course.html?id=${c.id}`;
                const icon = isQuiz ? 'üìù' : 'üìö';
                const color = isQuiz ? '#9C27B0' : '#f04a4a';
                const pkg = c.packages ? `<div style="font-size:11px; margin-bottom:5px; color:#666;">üì¶ ${c.packages.title}</div>` : '';

                const tile = document.createElement('div');
                tile.className = 'widget-tile';
                tile.style.cursor = 'pointer';
                tile.onclick = () => window.location.href = `course.html?id=${c.id}`;
                
                tile.innerHTML = `
                    <div onclick="window.location.href='${editUrl}'; event.stopPropagation();" 
                         style="position:absolute; top:10px; right:10px; background:#eee; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px;" title="Edytuj">‚úèÔ∏è</div>
                    <div style="font-size:40px; margin-bottom:10px;">${icon}</div>
                    ${pkg}
                    <h3 style="color:${color}">${c.title}</h3>
                    <div class="course-meta" style="margin-top:10px;">${isQuiz ? 'QUIZ' : 'KURS'}</div>
                `;
                grid.appendChild(tile);
            });
        }
    </script>
</body>
</html>
