<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Baza Tre≈õci</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* --- STYLE DEDYKOWANE DLA TEJ STRONY --- */
        .content-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; font-size: 16px; font-weight: 600; color: var(--text-muted); cursor: pointer; padding: 10px 20px; border-radius: 8px; transition: 0.2s; }
        .tab-btn:hover { background: var(--hover-bg); color: var(--text-main); }
        .tab-btn.active { background: rgba(33, 150, 243, 0.1); color: #2196F3; }

        /* GRID PAKIET√ìW */
        .packages-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .package-card { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        .pkg-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .pkg-title { font-weight: bold; font-size: 18px; margin: 0; }
        .pkg-desc { font-size: 13px; color: var(--text-muted); margin: 5px 0 0 0; }
        .pkg-content-list { list-style: none; padding: 0; margin: 0; flex: 1; }
        .pkg-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed var(--border-color); font-size: 14px; }
        .pkg-item:last-child { border-bottom: none; }
        
        /* Akcje wewnƒÖtrz pakietu */
        .pkg-actions { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }
        .mini-btn { font-size: 12px; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); background: var(--bg-color); }
        .btn-add-loose { color: #4CAF50; border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); }

        /* LISTA LU≈πNYCH ELEMENT√ìW */
        .loose-list { display: flex; flex-direction: column; gap: 10px; }
        .loose-item { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .loose-info h4 { margin: 0; font-size: 16px; }
        .loose-info p { margin: 5px 0 0 0; font-size: 12px; color: var(--text-muted); }
        .type-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-left: 10px; }
        .badge-course { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .badge-quiz { background: rgba(156, 39, 176, 0.1); color: #9C27B0; }

        /* --- STYL WYSZUKIWARKI ---  */
        .search-bar-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .search-icon-input {
            position: relative;
            width: 100%;
            max-width: 400px;
        }
        
        .search-icon-input input {
            width: 100%;
            padding: 10px 10px 10px 35px; /* Miejsce na ikonƒô */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 14px;
        }
        
        .search-icon-input::before {
            content: 'üîç';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Baza Tre≈õci</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
<div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">‚Üê Wr√≥ƒá do pulpitu</a>
                    <h1>Baza Tre≈õci</h1>
                    <p>ZarzƒÖdzaj pakietami, kursami i quizami.</p>
                </div>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button class="login-button" style="width:auto; background:#2196F3;" onclick="openCreatePackageModal()">+ Nowy Pakiet</button>
                    
                    <button class="login-button" style="width:auto; background:var(--accent-color);" onclick="window.location.href='create_course.html'">+ Nowy Kurs</button>
                    <button class="login-button" style="width:auto; background:#9C27B0;" onclick="window.location.href='create_quiz.html'">+ Nowy Quiz</button>
                </div>
    <div class="modal-overlay" id="createPackageModal">
        <div class="modal-window">
            <h3>Utw√≥rz Nowy Pakiet</h3>
            
            <label style="font-size:12px; font-weight:bold; color:#555;">Nazwa Pakietu</label>
            <input type="text" id="new-standalone-pkg-title" class="edit-input" placeholder="np. Fizyka - Dzia≈Ç 1">
            
            <label style="font-size:12px; font-weight:bold; color:#555;">Opis (Opcjonalnie)</label>
            <textarea id="new-standalone-pkg-desc" class="edit-input" placeholder="Kr√≥tki opis zawarto≈õci..."></textarea>
            
            <label style="font-size:12px; font-weight:bold; color:#555;">Poziom Nauczania</label>
            <select id="new-standalone-pkg-level" class="edit-input">
                <option value="1">Szko≈Ça Podstawowa</option>
                <option value="2">Szko≈Ça ≈örednia</option>
                <option value="3">Szko≈Ça Wy≈ºsza</option>
            </select>

            <div style="text-align:right; margin-top:15px;">
                <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('createPackageModal')">Anuluj</button>
                <button class="login-button" style="width:auto;" onclick="createStandalonePackage()">Utw√≥rz</button>
            </div>
        </div>
    </div>
            </div>
            <div class="search-bar-container">
                <div class="search-icon-input">
                    <input type="text" id="global-search" placeholder="Szukaj pakietu, kursu lub quizu..." oninput="filterContent()">
                </div>
            </div>

            <div class="content-tabs">
                <button class="tab-btn active" onclick="switchTab('packages')">üì¶ Pakiety</button>
                <button class="tab-btn" onclick="switchTab('loose')">üìÑ Lu≈∫ne Elementy (<span id="loose-count">0</span>)</button>
            </div>

            <div id="view-packages" class="view-section">
                <div id="packages-container" class="packages-grid">
                    <p>≈Åadowanie pakiet√≥w...</p>
                </div>
            </div>

            <div id="view-loose" class="view-section" style="display:none;">
                <div id="loose-container" class="loose-list">
                    <p>≈Åadowanie element√≥w...</p>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="assignModal">
        <div class="modal-window">
            <h3>Przypisz do Pakietu</h3>
            <p>Wybierz pakiet dla: <b id="assign-item-name">...</b></p>
            <select id="assign-package-select" class="edit-input">
                <option>≈Åadowanie...</option>
            </select>
            <div style="text-align:right; margin-top:15px;">
                <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('assignModal')">Anuluj</button>
                <button class="login-button" style="width:auto;" onclick="confirmAssign()">Zapisz</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="importModal">
        <div class="modal-window">
            <h3>Dodaj element do pakietu</h3>
            <p>Wybierz element, kt√≥ry chcesz przenie≈õƒá do: <b id="import-pkg-name">...</b></p>
            <select id="import-loose-select" class="edit-input">
                <option>≈Åadowanie...</option>
            </select>
            <div style="text-align:right; margin-top:15px;">
                <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('importModal')">Anuluj</button>
                <button class="login-button" style="width:auto;" onclick="confirmImport()">Dodaj</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let packagesData = [];
        let looseData = [];
        
        let selectedItemId = null;   // ID kursu przy przypisywaniu
        let selectedPackageId = null; // ID pakietu przy imporcie

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            
            // Tylko admin, manager, lecturer mo≈ºe tu byƒá
            const { data: user } = await _supabase.from('users').select('role').eq('id', session.user.id).single();
            if(!['admin', 'manager', 'lecturer'].includes(user.role)) {
                alert("Brak uprawnie≈Ñ"); window.location.href='dashboard.html'; return;
            }

            loadContent();
        });

        async function loadContent() {
            // 1. Pobierz Pakiety + ich kursy
            const { data: pkgs } = await _supabase
                .from('packages')
                .select(`*, courses(id, title, type)`)
                .order('created_at', { ascending: false });
            packagesData = pkgs || [];

            // 2. Pobierz Lu≈∫ne (gdzie package_id is null)
            const { data: loose } = await _supabase
                .from('courses')
                .select('*')
                .is('package_id', null)
                .order('created_at', { ascending: false });
            looseData = loose || [];

            // Update licznika w zak≈Çadce
            document.getElementById('loose-count').textContent = looseData.length;

            renderPackages();
            renderLoose();
        }

        function switchTab(tab) {
            document.getElementById('view-packages').style.display = tab === 'packages' ? 'block' : 'none';
            document.getElementById('view-loose').style.display = tab === 'loose' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
// 1. Dodaj tƒô funkcjƒô (wywo≈ÇywanƒÖ przy wpisywaniu)
        function filterContent() {
            // Po prostu przerysowujemy widok - funkcje renderujƒÖce same pobiorƒÖ warto≈õƒá z inputa
            renderPackages();
            renderLoose();
        }

        // 2. Zaktualizowana funkcja renderPackages (z filtrowaniem)
        function renderPackages() {
            const container = document.getElementById('packages-container');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('global-search') ? document.getElementById('global-search').value.toLowerCase() : '';

            const filtered = packagesData.filter(p => {
                const matchTitle = p.title.toLowerCase().includes(searchTerm);
                const matchDesc = p.description && p.description.toLowerCase().includes(searchTerm);
                const matchInner = p.courses && p.courses.some(c => c.title.toLowerCase().includes(searchTerm));
                return matchTitle || matchDesc || matchInner;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p>Nie znaleziono pakiet√≥w.</p>';
                return;
            }

            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'package-card';
                
                let coursesHtml = '<ul class="pkg-content-list">';
                if (p.courses && p.courses.length > 0) {
                    p.courses.forEach(c => {
                        const icon = c.type === 'quiz' ? 'üìù' : 'üìò';
                        const editUrl = c.type === 'quiz' ? 'create_quiz.html' : 'create_course.html';
                        
                        coursesHtml += `
                            <li class="pkg-item">
                                <span style="display:flex; align-items:center; gap:5px; overflow:hidden; text-overflow:ellipsis;">
                                    ${icon} ${c.title}
                                </span>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <button class="mini-btn" style="color:#2196F3; border-color:var(--border-color);" 
                                            onclick="window.location.href='course.html?id=${c.id}'" 
                                            title="Wejd≈∫ / Zobacz jako ucze≈Ñ">
                                        üëÅÔ∏è
                                    </button>

                                    <button class="mini-btn" style="color:var(--accent-color); border-color:var(--border-color);" 
                                            onclick="window.location.href='${editUrl}?id=${c.id}'" 
                                            title="Edytuj zawarto≈õƒá">
                                        ‚úèÔ∏è
                                    </button>
                                    
                                    <button class="mini-btn" style="color:red; border-color:red;" 
                                            onclick="detachCourse('${c.id}')" 
                                            title="Wyrzuƒá do lu≈∫nych">
                                        √ó
                                    </button>
                                </div>
                            </li>`;
                    });
                } else {
                    coursesHtml += '<li class="pkg-item" style="color:#aaa; justify-content:center;">Pusty pakiet</li>';
                }
                coursesHtml += '</ul>';

                card.innerHTML = `
                    <div class="pkg-header">
                        <div>
                            <h3 class="pkg-title">${p.title}</h3>
                            <p class="pkg-desc">${p.description || 'Brak opisu'}</p>
                        </div>
                        <span class="mini-btn" style="color:red; border-color:red;" onclick="deletePackage('${p.id}')">Usu≈Ñ</span>
                    </div>
                    ${coursesHtml}
                    <div class="pkg-actions">
                        <button class="mini-btn btn-add-loose" onclick="openImportModal('${p.id}', '${p.title}')">+ Dodaj z lu≈∫nych</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 3. Zaktualizowana funkcja renderLoose (z filtrowaniem)
        function renderLoose() {
            const container = document.getElementById('loose-container');
            container.innerHTML = '';

            const searchTerm = document.getElementById('global-search') ? document.getElementById('global-search').value.toLowerCase() : '';

            const filtered = looseData.filter(l => {
                const matchTitle = l.title.toLowerCase().includes(searchTerm);
                const matchDesc = l.description && l.description.toLowerCase().includes(searchTerm);
                return matchTitle || matchDesc;
            });

            if (filtered.length === 0) {
                if (looseData.length === 0) {
                    container.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">Brak lu≈∫nych element√≥w.</p>';
                } else {
                    container.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">Brak wynik√≥w wyszukiwania.</p>';
                }
                return;
            }

            filtered.forEach(l => {
                const div = document.createElement('div');
                div.className = 'loose-item';
                const typeLabel = l.type === 'quiz' ? 'QUIZ' : 'KURS';
                const typeClass = l.type === 'quiz' ? 'badge-quiz' : 'badge-course';

                div.innerHTML = `
                    <div class="loose-info">
                        <h4 style="display:flex; align-items:center;">
                            ${l.title} 
                            <span class="type-badge ${typeClass}">${typeLabel}</span>
                        </h4>
                        <p>${l.description || 'Bez opisu'}</p>
                    </div>
                    <div style="display:flex; gap:10px; align-items: center;">
                        <button class="login-button" style="width:auto; padding:5px 15px; font-size:12px; background:#2196F3;" 
                                onclick="window.location.href='course.html?id=${l.id}'" title="Zobacz">üëÅÔ∏è</button>

                        <button class="login-button" style="width:auto; padding:5px 15px; font-size:12px;" 
                                onclick="window.location.href='${l.type === 'quiz' ? 'create_quiz.html' : 'create_course.html'}?id=${l.id}'">Edytuj</button>
                        
                        <button class="login-button" style="width:auto; padding:5px 15px; font-size:12px; background:var(--accent-color);" 
                                onclick="openAssignModal('${l.id}', '${l.title}')">üì¶ Do≈ÇƒÖcz</button>
                        
                        <button class="mini-btn" style="color:white; background:#F44336; border-color:#F44336; height: 30px; font-weight:bold;" 
                                onclick="deleteLooseItem('${l.id}')">Usu≈Ñ</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        // --- DODAJ Tƒò FUNKCJƒò GDZIE≈ö W SKRYPCIE ---
        async function deleteLooseItem(id) {
            if(!confirm("UWAGA: Czy na pewno usunƒÖƒá ten element bezpowrotnie?")) return;
            
            const { error } = await _supabase.from('courses').delete().eq('id', id);
            
            if(error) alert("B≈ÇƒÖd: " + error.message);
            else {
                // Od≈õwie≈º widok
                loadContent();
            }
        }

        // --- SCENARIUSZ 1: Z poziomu lu≈∫nych (Assign to Package) ---
        function openAssignModal(courseId, title) {
            selectedItemId = courseId;
            document.getElementById('assign-item-name').innerText = title;
            const sel = document.getElementById('assign-package-select');
            sel.innerHTML = '<option value="" disabled selected>-- Wybierz pakiet --</option>';
            
            packagesData.forEach(p => {
                sel.add(new Option(p.title, p.id));
            });
            
            document.getElementById('assignModal').classList.add('active');
        }

        async function confirmAssign() {
            const pkgId = document.getElementById('assign-package-select').value;
            if(!pkgId || !selectedItemId) return;

            const { error } = await _supabase.from('courses').update({ package_id: pkgId }).eq('id', selectedItemId);
            if(error) alert(error.message);
            else {
                document.getElementById('assignModal').classList.remove('active');
                loadContent(); // Od≈õwie≈º widok
            }
        }

        // --- SCENARIUSZ 2: Z poziomu pakietu (Import Loose) ---
        function openImportModal(pkgId, pkgTitle) {
            selectedPackageId = pkgId;
            document.getElementById('import-pkg-name').innerText = pkgTitle;
            const sel = document.getElementById('import-loose-select');
            sel.innerHTML = '';

            if (looseData.length === 0) {
                sel.innerHTML = '<option disabled>Brak lu≈∫nych element√≥w do dodania</option>';
            } else {
                sel.innerHTML = '<option value="" disabled selected>-- Wybierz element --</option>';
                looseData.forEach(l => {
                    sel.add(new Option(`[${l.type.toUpperCase()}] ${l.title}`, l.id));
                });
            }

            document.getElementById('importModal').classList.add('active');
        }

        async function confirmImport() {
            const courseId = document.getElementById('import-loose-select').value;
            if(!courseId || !selectedPackageId) return;

            const { error } = await _supabase.from('courses').update({ package_id: selectedPackageId }).eq('id', courseId);
            if(error) alert(error.message);
            else {
                document.getElementById('importModal').classList.remove('active');
                loadContent();
            }
        }

        // --- ODPINANIE (Wyrzucenie do lu≈∫nych) ---
        async function detachCourse(courseId) {
            if(!confirm("Czy na pewno odpiƒÖƒá ten element od pakietu? Trafi on do sekcji 'Lu≈∫ne'.")) return;
            const { error } = await _supabase.from('courses').update({ package_id: null }).eq('id', courseId);
            if(error) alert(error.message);
            else loadContent();
        }

        // --- USUWANIE PAKIETU ---
        async function deletePackage(pkgId) {
            if(!confirm("UsunƒÖƒá pakiet? Kursy wewnƒÖtrz NIE zostanƒÖ usuniƒôte, tylko przeniesione do 'Lu≈∫nych'.")) return;
            
            // Dziƒôki CASCADE/SET NULL w bazie, kursy same siƒô "odepnƒÖ" (set null)
            const { error } = await _supabase.from('packages').delete().eq('id', pkgId);
            if(error) alert(error.message);
            else loadContent();
        }
        // --- TWORZENIE SAMEGO PAKIETU ---

        function openCreatePackageModal() {
            // Wyczy≈õƒá pola przed otwarciem
            document.getElementById('new-standalone-pkg-title').value = '';
            document.getElementById('new-standalone-pkg-desc').value = '';
            document.getElementById('new-standalone-pkg-level').value = '1';
            
            document.getElementById('createPackageModal').classList.add('active');
        }

        async function createStandalonePackage() {
            const title = document.getElementById('new-standalone-pkg-title').value;
            const desc = document.getElementById('new-standalone-pkg-desc').value;
            const level = document.getElementById('new-standalone-pkg-level').value;

            if (!title) return alert("Podaj nazwƒô pakietu!");

            const { error } = await _supabase.from('packages').insert({
                title: title,
                description: desc,
                level: level
            });

            if (error) {
                alert("B≈ÇƒÖd: " + error.message);
            } else {
                alert("Pakiet utworzony!");
                closeModal('createPackageModal');
                loadContent(); // Od≈õwie≈º listƒô, ≈ºeby zobaczyƒá nowy pakiet
                
                // Opcjonalnie: Prze≈ÇƒÖcz na zak≈Çadkƒô pakiet√≥w, je≈õli jeste≈õ na lu≈∫nych
                switchTab('packages');
                const btnPkg = document.querySelector("button[onclick=\"switchTab('packages')\"]");
                if(btnPkg) btnPkg.click();
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    </script>
</body>
</html>
