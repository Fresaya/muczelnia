<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Baza Tre≈õci</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .search-bar-container { margin-bottom: 30px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;}
        .search-input { flex-grow: 1; padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border-color); font-size: 16px; outline: none; background: var(--panel-bg); color: var(--text-main); }
        
        .action-icon-btn {
            position: absolute; top: 10px; width: 30px; height: 30px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; 
            cursor: pointer; background: rgba(255,255,255,0.9); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s; z-index: 2;
        }
        .action-icon-btn:hover { transform: scale(1.1); }
        .edit-icon { right: 45px; color: #333; }
        .delete-icon { right: 10px; color: #F44336; }

        /* Breadcrumbs (Nawigacja ≈õcie≈ºkowa) */
        .breadcrumbs { font-size: 14px; color: #888; margin-bottom: 20px; display: flex; align-items: center; gap: 5px; }
        .breadcrumb-item { cursor: pointer; text-decoration: underline; }
        .breadcrumb-item:hover { color: var(--accent-color); }
        .breadcrumb-current { font-weight: bold; color: var(--text-main); text-decoration: none; cursor: default; }

        /* Styl kafelka folderu */
        .folder-tile { border-left: 5px solid #FFC107; } /* ≈ª√≥≈Çty pasek dla folder√≥w */
    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Baza Tre≈õci</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">‚Üê Wr√≥ƒá do pulpitu</a>
                    <h1>ZarzƒÖdzanie Tre≈õciƒÖ</h1>
                    <p>PrzeglƒÖdaj pakiety i zarzƒÖdzaj materia≈Çami.</p>
                </div>
            </div>

            <div class="breadcrumbs" id="breadcrumbs" style="display:none;">
                <span class="breadcrumb-item" onclick="showPackagesView()">Pakiety</span>
                <span>/</span>
                <span class="breadcrumb-current" id="current-folder-name">...</span>
            </div>

            <div class="search-bar-container">
                <input type="text" class="search-input" id="search-input" placeholder="Szukaj..." oninput="handleSearch()">
                <button class="login-button" id="add-pkg-btn" style="width: auto; margin:0;" onclick="openEditPackage(null)">+ Nowy Pakiet</button>
            </div>

            <div class="dashboard-grid" id="content-grid">
                </div>
        </main>
    </div>

    <div class="modal-overlay" id="editPackageModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title" id="pkg-modal-title">Edycja Pakietu</h3>
                <span class="close-modal" onclick="closeModal('editPackageModal')">&times;</span>
            </div>
            <form id="pkgForm">
                <input type="hidden" id="edit-pkg-id">
                
                <label>Nazwa Pakietu</label>
                <input type="text" id="edit-pkg-title" class="edit-input" required>
                
                <label>Opis Pakietu</label>
                <textarea id="edit-pkg-desc" class="edit-input" style="min-height: 80px;" placeholder="Kr√≥tki opis..."></textarea>
                
                <label>Poziom</label>
                <select id="edit-pkg-level" class="edit-input">
                    <option value="1">Podstawowy</option>
                    <option value="2">≈öredni</option>
                    <option value="3">Wy≈ºszy</option>
                </select>

                <button type="submit" class="login-button full-width-btn" style="margin-top: 15px;">Zapisz Zmiany</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Dane w pamiƒôci
        let allPackages = [];
        let allCourses = []; // Kursy i Quizy razem
        
        // Stan widoku
        let currentView = 'packages'; // 'packages' lub 'items'
        let currentPackageId = null; // ID wybranego pakietu lub 'null' dla lu≈∫nych

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            
            await fetchAllData();
            showPackagesView(); // Startowy widok

            document.getElementById('pkgForm').addEventListener('submit', savePackage);
        });

        async function fetchAllData() {
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '<p style="padding:20px;">≈Åadowanie danych...</p>';

            // Pobierz pakiety
            const { data: pkgs } = await _supabase.from('packages').select('*').order('title');
            allPackages = pkgs || [];

            // Pobierz kursy/quizy
            const { data: courses } = await _supabase.from('courses').select('id, title, type, package_id').order('created_at', { ascending: false });
            allCourses = courses || [];
        }

        // --- WIDOK 1: PAKIETY ---
        function showPackagesView() {
            currentView = 'packages';
            currentPackageId = null;
            
            // UI Update
            document.getElementById('breadcrumbs').style.display = 'none';
            document.getElementById('add-pkg-btn').style.display = 'block';
            document.getElementById('search-input').value = '';
            document.getElementById('search-input').placeholder = "Szukaj pakietu...";

            renderPackagesGrid(allPackages);
        }

        function renderPackagesGrid(packagesToRender) {
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '';

            // 1. Kafel "Lu≈∫ne elementy" (Dla kurs√≥w bez pakietu)
            const looseCount = allCourses.filter(c => c.package_id === null).length;
            const looseTile = document.createElement('div');
            looseTile.className = 'widget-tile';
            looseTile.style.borderLeft = "5px solid #999";
            looseTile.onclick = () => openFolder(null, "Lu≈∫ne elementy");
            looseTile.innerHTML = `
                <div style="font-size:40px; margin-bottom:10px; opacity:0.5;">üìÅ</div>
                <h3>Lu≈∫ne elementy</h3>
                <p style="color:#666; font-size:13px;">Nieprzypisane: ${looseCount}</p>
            `;
            grid.appendChild(looseTile);

            // 2. Kafelki Pakiet√≥w
            packagesToRender.forEach(pkg => {
                const count = allCourses.filter(c => c.package_id === pkg.id).length;
                
                const tile = document.createElement('div');
                tile.className = 'widget-tile folder-tile';
                tile.style.position = 'relative';
                
                // Klikniƒôcie w kafel otwiera folder
                tile.onclick = () => openFolder(pkg.id, pkg.title);

                tile.innerHTML = `
                    <div class="action-icon-btn edit-icon" onclick="event.stopPropagation(); openEditPackage(${pkg.id})" title="Edytuj Pakiet">‚úèÔ∏è</div>
                    <div class="action-icon-btn delete-icon" onclick="event.stopPropagation(); deletePackage(${pkg.id})" title="Usu≈Ñ Pakiet">üóëÔ∏è</div>
                    
                    <div style="font-size:40px; margin-bottom:10px;">üì¶</div>
                    <h3>${pkg.title}</h3>
                    <p style="color:#666; font-size:13px;">Element√≥w: ${count}</p>
                    <p style="color:#999; font-size:11px;">Poziom: ${pkg.level}</p>
                `;
                grid.appendChild(tile);
            });
        }

        // --- WIDOK 2: ZAWARTO≈öƒÜ FOLDERU ---
        function openFolder(pkgId, pkgName) {
            currentView = 'items';
            currentPackageId = pkgId;

            // UI Update
            document.getElementById('breadcrumbs').style.display = 'flex';
            document.getElementById('current-folder-name').textContent = pkgName;
            document.getElementById('add-pkg-btn').style.display = 'none'; // Nie dodajemy pakiet√≥w bƒôdƒÖc w pakiecie
            document.getElementById('search-input').value = '';
            document.getElementById('search-input').placeholder = "Szukaj w tym folderze...";

            renderItemsGrid();
        }

        function renderItemsGrid() {
            const grid = document.getElementById('content-grid');
            grid.innerHTML = '';

            // Filtrujemy kursy nale≈ºƒÖce do wybranego pakietu (lub lu≈∫ne)
            let items = allCourses.filter(c => c.package_id === currentPackageId);
            
            // Obs≈Çuga wyszukiwarki wewnƒÖtrz folderu
            const search = document.getElementById('search-input').value.toLowerCase();
            if(search) {
                items = items.filter(c => c.title.toLowerCase().includes(search));
            }

            if (items.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#888;">Ten folder jest pusty.</div>';
                return;
            }

            items.forEach(c => {
                const isQuiz = c.type === 'quiz';
                const editUrl = isQuiz ? `create_quiz.html?id=${c.id}` : `create_course.html?id=${c.id}`;
                const icon = isQuiz ? 'üìù' : 'üìö';
                const color = isQuiz ? '#9C27B0' : '#f04a4a';

                const tile = document.createElement('div');
                tile.className = 'widget-tile';
                tile.style.cursor = 'pointer';
                tile.onclick = () => window.location.href = editUrl; // Klikniƒôcie edytuje kurs
                
                tile.innerHTML = `
                    <div class="action-icon-btn delete-icon" onclick="event.stopPropagation(); deleteContent(${c.id}, '${c.type}')" title="Usu≈Ñ">üóëÔ∏è</div>
                    
                    <div style="font-size:40px; margin-bottom:10px;">${icon}</div>
                    <h3 style="color:${color}">${c.title}</h3>
                    <p style="color:#ccc; font-size:12px;">${isQuiz ? 'Quiz' : 'Kurs'}</p>
                `;
                grid.appendChild(tile);
            });
        }

        // --- OBS≈ÅUGA SZUKANIA ---
        function handleSearch() {
            const term = document.getElementById('search-input').value.toLowerCase();
            
            if (currentView === 'packages') {
                // Filtruj pakiety
                const filteredPkgs = allPackages.filter(p => p.title.toLowerCase().includes(term));
                renderPackagesGrid(filteredPkgs);
            } else {
                // Filtruj elementy wewnƒÖtrz folderu
                renderItemsGrid();
            }
        }

        // --- FUNKCJE CRUD (PAKIETY) ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function openEditPackage(id) {
            openModal('editPackageModal');
            const titleInput = document.getElementById('edit-pkg-title');
            const descInput = document.getElementById('edit-pkg-desc');
            const levelInput = document.getElementById('edit-pkg-level');
            const idInput = document.getElementById('edit-pkg-id');

            if (id) {
                document.getElementById('pkg-modal-title').innerText = "Edycja Pakietu";
                idInput.value = id;
                const pkg = allPackages.find(p => p.id === id);
                titleInput.value = pkg.title;
                descInput.value = pkg.description || "";
                levelInput.value = pkg.level;
            } else {
                document.getElementById('pkg-modal-title').innerText = "Nowy Pakiet";
                idInput.value = "";
                titleInput.value = "";
                descInput.value = "";
                levelInput.value = "1";
            }
        }

        async function savePackage(e) {
            e.preventDefault();
            const id = document.getElementById('edit-pkg-id').value;
            const title = document.getElementById('edit-pkg-title').value;
            const desc = document.getElementById('edit-pkg-desc').value;
            const level = document.getElementById('edit-pkg-level').value;

            let error;
            if (id) { // UPDATE
                const { error: err } = await _supabase.from('packages').update({ title, description: desc, level }).eq('id', id);
                error = err;
            } else { // INSERT
                const { error: err } = await _supabase.from('packages').insert({ title, description: desc, level });
                error = err;
            }

            if (error) alert("B≈ÇƒÖd: " + error.message);
            else {
                closeModal('editPackageModal');
                await fetchAllData();
                showPackagesView();
            }
        }

        async function deletePackage(id) {
            if(!confirm("UsunƒÖƒá ten pakiet? Kursy wewnƒÖtrz NIE zostanƒÖ usuniƒôte, ale trafiƒÖ do 'Lu≈∫nych element√≥w'.")) return;
            // Odepnij kursy najpierw (dla bezpiecze≈Ñstwa, choƒá w bazie mo≈ºe byƒá SET NULL)
            await _supabase.from('courses').update({ package_id: null }).eq('package_id', id);
            
            const { error } = await _supabase.from('packages').delete().eq('id', id);
            if(error) alert("B≈ÇƒÖd: " + error.message);
            else {
                await fetchAllData();
                showPackagesView();
            }
        }

        // --- FUNKCJE CRUD (TRE≈öƒÜ) ---
        async function deleteContent(id, type) {
            if(!confirm(`UsunƒÖƒá trwale ten ${type === 'quiz' ? 'quiz' : 'kurs'}?`)) return;
            const { error } = await _supabase.from('courses').delete().eq('id', id);
            if (error) alert("B≈ÇƒÖd: " + error.message);
            else {
                // Usu≈Ñ lokalnie i przerysuj
                allCourses = allCourses.filter(c => c.id !== id);
                renderItemsGrid();
            }
        }
    </script>
</body>
</html>
