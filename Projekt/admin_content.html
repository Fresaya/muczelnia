<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Baza Treści</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* --- STYLE DEDYKOWANE DLA TEJ STRONY --- */
        
        /* Zakładki */
        .content-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .tab-btn { 
            background: none; border: none; font-size: 16px; font-weight: 600; color: var(--text-muted); 
            cursor: pointer; padding: 10px 20px; border-radius: 8px; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; /* Wyrównanie ikony */
        }
        .tab-btn:hover { background: var(--hover-bg); color: var(--text-main); }
        .tab-btn.active { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .tab-btn .material-symbols-rounded { font-size: 20px; }

        /* GRID PAKIETÓW */
        .packages-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .package-card { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
        .pkg-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .pkg-title { font-weight: bold; font-size: 18px; margin: 0; }
        .pkg-desc { font-size: 13px; color: var(--text-muted); margin: 5px 0 0 0; }
        
        .pkg-content-list { list-style: none; padding: 0; margin: 0; flex: 1; }
        .pkg-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed var(--border-color); font-size: 14px; }
        .pkg-item:last-child { border-bottom: none; }
        
        /* Akcje wewnątrz pakietu */
        .pkg-actions { margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Ustandaryzowane mini przyciski */
        .mini-btn { 
            font-size: 12px; padding: 4px 8px; border-radius: 6px; cursor: pointer; 
            border: 1px solid var(--border-color); background: var(--bg-color);
            display: inline-flex; align-items: center; justify-content: center; gap: 4px;
            transition: all 0.2s;
            height: 32px; /* Stała wysokość */
        }
        .mini-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .mini-btn .material-symbols-rounded { font-size: 18px; }

        .btn-add-loose { color: #4CAF50; border-color: #4CAF50; background: rgba(76, 175, 80, 0.1); font-weight: 600; }
        .btn-add-loose:hover { background: rgba(76, 175, 80, 0.2); }

        /* LISTA LUŹNYCH ELEMENTÓW */
        .loose-list { display: flex; flex-direction: column; gap: 10px; }
        .loose-item { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .loose-info h4 { margin: 0; font-size: 16px; }
        .loose-info p { margin: 5px 0 0 0; font-size: 12px; color: var(--text-muted); }
        .type-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: bold; margin-left: 10px; }
        .badge-course { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
        .badge-quiz { background: rgba(156, 39, 176, 0.1); color: #9C27B0; }

        /* --- STYL WYSZUKIWARKI (Zaktualizowany pod ikony) ---  */
        .search-bar-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .search-icon-input {
            position: relative;
            width: 100%;
            max-width: 400px;
        }
        
        .search-icon-input input {
            width: 100%;
            padding: 10px 10px 10px 40px; /* Miejsce na ikonę */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 14px;
            box-sizing: border-box; /* Fix spilling */
        }
        
        .search-icon-input .material-symbols-rounded {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Przyciski główne z ikonami */
        .login-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .login-button .material-symbols-rounded { font-size: 20px; }

    </style>
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Baza Treści</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">← Wróć do pulpitu</a>
                    <h1>Baza Treści</h1>
                    <p>Zarządzaj pakietami, kursami i quizami.</p>
                </div>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button class="login-button" style="width:auto; background:#2196F3;" onclick="openCreatePackageModal()">
                        <span class="material-symbols-rounded">add_box</span> Nowy Pakiet
                    </button>
                    
                    <button class="login-button" style="width:auto; background:var(--accent-color);" onclick="window.location.href='create_course.html'">
                        <span class="material-symbols-rounded">post_add</span> Nowy Kurs
                    </button>
                    <button class="login-button" style="width:auto; background:#9C27B0;" onclick="window.location.href='create_quiz.html'">
                        <span class="material-symbols-rounded">assignment</span> Nowy Quiz
                    </button>
                </div>
            </div>

            <div class="modal-overlay" id="createPackageModal">
                <div class="modal-window">
                    <h3>Utwórz Nowy Pakiet</h3>
                    
                    <label style="font-size:12px; font-weight:bold; color:#555;">Nazwa Pakietu</label>
                    <input type="text" id="new-standalone-pkg-title" class="edit-input" placeholder="np. Fizyka - Dział 1">
                    
                    <label style="font-size:12px; font-weight:bold; color:#555;">Opis (Opcjonalnie)</label>
                    <textarea id="new-standalone-pkg-desc" class="edit-input" placeholder="Krótki opis zawartości..."></textarea>
                    
                    <label style="font-size:12px; font-weight:bold; color:#555;">Poziom Nauczania</label>
                    <select id="new-standalone-pkg-level" class="edit-input">
                        <option value="1">Szkoła Podstawowa</option>
                        <option value="2">Szkoła Średnia</option>
                        <option value="3">Szkoła Wyższa</option>
                    </select>

                    <div style="text-align:right; margin-top:15px;">
                        <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('createPackageModal')">Anuluj</button>
                        <button class="login-button" style="width:auto;" onclick="createStandalonePackage()">Utwórz</button>
                    </div>
                </div>
            </div>

            <div class="search-bar-container">
                <div class="search-icon-input">
                    <span class="material-symbols-rounded">search</span>
                    <input type="text" id="global-search" placeholder="Szukaj pakietu, kursu lub quizu..." oninput="filterContent()">
                </div>
            </div>

            <div class="content-tabs">
                <button class="tab-btn active" onclick="switchTab('packages')">
                    <span class="material-symbols-rounded">inventory_2</span> Pakiety
                </button>
                <button class="tab-btn" onclick="switchTab('loose')">
                    <span class="material-symbols-rounded">description</span> Luźne Elementy (<span id="loose-count">0</span>)
                </button>
            </div>

            <div id="view-packages" class="view-section">
                <div id="packages-container" class="packages-grid">
                    <p>Ładowanie pakietów...</p>
                </div>
            </div>

            <div id="view-loose" class="view-section" style="display:none;">
                <div id="loose-container" class="loose-list">
                    <p>Ładowanie elementów...</p>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="assignModal">
        <div class="modal-window">
            <h3>Przypisz do Pakietu</h3>
            <p>Wybierz pakiet dla: <b id="assign-item-name">...</b></p>
            <select id="assign-package-select" class="edit-input">
                <option>Ładowanie...</option>
            </select>
            <div style="text-align:right; margin-top:15px;">
                <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('assignModal')">Anuluj</button>
                <button class="login-button" style="width:auto;" onclick="confirmAssign()">Zapisz</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="importModal">
        <div class="modal-window">
            <h3>Dodaj element do pakietu</h3>
            <p>Wybierz element, który chcesz przenieść do: <b id="import-pkg-name">...</b></p>
            <select id="import-loose-select" class="edit-input">
                <option>Ładowanie...</option>
            </select>
            <div style="text-align:right; margin-top:15px;">
                <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('importModal')">Anuluj</button>
                <button class="login-button" style="width:auto;" onclick="confirmImport()">Dodaj</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let packagesData = [];
        let looseData = [];
        
        let selectedItemId = null;   // ID kursu przy przypisywaniu
        let selectedPackageId = null; // ID pakietu przy imporcie

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            
            // Tylko admin, manager, lecturer może tu być
            const { data: user } = await _supabase.from('users').select('role').eq('id', session.user.id).single();
            if(!['admin', 'manager', 'lecturer'].includes(user.role)) {
                alert("Brak uprawnień"); window.location.href='dashboard.html'; return;
            }

            loadContent();
        });

        async function loadContent() {
            // 1. Pobierz Pakiety + ich kursy
            const { data: pkgs } = await _supabase
                .from('packages')
                .select(`*, courses(id, title, type)`)
                .order('created_at', { ascending: false });
            packagesData = pkgs || [];

            // 2. Pobierz Luźne (gdzie package_id is null)
            const { data: loose } = await _supabase
                .from('courses')
                .select('*')
                .is('package_id', null)
                .order('created_at', { ascending: false });
            looseData = loose || [];

            // Update licznika w zakładce
            document.getElementById('loose-count').textContent = looseData.length;

            renderPackages();
            renderLoose();
        }

        function switchTab(tab) {
            document.getElementById('view-packages').style.display = tab === 'packages' ? 'block' : 'none';
            document.getElementById('view-loose').style.display = tab === 'loose' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function filterContent() {
            renderPackages();
            renderLoose();
        }

        // 2. Zaktualizowana funkcja renderPackages (z Ikonami)
        function renderPackages() {
            const container = document.getElementById('packages-container');
            container.innerHTML = '';
            
            const searchTerm = document.getElementById('global-search') ? document.getElementById('global-search').value.toLowerCase() : '';

            const filtered = packagesData.filter(p => {
                const matchTitle = p.title.toLowerCase().includes(searchTerm);
                const matchDesc = p.description && p.description.toLowerCase().includes(searchTerm);
                const matchInner = p.courses && p.courses.some(c => c.title.toLowerCase().includes(searchTerm));
                return matchTitle || matchDesc || matchInner;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#888;">Nie znaleziono pakietów.</p>';
                return;
            }

            filtered.forEach(p => {
                const card = document.createElement('div');
                card.className = 'package-card';
                
                let coursesHtml = '<ul class="pkg-content-list">';
                if (p.courses && p.courses.length > 0) {
                    p.courses.forEach(c => {
                        // Zastąpiono emotki ikonami
                        const iconName = c.type === 'quiz' ? 'quiz' : 'menu_book';
                        const editUrl = c.type === 'quiz' ? 'create_quiz.html' : 'create_course.html';
                        
                        coursesHtml += `
                            <li class="pkg-item">
                                <span style="display:flex; align-items:center; gap:8px; overflow:hidden; text-overflow:ellipsis;">
                                    <span class="material-symbols-rounded" style="font-size:18px; color:var(--text-muted);">${iconName}</span> 
                                    ${c.title}
                                </span>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <button class="mini-btn" style="color:#2196F3; border-color:var(--border-color);" 
                                            onclick="window.location.href='course.html?id=${c.id}&origin=admin'" 
                                            title="Wejdź / Zobacz jako uczeń">
                                        <span class="material-symbols-rounded">visibility</span>
                                    </button>

                                    <button class="mini-btn" style="color:var(--accent-color); border-color:var(--border-color);" 
                                            onclick="window.location.href='${editUrl}?id=${c.id}'" 
                                            title="Edytuj zawartość">
                                        <span class="material-symbols-rounded">edit</span>
                                    </button>
                                    
                                    <button class="mini-btn" style="color:red; border-color:red;" 
                                            onclick="detachCourse('${c.id}')" 
                                            title="Wyrzuć do luźnych">
                                        <span class="material-symbols-rounded">close</span>
                                    </button>
                                </div>
                            </li>`;
                    });
                } else {
                    coursesHtml += '<li class="pkg-item" style="color:#aaa; justify-content:center;">Pusty pakiet</li>';
                }
                coursesHtml += '</ul>';

                card.innerHTML = `
                    <div class="pkg-header">
                        <div>
                            <h3 class="pkg-title">${p.title}</h3>
                            <p class="pkg-desc">${p.description || 'Brak opisu'}</p>
                        </div>
                        <button class="mini-btn" style="color:red; border-color:red;" onclick="deletePackage('${p.id}')">
                            <span class="material-symbols-rounded">delete</span> Usuń
                        </button>
                    </div>
                    ${coursesHtml}
                    <div class="pkg-actions">
                        <button class="mini-btn btn-add-loose" onclick="openImportModal('${p.id}', '${p.title}')">
                            <span class="material-symbols-rounded">add</span> Dodaj z luźnych
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 3. Zaktualizowana funkcja renderLoose (z Ikonami)
        function renderLoose() {
            const container = document.getElementById('loose-container');
            container.innerHTML = '';

            const searchTerm = document.getElementById('global-search') ? document.getElementById('global-search').value.toLowerCase() : '';

            const filtered = looseData.filter(l => {
                const matchTitle = l.title.toLowerCase().includes(searchTerm);
                const matchDesc = l.description && l.description.toLowerCase().includes(searchTerm);
                return matchTitle || matchDesc;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">Brak elementów.</p>';
                return;
            }

            filtered.forEach(l => {
                const div = document.createElement('div');
                div.className = 'loose-item';
                const typeLabel = l.type === 'quiz' ? 'QUIZ' : 'KURS';
                const typeClass = l.type === 'quiz' ? 'badge-quiz' : 'badge-course';

                div.innerHTML = `
                    <div class="loose-info">
                        <h4 style="display:flex; align-items:center;">
                            ${l.title} 
                            <span class="type-badge ${typeClass}">${typeLabel}</span>
                        </h4>
                        <p>${l.description || 'Bez opisu'}</p>
                    </div>
                    <div style="display:flex; gap:10px; align-items: center;">
                        <button class="mini-btn" style="color:#2196F3;" 
                                onclick="window.location.href='course.html?id=${l.id}&origin=admin'" title="Zobacz">
                            <span class="material-symbols-rounded">visibility</span>
                        </button>

                        <button class="mini-btn" style="color:var(--text-main);" 
                                onclick="window.location.href='${l.type === 'quiz' ? 'create_quiz.html' : 'create_course.html'}?id=${l.id}'" title="Edytuj">
                            <span class="material-symbols-rounded">edit</span>
                        </button>
                        
                        <button class="mini-btn" style="color:white; background:var(--accent-color); border-color:var(--accent-color); font-weight:bold;" 
                                onclick="openAssignModal('${l.id}', '${l.title}')">
                            <span class="material-symbols-rounded">input</span> Dołącz
                        </button>
                        
                        <button class="mini-btn" style="color:white; background:#F44336; border-color:#F44336;" 
                                onclick="deleteLooseItem('${l.id}')">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function deleteLooseItem(id) {
            if(!confirm("UWAGA: Czy na pewno usunąć ten element bezpowrotnie?")) return;
            
            const { error } = await _supabase.from('courses').delete().eq('id', id);
            
            if(error) alert("Błąd: " + error.message);
            else {
                loadContent();
            }
        }

        function openAssignModal(courseId, title) {
            selectedItemId = courseId;
            document.getElementById('assign-item-name').innerText = title;
            const sel = document.getElementById('assign-package-select');
            sel.innerHTML = '<option value="" disabled selected>-- Wybierz pakiet --</option>';
            
            packagesData.forEach(p => {
                sel.add(new Option(p.title, p.id));
            });
            
            document.getElementById('assignModal').classList.add('active');
        }

        async function confirmAssign() {
            const pkgId = document.getElementById('assign-package-select').value;
            if(!pkgId || !selectedItemId) return;

            const { error } = await _supabase.from('courses').update({ package_id: pkgId }).eq('id', selectedItemId);
            if(error) alert(error.message);
            else {
                document.getElementById('assignModal').classList.remove('active');
                loadContent(); 
            }
        }

        function openImportModal(pkgId, pkgTitle) {
            selectedPackageId = pkgId;
            document.getElementById('import-pkg-name').innerText = pkgTitle;
            const sel = document.getElementById('import-loose-select');
            sel.innerHTML = '';

            if (looseData.length === 0) {
                sel.innerHTML = '<option disabled>Brak luźnych elementów do dodania</option>';
            } else {
                sel.innerHTML = '<option value="" disabled selected>-- Wybierz element --</option>';
                looseData.forEach(l => {
                    sel.add(new Option(`[${l.type.toUpperCase()}] ${l.title}`, l.id));
                });
            }

            document.getElementById('importModal').classList.add('active');
        }

        async function confirmImport() {
            const courseId = document.getElementById('import-loose-select').value;
            if(!courseId || !selectedPackageId) return;

            const { error } = await _supabase.from('courses').update({ package_id: selectedPackageId }).eq('id', courseId);
            if(error) alert(error.message);
            else {
                document.getElementById('importModal').classList.remove('active');
                loadContent();
            }
        }

        async function detachCourse(courseId) {
            if(!confirm("Czy na pewno odpiąć ten element od pakietu? Trafi on do sekcji 'Luźne'.")) return;
            const { error } = await _supabase.from('courses').update({ package_id: null }).eq('id', courseId);
            if(error) alert(error.message);
            else loadContent();
        }

        async function deletePackage(pkgId) {
            if(!confirm("Usunąć pakiet? Kursy wewnątrz NIE zostaną usunięte, tylko przeniesione do 'Luźnych'.")) return;
            const { error } = await _supabase.from('packages').delete().eq('id', pkgId);
            if(error) alert(error.message);
            else loadContent();
        }

        function openCreatePackageModal() {
            document.getElementById('new-standalone-pkg-title').value = '';
            document.getElementById('new-standalone-pkg-desc').value = '';
            document.getElementById('new-standalone-pkg-level').value = '1';
            
            document.getElementById('createPackageModal').classList.add('active');
        }

        async function createStandalonePackage() {
            const title = document.getElementById('new-standalone-pkg-title').value;
            const desc = document.getElementById('new-standalone-pkg-desc').value;
            const level = document.getElementById('new-standalone-pkg-level').value;

            if (!title) return alert("Podaj nazwę pakietu!");

            const { error } = await _supabase.from('packages').insert({
                title: title,
                description: desc,
                level: level
            });

            if (error) {
                alert("Błąd: " + error.message);
            } else {
                alert("Pakiet utworzony!");
                closeModal('createPackageModal');
                loadContent(); 
                
                switchTab('packages');
                const btnPkg = document.querySelector("button[onclick=\"switchTab('packages')\"]");
                if(btnPkg) btnPkg.click();
            }
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    </script>
</body>
</html>
