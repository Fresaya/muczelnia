<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Kreator Quizu</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="course-layout">
        <aside class="course-sidebar">
            <div class="sidebar-header">
                <a href="dashboard.html" class="back-btn">‚Üê Anuluj</a>
                <h3 style="margin:0; font-size:16px; margin-left: 10px;">Kreator Quizu</h3>
            </div>
            <ul class="lesson-list" id="editor-question-list"></ul>
            <div class="add-lesson-btn" onclick="addNewQuestion()">+ Nowe Pytanie</div>
        </aside>

        <main class="course-content">
            <div class="lesson-card">
                <!-- QUIZ SETTINGS -->
                <div style="border-bottom: 2px solid #eee; margin-bottom: 30px; padding-bottom: 20px;">
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Nazwa Quizu</label>
                    <input type="text" id="quiz-title-input" class="edit-input title-input" placeholder="Np. Sprawdzian z Historii" oninput="updateQuizState()">
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Opis</label>
                    <textarea id="quiz-desc-input" class="edit-input" style="min-height: 60px;" placeholder="Czego dotyczy ten test?" oninput="updateQuizState()"></textarea>
                </div>

                <!-- QUESTION EDITOR -->
                <div id="active-question-editor" style="display: none;">
                    <h2 style="color: var(--accent-color);">Edycja Pytania</h2>
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Tre≈õƒá Pytania</label>
                    <input type="text" id="question-text-input" class="edit-input title-input" style="font-size:18px;" placeholder="Tre≈õƒá..." oninput="updateQuestionState()">
                    <div style="margin-top: 20px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee;">
                        <h3 style="margin-top:0; font-size:16px;">Odpowiedzi</h3>
                        <div id="answers-container"></div>
                    </div>
                </div>
                <div id="no-selection-msg" style="text-align: center; color: #888; padding: 50px;">Kliknij <b>+ Nowe Pytanie</b></div>
            </div>
        </main>
    </div>

    <!-- SAVE BUTTON -->
    <button class="save-course-fab" onclick="openPackageModal()" id="preSaveBtn" style="background-color: #9C27B0;">
        <span>üíæ Zapisz Quiz</span>
    </button>

    <!-- PACKAGE MODAL (SAME AS COURSE) -->
    <div class="modal-overlay" id="packageModal">
        <div class="modal-window">
            <div class="modal-header"><h3 class="modal-title">Zapisz jako czƒô≈õƒá pakietu</h3><span class="close-modal" onclick="closeModal()">&times;</span></div>
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:10px;"><input type="radio" name="pkgOption" value="new" checked onchange="togglePkgInputs()"> Utw√≥rz <b>Nowy Pakiet</b></label>
                <div id="new-pkg-inputs" style="padding-left: 20px;"><input type="text" id="new-pkg-name" class="edit-input" placeholder="Nazwa pakietu"></div>
                <label style="display:block; margin-top:15px; margin-bottom:10px;"><input type="radio" name="pkgOption" value="existing" onchange="togglePkgInputs()"> Dodaj do <b>IstniejƒÖcego</b></label>
                <div id="existing-pkg-inputs" style="padding-left: 20px; display:none;"><select id="existing-pkg-select" class="edit-input"><option value="" disabled selected>≈Åadowanie...</option></select></div>
            </div>
            <button class="login-button full-width-btn" onclick="saveQuizToDB()" id="finalSaveBtn">Zapisz wszystko</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let quizData = { title: "", description: "", author_id: null };
        let questions = []; 
        let activeQuestionId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            quizData.author_id = session.user.id;
            const { data: profile } = await _supabase.from('users').select('role').eq('id', session.user.id).single();
            if(profile.role !== 'admin') { window.location.href='dashboard.html'; }
        });

        // --- PACKAGE MODAL ---
        async function openPackageModal() {
            if (!quizData.title) return alert("Podaj nazwƒô quizu!");
            if (questions.length === 0) return alert("Dodaj pytania!");
            document.getElementById('packageModal').classList.add('active');
            document.getElementById('new-pkg-name').value = quizData.title + " (Pakiet)";
            
            const select = document.getElementById('existing-pkg-select');
            select.innerHTML = '<option value="" disabled selected>≈Åadowanie...</option>';
            const { data: pkgs } = await _supabase.from('packages').select('id, title').order('created_at', { ascending: false });
            if(pkgs) {
                select.innerHTML = '<option value="" disabled selected>-- Wybierz Pakiet --</option>';
                pkgs.forEach(p => select.appendChild(new Option(p.title, p.id)));
            }
        }
        function closeModal() { document.getElementById('packageModal').classList.remove('active'); }
        function togglePkgInputs() {
            const isNew = document.querySelector('input[name="pkgOption"]:checked').value === 'new';
            document.getElementById('new-pkg-inputs').style.display = isNew ? 'block' : 'none';
            document.getElementById('existing-pkg-inputs').style.display = isNew ? 'none' : 'block';
        }

        // --- SAVE LOGIC ---
        async function saveQuizToDB() {
            const btn = document.getElementById('finalSaveBtn');
            btn.disabled = true; btn.innerHTML = "‚è≥ Zapisywanie...";

            try {
                let packageId = null;
                const pkgOption = document.querySelector('input[name="pkgOption"]:checked').value;
                if (pkgOption === 'new') {
                    const pkgTitle = document.getElementById('new-pkg-name').value;
                    const { data: newPkg, error: pkgErr } = await _supabase.from('packages').insert({ title: pkgTitle }).select().single();
                    if(pkgErr) throw pkgErr;
                    packageId = newPkg.id;
                } else {
                    packageId = document.getElementById('existing-pkg-select').value;
                }

                // Create Course (Quiz Type)
                const { data: course, error: cErr } = await _supabase.from('courses')
                    .insert({ title: quizData.title, description: quizData.description, author_id: quizData.author_id, type: 'quiz', package_id: packageId })
                    .select().single();
                if (cErr) throw cErr;

                // Save Questions
                for (let i = 0; i < questions.length; i++) {
                    const q = questions[i];
                    const { data: savedLesson, error: lErr } = await _supabase.from('lessons').insert({ course_id: course.id, title: q.title, order_index: i + 1 }).select().single();
                    if (lErr) throw lErr;
                    
                    const { data: content, error: ctErr } = await _supabase.from('content_text_blocks').insert({ content: "Pytanie" }).select().single();
                    await _supabase.from('lesson_components').insert({ lesson_id: savedLesson.id, order_index: 1, component_type: 'text', content_text_block_id: content.id });

                    const answersPayload = q.answers.map(a => ({ lesson_id: savedLesson.id, answer_text: a.text, is_correct: a.isCorrect }));
                    await _supabase.from('lesson_answers').insert(answersPayload);
                }

                alert("‚úÖ Quiz zapisany w pakiecie!");
                window.location.href = 'dashboard.html';
            } catch (err) { alert("B≈ÇƒÖd: " + err.message); btn.disabled = false; }
        }

        // --- EDITOR LOGIC (Abbreviated) ---
        function addNewQuestion() {
            const newId = Date.now();
            questions.push({ id: newId, title: "Pytanie " + (questions.length + 1), answers: [{text:"",isCorrect:true},{text:"",isCorrect:false},{text:"",isCorrect:false},{text:"",isCorrect:false}] });
            renderSidebar(); selectQuestion(newId);
        }
        function renderSidebar() {
            const list = document.getElementById('editor-question-list'); list.innerHTML = '';
            questions.forEach((q, index) => {
                const li = document.createElement('li'); li.className = `lesson-item ${q.id === activeQuestionId ? 'active' : ''}`;
                li.innerHTML = `<span>${index+1}. ${q.title}</span>`; li.onclick = () => selectQuestion(q.id); list.appendChild(li);
            });
        }
        function selectQuestion(id) {
            activeQuestionId = id; document.getElementById('no-selection-msg').style.display = 'none'; document.getElementById('active-question-editor').style.display = 'block';
            const q = questions.find(item => item.id === id); document.getElementById('question-text-input').value = q.title;
            renderAnswerInputs(q); renderSidebar();
        }
        function renderAnswerInputs(q) {
            const c = document.getElementById('answers-container'); c.innerHTML = '';
            q.answers.forEach((ans, idx) => {
                const div = document.createElement('div'); div.className = 'quiz-editor-row';
                const rad = document.createElement('input'); rad.type='radio'; rad.name='corr'; rad.className='correct-radio'; rad.checked=ans.isCorrect;
                rad.onchange=()=>{ q.answers.forEach(a=>a.isCorrect=false); q.answers[idx].isCorrect=true; };
                const inp = document.createElement('input'); inp.type='text'; inp.className='edit-input'; inp.value=ans.text; inp.placeholder=`Odp ${idx+1}`;
                inp.oninput=(e)=>{ q.answers[idx].text=e.target.value; };
                div.appendChild(rad); div.appendChild(inp); c.appendChild(div);
            });
        }
        function updateQuizState() { quizData.title = document.getElementById('quiz-title-input').value; quizData.description = document.getElementById('quiz-desc-input').value; }
        function updateQuestionState() { if(activeQuestionId) { questions.find(q=>q.id===activeQuestionId).title = document.getElementById('question-text-input').value; renderSidebar(); } }
    </script>
</body>
</html>
