<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Kreator Quizu</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="mobile-top-bar">
        <div class="mobile-hamburger" onclick="toggleSidebar()">‚ò∞</div>
        <div class="logo-text">Edytor Quizu</div>
    </div>

    <div class="course-layout">
        <aside class="course-sidebar" id="course-sidebar">
            <div class="sidebar-header">
                <a href="quizzes_list.html" class="back-btn">‚Üê Anuluj</a>
                <h3 style="margin:0; font-size:16px; margin-left: 10px;">Pytania</h3>
                <span class="mobile-only-close" style="margin-left:auto; font-size:24px; cursor:pointer;" onclick="toggleSidebar()">‚úï</span>
            </div>
            
            <ul class="lesson-list" id="editor-question-list"></ul>

            <div class="add-lesson-btn" onclick="addNewQuestion()">+ Nowe Pytanie</div>
        </aside>

        <main class="course-content">
            <div class="lesson-card">
                <!-- SETTINGS -->
                <div style="border-bottom: 2px solid #eee; margin-bottom: 30px; padding-bottom: 20px;">
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Nazwa Quizu</label>
                    <input type="text" id="quiz-title-input" class="edit-input title-input" placeholder="Np. Sprawdzian z Historii" oninput="updateQuizState()">
                    <textarea id="quiz-desc-input" class="edit-input" style="min-height: 60px; margin-top:10px;" placeholder="Opis..." oninput="updateQuizState()"></textarea>
                </div>

                <!-- QUESTION EDITOR -->
                <div id="active-question-editor" style="display: none;">
                    <h2 style="color: var(--accent-color);">Edycja Pytania</h2>
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Tre≈õƒá Pytania</label>
                    <input type="text" id="question-text-input" class="edit-input title-input" style="font-size:18px;" placeholder="Tre≈õƒá..." oninput="updateQuestionState()">
                    
                    <div style="margin-top: 20px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee;">
                        <h3 style="margin-top:0; font-size:16px;">Odpowiedzi</h3>
                        <div id="answers-container"></div>
                    </div>
                </div>
                <div id="no-selection-msg" style="text-align: center; color: #888; padding: 50px;">
                    <span id="loading-msg">≈Åadowanie...</span>
                </div>
            </div>
        </main>
    </div>

    <button class="save-course-fab" onclick="handleSaveClick()" id="preSaveBtn" style="background-color: #9C27B0;">
        <span>üíæ Zapisz Zmiany</span>
    </button>

    <!-- PACKAGE MODAL (Only for NEW) -->
    <div class="modal-overlay" id="packageModal"><div class="modal-window"><div class="modal-header"><h3 class="modal-title">Zapisz</h3><span class="close-modal" onclick="closeModal()">&times;</span></div><div style="margin-bottom: 20px;"><label style="display:block; margin-bottom:10px;"><input type="radio" name="pkgOption" value="new" checked onchange="togglePkgInputs()"> Nowy Pakiet</label><div id="new-pkg-inputs" style="padding-left: 20px;"><input type="text" id="new-pkg-name" class="edit-input" placeholder="Nazwa"><select id="new-pkg-level" class="edit-input"><option value="1">Podstawowa</option><option value="2">≈örednia</option><option value="3">Wy≈ºsza</option></select></div><label style="display:block; margin-top:15px;"><input type="radio" name="pkgOption" value="existing" onchange="togglePkgInputs()"> IstniejƒÖcy</label><div id="existing-pkg-inputs" style="padding-left: 20px; display:none;"><select id="existing-pkg-select" class="edit-input"></select></div></div><button class="login-button full-width-btn" onclick="saveQuizToDB(true)" id="finalSaveBtn">Zapisz</button></div></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        function toggleSidebar() { document.getElementById('course-sidebar').classList.toggle('active'); }
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');

        let quizData = { title: "", description: "", author_id: null };
        let questions = []; 
        let activeQuestionId = null;
        let deletedQuestionIds = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            quizData.author_id = session.user.id;
            
            const { data: profile } = await _supabase.from('users').select('role').eq('id', session.user.id).single();
            if(profile.role !== 'admin') { alert("Tylko admin."); window.location.href='dashboard.html'; return; }

            if (editId) {
                document.querySelector('.logo-text').textContent = "Edycja Quizu";
                await loadQuizData(editId);
            } else {
                document.getElementById('no-selection-msg').innerHTML = "Kliknij <b>+ Nowe Pytanie</b>.";
            }
        });

        // --- LOAD DATA ---
        async function loadQuizData(id) {
            const { data: course } = await _supabase.from('courses').select('*').eq('id', id).single();
            quizData.title = course.title;
            quizData.description = course.description;
            document.getElementById('quiz-title-input').value = course.title;
            document.getElementById('quiz-desc-input').value = course.description || "";

            const { data: lessons } = await _supabase.from('lessons').select('id, title, order_index').eq('course_id', id).order('order_index');
            
            if (lessons) {
                for (let l of lessons) {
                    // Fetch answers for each question
                    const { data: ans } = await _supabase.from('lesson_answers').select('*').eq('lesson_id', l.id);
                    
                    const formattedAnswers = [
                        { text: "", isCorrect: false }, { text: "", isCorrect: false },
                        { text: "", isCorrect: false }, { text: "", isCorrect: false }
                    ];
                    
                    if (ans) {
                        ans.forEach((a, i) => {
                            if (i < 4) formattedAnswers[i] = { text: a.answer_text, isCorrect: a.is_correct };
                        });
                    }

                    questions.push({
                        id: l.id,
                        title: l.title,
                        answers: formattedAnswers
                    });
                }
            }
            renderSidebar();
            document.getElementById('no-selection-msg').innerHTML = "Wybierz pytanie do edycji.";
        }

        // --- UI LOGIC ---
        function addNewQuestion() {
            const id = 'new-' + Date.now();
            questions.push({ id, title: "Pytanie " + (questions.length + 1), answers: [{text:"",isCorrect:true},{text:"",isCorrect:false},{text:"",isCorrect:false},{text:"",isCorrect:false}] });
            renderSidebar(); selectQuestion(id);
        }

        function renderSidebar() {
            const list = document.getElementById('editor-question-list'); list.innerHTML = '';
            questions.forEach((q, index) => {
                const li = document.createElement('li');
                li.className = `lesson-item ${q.id === activeQuestionId ? 'active' : ''}`;
                li.innerHTML = `<span>${index + 1}. ${q.title}</span> <span style="color:red;" onclick="removeQuestion(event, '${q.id}')">&times;</span>`;
                li.onclick = () => selectQuestion(q.id);
                list.appendChild(li);
            });
        }

        function selectQuestion(id) {
            activeQuestionId = id;
            document.getElementById('no-selection-msg').style.display = 'none';
            document.getElementById('active-question-editor').style.display = 'block';
            const q = questions.find(item => item.id === id);
            document.getElementById('question-text-input').value = q.title;
            renderAnswerInputs(q); renderSidebar();
        }

        function renderAnswerInputs(q) {
            const c = document.getElementById('answers-container'); c.innerHTML = '';
            q.answers.forEach((ans, idx) => {
                const div = document.createElement('div'); div.className = 'quiz-editor-row';
                const rad = document.createElement('input'); rad.type='radio'; rad.name='corr'; rad.className='correct-radio'; rad.checked=ans.isCorrect;
                rad.onchange=()=>{ q.answers.forEach(a=>a.isCorrect=false); q.answers[idx].isCorrect=true; };
                const inp = document.createElement('input'); inp.type='text'; inp.className='edit-input'; inp.value=ans.text; inp.placeholder=`Odp ${idx+1}`;
                inp.oninput=(e)=>{ q.answers[idx].text=e.target.value; };
                div.appendChild(rad); div.appendChild(inp); c.appendChild(div);
            });
        }

        function removeQuestion(e, id) {
            e.stopPropagation();
            if(!confirm("UsunƒÖƒá?")) return;
            if (typeof id === 'number' || !id.startsWith('new-')) deletedQuestionIds.push(id);
            questions = questions.filter(q => q.id != id);
            if (activeQuestionId == id) { activeQuestionId = null; document.getElementById('active-question-editor').style.display = 'none'; document.getElementById('no-selection-msg').style.display = 'block'; }
            renderSidebar();
        }

        function updateQuizState() { quizData.title = document.getElementById('quiz-title-input').value; quizData.description = document.getElementById('quiz-desc-input').value; }
        function updateQuestionState() { if(activeQuestionId) { questions.find(q=>q.id===activeQuestionId).title = document.getElementById('question-text-input').value; renderSidebar(); } }

        function handleSaveClick() {
            if (!quizData.title) return alert("Podaj nazwƒô!");
            if (questions.length === 0) return alert("Dodaj pytania!");
            if (editId) saveQuizToDB(false);
            else { document.getElementById('packageModal').classList.add('active'); openPackageModal(); }
        }

        async function openPackageModal() { /* Same package logic as create_course */ document.getElementById('new-pkg-name').value = quizData.title + " (Pakiet)"; const s = document.getElementById('existing-pkg-select'); s.innerHTML='<option>≈Åadowanie...</option>'; const {data}=await _supabase.from('packages').select('*').order('created_at',{ascending:false}); s.innerHTML='<option value="" disabled selected>-- Wybierz --</option>'; data.forEach(p=>s.add(new Option(p.title,p.id))); }
        function closeModal() { document.getElementById('packageModal').classList.remove('active'); }
        function togglePkgInputs() { const n=document.querySelector('input[name="pkgOption"]:checked').value==='new'; document.getElementById('new-pkg-inputs').style.display=n?'block':'none'; document.getElementById('existing-pkg-inputs').style.display=n?'none':'block'; }

        async function saveQuizToDB(isNew) {
            const btn = isNew ? document.getElementById('finalSaveBtn') : document.getElementById('preSaveBtn');
            btn.disabled = true; btn.innerHTML = "‚è≥ Zapisywanie...";

            try {
                let courseId = editId;

                // 1. Course Logic
                if (isNew) {
                    let packageId = null;
                    const pkgOpt = document.querySelector('input[name="pkgOption"]:checked').value;
                    if (pkgOpt === 'new') {
                        const { data: pkg } = await _supabase.from('packages').insert({ title: document.getElementById('new-pkg-name').value, level: document.getElementById('new-pkg-level').value }).select().single();
                        packageId = pkg.id;
                    } else { packageId = document.getElementById('existing-pkg-select').value; }

                    const { data: newC, error } = await _supabase.from('courses').insert({ title: quizData.title, description: quizData.description, author_id: quizData.author_id, type: 'quiz', package_id: packageId }).select().single();
                    if(error) throw error;
                    courseId = newC.id;
                } else {
                    await _supabase.from('courses').update({ title: quizData.title, description: quizData.description }).eq('id', courseId);
                }

                // 2. Deletions
                if (deletedQuestionIds.length > 0) {
                    await _supabase.from('lessons').delete().in('id', deletedQuestionIds);
                }

                // 3. Upsert Questions & Answers
                for (let i = 0; i < questions.length; i++) {
                    const q = questions[i];
                    let lessonId = q.id;
                    const isTemp = String(q.id).startsWith('new-');

                    if (isTemp) {
                        // Insert
                        const { data: savedLesson } = await _supabase.from('lessons').insert({ course_id: courseId, title: q.title, order_index: i + 1 }).select().single();
                        lessonId = savedLesson.id;
                        // Dummy content
                        const { data: content } = await _supabase.from('content_text_blocks').insert({ content: "Pytanie" }).select().single();
                        await _supabase.from('lesson_components').insert({ lesson_id: lessonId, order_index: 1, component_type: 'text', content_text_block_id: content.id });
                    } else {
                        // Update
                        await _supabase.from('lessons').update({ title: q.title, order_index: i + 1 }).eq('id', lessonId);
                        // Clean old answers to replace with new set (easiest way to handle answer changes)
                        await _supabase.from('lesson_answers').delete().eq('lesson_id', lessonId);
                    }

                    // Insert Answers (Always fresh insert for existing questions to avoid complex ID mapping)
                    const answersPayload = q.answers.filter(a => a.text).map(a => ({
                        lesson_id: lessonId,
                        answer_text: a.text,
                        is_correct: a.isCorrect
                    }));
                    if (answersPayload.length > 0) {
                        await _supabase.from('lesson_answers').insert(answersPayload);
                    }
                }

                alert("‚úÖ Zapisano pomy≈õlnie!");
                window.location.href = 'quizzes_list.html';

            } catch (err) { alert("B≈ÇƒÖd: " + err.message); } 
            finally { btn.disabled = false; btn.innerHTML = isNew ? "Zapisz" : "üíæ Zapisz Zmiany"; }
        }
    </script>
</body>
</html>
