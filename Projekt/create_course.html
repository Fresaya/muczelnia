<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Kreator Kursu</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="course-layout">
        <aside class="course-sidebar">
            <div class="sidebar-header">
                <a href="dashboard.html" class="back-btn">‚Üê Anuluj</a>
                <h3 style="margin:0; font-size:16px; margin-left: 10px;">Edytor Kursu</h3>
            </div>
            
            <ul class="lesson-list" id="editor-lesson-list"></ul>

            <div class="add-lesson-btn" onclick="addNewLesson()">+ Nowa Lekcja</div>
        </aside>

        <main class="course-content">
            <div class="lesson-card">
                
                <!-- SETTINGS -->
                <div style="border-bottom: 2px solid #eee; margin-bottom: 30px; padding-bottom: 20px;">
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Tytu≈Ç ca≈Çego kursu</label>
                    <input type="text" id="course-title-input" class="edit-input title-input" placeholder="Wpisz nazwƒô kursu..." oninput="updateCourseState()">
                    
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Opis kursu</label>
                    <textarea id="course-desc-input" class="edit-input" style="min-height: 80px;" placeholder="O czym jest ten kurs?" oninput="updateCourseState()"></textarea>
                </div>

                <!-- LESSON EDITOR -->
                <div id="active-lesson-editor" style="display: none;">
                    <h2 style="color: var(--accent-color);">Edycja Lekcji</h2>
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Tytu≈Ç lekcji</label>
                    <input type="text" id="lesson-title-input" class="edit-input title-input" placeholder="Np. Wstƒôp do zagadnienia" oninput="updateLessonState()">
                    <label style="font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold;">Tre≈õƒá lekcji (HTML dozwolony)</label>
                    <textarea id="lesson-content-input" class="edit-area" placeholder="Wpisz tre≈õƒá lekcji tutaj..." oninput="updateLessonState()"></textarea>
                </div>

                <div id="no-selection-msg" style="text-align: center; color: #888; padding: 50px;">
                    Kliknij <b>+ Nowa Lekcja</b> po lewej stronie.
                </div>
            </div>
        </main>
    </div>

    <!-- Floating Save Button triggers Package Modal -->
    <button class="save-course-fab" onclick="openPackageModal()" id="preSaveBtn">
        <span>üíæ Zapisz Kurs</span>
    </button>

    <!-- PACKAGE SELECTION MODAL -->
    <div class="modal-overlay" id="packageModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Zapisz jako czƒô≈õƒá pakietu</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:10px;">
                    <input type="radio" name="pkgOption" value="new" checked onchange="togglePkgInputs()"> 
                    Utw√≥rz <b>Nowy Pakiet</b>
                </label>
                <div id="new-pkg-inputs" style="padding-left: 20px;">
                    <input type="text" id="new-pkg-name" class="edit-input" placeholder="Nazwa pakietu (np. Historia Staro≈ºytna)" style="border:1px solid #ccc;">
                </div>

                <label style="display:block; margin-top:15px; margin-bottom:10px;">
                    <input type="radio" name="pkgOption" value="existing" onchange="togglePkgInputs()"> 
                    Dodaj do <b>IstniejƒÖcego Pakietu</b>
                </label>
                <div id="existing-pkg-inputs" style="padding-left: 20px; display:none;">
                    <select id="existing-pkg-select" class="edit-input" style="border:1px solid #ccc;">
                        <option value="" disabled selected>≈Åadowanie pakiet√≥w...</option>
                    </select>
                </div>
            </div>

            <button class="login-button full-width-btn" onclick="saveCourseToDB()" id="finalSaveBtn">Zapisz wszystko</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let courseData = { title: "", description: "", author_id: null };
        let lessons = []; 
        let activeLessonId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            courseData.author_id = session.user.id;
            const { data: profile } = await _supabase.from('users').select('role').eq('id', session.user.id).single();
            if (!profile || profile.role !== 'admin') { alert("Brak uprawnie≈Ñ."); window.location.href = 'dashboard.html'; }
        });

        // --- PACKAGE MODAL LOGIC ---
        async function openPackageModal() {
            if (!courseData.title) return alert("Najpierw podaj tytu≈Ç kursu!");
            if (lessons.length === 0) return alert("Kurs musi mieƒá lekcje!");
            
            document.getElementById('packageModal').classList.add('active');
            
            // Prefill course title as package name suggestion
            document.getElementById('new-pkg-name').value = courseData.title;

            // Load existing packages
            const select = document.getElementById('existing-pkg-select');
            select.innerHTML = '<option value="" disabled selected>≈Åadowanie...</option>';
            const { data: pkgs } = await _supabase.from('packages').select('id, title').order('created_at', { ascending: false });
            
            if(pkgs && pkgs.length > 0) {
                select.innerHTML = '<option value="" disabled selected>-- Wybierz Pakiet --</option>';
                pkgs.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.title;
                    select.appendChild(opt);
                });
            } else {
                select.innerHTML = '<option value="" disabled>Brak pakiet√≥w</option>';
            }
        }

        function closeModal() { document.getElementById('packageModal').classList.remove('active'); }

        function togglePkgInputs() {
            const isNew = document.querySelector('input[name="pkgOption"]:checked').value === 'new';
            document.getElementById('new-pkg-inputs').style.display = isNew ? 'block' : 'none';
            document.getElementById('existing-pkg-inputs').style.display = isNew ? 'none' : 'block';
        }

        // --- CORE SAVE LOGIC ---
        async function saveCourseToDB() {
            const btn = document.getElementById('finalSaveBtn');
            btn.disabled = true;
            btn.innerHTML = "‚è≥ Zapisywanie...";

            try {
                // 1. Handle Package
                let packageId = null;
                const pkgOption = document.querySelector('input[name="pkgOption"]:checked').value;

                if (pkgOption === 'new') {
                    const pkgTitle = document.getElementById('new-pkg-name').value;
                    if(!pkgTitle) throw new Error("Podaj nazwƒô nowego pakietu!");
                    
                    const { data: newPkg, error: pkgErr } = await _supabase
                        .from('packages').insert({ title: pkgTitle }).select().single();
                    if(pkgErr) throw pkgErr;
                    packageId = newPkg.id;
                } else {
                    packageId = document.getElementById('existing-pkg-select').value;
                    if(!packageId) throw new Error("Wybierz istniejƒÖcy pakiet!");
                }

                // 2. Create Course (Linked to Package)
                const { data: course, error: cErr } = await _supabase
                    .from('courses')
                    .insert({
                        title: courseData.title,
                        description: courseData.description,
                        author_id: courseData.author_id,
                        type: 'course',
                        package_id: packageId // LINKING HERE
                    })
                    .select()
                    .single();

                if (cErr) throw cErr;

                // 3. Lessons Loop
                for (let i = 0; i < lessons.length; i++) {
                    const l = lessons[i];
                    const { data: savedLesson, error: lErr } = await _supabase
                        .from('lessons').insert({ course_id: course.id, title: l.title, order_index: i + 1 }).select().single();
                    if (lErr) throw lErr;

                    const { data: content, error: ctErr } = await _supabase
                        .from('content_text_blocks').insert({ content: l.content }).select().single();
                    
                    await _supabase.from('lesson_components').insert({
                        lesson_id: savedLesson.id, order_index: 1, component_type: 'text', content_text_block_id: content.id
                    });
                }

                alert("‚úÖ Kurs zapisany w pakiecie!");
                window.location.href = 'dashboard.html';

            } catch (err) {
                console.error(err);
                alert("B≈ÇƒÖd: " + err.message);
                btn.disabled = false;
                btn.innerHTML = "Zapisz wszystko";
            }
        }

        // --- EDITOR UI FUNCTIONS (Same as before) ---
        function addNewLesson() {
            const newId = Date.now();
            lessons.push({ id: newId, title: "Nowa lekcja", content: "<p>...</p>" });
            renderSidebar();
            selectLesson(newId);
        }
        function renderSidebar() {
            const list = document.getElementById('editor-lesson-list');
            list.innerHTML = '';
            lessons.forEach((l, index) => {
                const li = document.createElement('li');
                li.className = `lesson-item ${l.id === activeLessonId ? 'active' : ''}`;
                li.innerHTML = `<span>${index + 1}. ${l.title}</span> <span style="color:red;" onclick="removeLesson(event, ${l.id})">&times;</span>`;
                li.onclick = () => selectLesson(l.id);
                list.appendChild(li);
            });
        }
        function selectLesson(id) {
            activeLessonId = id;
            document.getElementById('no-selection-msg').style.display = 'none';
            document.getElementById('active-lesson-editor').style.display = 'block';
            const lesson = lessons.find(l => l.id === id);
            document.getElementById('lesson-title-input').value = lesson.title;
            document.getElementById('lesson-content-input').value = lesson.content;
            renderSidebar();
        }
        function removeLesson(e, id) {
            e.stopPropagation();
            if(confirm("UsunƒÖƒá?")) {
                lessons = lessons.filter(l => l.id !== id);
                if (activeLessonId === id) { activeLessonId = null; document.getElementById('active-lesson-editor').style.display = 'none'; }
                renderSidebar();
            }
        }
        function updateCourseState() {
            courseData.title = document.getElementById('course-title-input').value;
            courseData.description = document.getElementById('course-desc-input').value;
        }
        function updateLessonState() {
            if (!activeLessonId) return;
            const lesson = lessons.find(l => l.id === activeLessonId);
            lesson.title = document.getElementById('lesson-title-input').value;
            lesson.content = document.getElementById('lesson-content-input').value;
            renderSidebar();
        }
    </script>
</body>
</html>
