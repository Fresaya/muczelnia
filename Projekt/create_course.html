<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Edytor Kursu</title>
    <link rel="stylesheet" href="style.css">
<style>
    /* --- NOWE STYLE DLA EDYTORA (LIGHT & DARK MODE) --- */

    /* Zak≈Çadki Edit / Preview */
    .editor-tabs { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 15px; 
        border-bottom: 1px solid var(--border-color); /* U≈ºywamy zmiennej */
        padding-bottom: 10px; 
    }
    .tab-btn { 
        background: none; 
        border: none; 
        font-size: 14px; 
        font-weight: 600; 
        color: var(--text-muted); /* U≈ºywamy zmiennej */
        cursor: pointer; 
        padding: 5px 10px; 
        border-radius: 5px; 
        transition: 0.2s; 
    }
    .tab-btn:hover { 
        color: var(--text-main); 
        background: var(--hover-bg); /* U≈ºywamy zmiennej */
    }
    .tab-btn.active { 
        color: var(--accent-color); 
        background: rgba(240, 74, 74, 0.1); 
    }

    /* Pasek narzƒôdzi (Toolbar) */
    .editor-toolbar { 
        display: flex; 
        gap: 5px; 
        background: var(--hover-bg); /* Jasny szary w light, ciemniejszy w dark */
        border: 1px solid var(--border-color); 
        border-bottom: none; 
        padding: 8px; 
        border-radius: 8px 8px 0 0; 
    }
    .tool-btn { 
        background: var(--panel-bg); 
        border: 1px solid var(--border-color); 
        border-radius: 4px; 
        width: 30px; 
        height: 30px; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-weight: bold; 
        font-family: serif; 
        font-size: 16px; 
        color: var(--text-main); 
        transition: background 0.2s, border-color 0.2s;
    }
    .tool-btn:hover { 
        background: var(--hover-bg); 
        border-color: #bbb; 
    }

    /* Pole tekstowe zintegrowane z toolbarem */
    .edit-area { 
        border-top-left-radius: 0; 
        border-top-right-radius: 0; 
        margin-top: 0; 
        min-height: 400px; 
        font-family: 'Courier New', monospace; 
        font-size: 14px; 
        background-color: var(--panel-bg);
        color: var(--text-main);
        border-color: var(--border-color);
    }
    .edit-area:focus {
        border-color: var(--accent-color);
        outline: none;
    }

    /* PodglƒÖd (Preview Box) */
    .preview-box { 
        display: none; 
        min-height: 400px; 
        padding: 20px; 
        border: 1px solid var(--border-color); 
        background: var(--panel-bg); 
        border-radius: 12px; 
        line-height: 1.6; 
        color: var(--text-main);
    }
    .preview-box h2 { 
        border-bottom: 1px solid var(--border-color); 
        padding-bottom: 10px; 
        margin-top: 0; 
        color: var(--text-main);
    }
    
    /* Drag & Drop na li≈õcie */
    .lesson-item { 
        cursor: grab; 
        user-select: none; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        color: var(--text-main);
    }
    .lesson-item:active { cursor: grabbing; }
    .lesson-item.dragging { 
        opacity: 0.5; 
        background: var(--hover-bg); 
        border: 1px dashed var(--text-muted); 
    }
    .drag-handle { margin-right: 10px; color: var(--text-muted); cursor: grab; }

    /* Du≈ºy przycisk dodawania w g≈Ç√≥wnym oknie */
    .big-add-btn { 
        display: inline-block; 
        margin-top: 20px; 
        padding: 15px 30px; 
        border: 2px dashed var(--accent-color); 
        color: var(--accent-color); 
        border-radius: 12px; 
        font-weight: bold; 
        cursor: pointer; 
        transition: 0.2s; 
        font-size: 16px; 
        background: var(--panel-bg); 
    }
    .big-add-btn:hover { 
        background: rgba(240, 74, 74, 0.05); 
        transform: scale(1.02); 
    }

    /* --- SPECIFIC DARK MODE OVERRIDES --- */
    /* Te style aktywujƒÖ siƒô tylko w ciemnym motywie, naprawiajƒÖc kontrast */
    @media (prefers-color-scheme: dark) {
        .editor-toolbar {
            background-color: #2a2a2a; /* Ciemniejszy ni≈º panel, ja≈õniejszy ni≈º t≈Ço */
            border-color: #444;
        }
        
        .tool-btn {
            background-color: #333;
            border-color: #444;
            color: #e0e0e0;
        }
        
        .tool-btn:hover {
            background-color: #444;
            border-color: #666;
        }
        
        /* Poprawka dla pola tekstowego w trybie ciemnym */
        .edit-area {
            background-color: #1e1e1e; /* Panel BG */
            color: #eee;
            border-color: #444;
        }

        .lesson-item.dragging {
            background: #333;
        }

        .big-add-btn:hover {
            background-color: rgba(240, 74, 74, 0.1);
        }
    }
</style>
</head>
<body>

    <div class="course-layout">
        <aside class="course-sidebar" id="course-sidebar">
            <div class="sidebar-header">
                <!-- FIX: Link wraca do panelu admina -->
                <a href="admin_content.html" class="back-btn">‚Üê Anuluj</a>
                <h3 style="margin:0; font-size:16px; margin-left: 10px;">Lekcje</h3>
            </div>
            
            <ul class="lesson-list" id="editor-lesson-list"></ul>

            <div class="add-lesson-btn" onclick="addNewLesson()">+ Nowa Lekcja</div>
        </aside>

<main class="course-content">
    <div class="lesson-card">
        <div style="border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 20px;">
            <label style="font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold;">Tytu≈Ç Kursu</label>
            <input type="text" id="course-title-input" class="edit-input title-input" placeholder="Wpisz nazwƒô kursu..." oninput="updateCourseState()">
            <textarea id="course-desc-input" class="edit-input" style="min-height: 60px; margin-top:10px;" placeholder="Kr√≥tki opis kursu..." oninput="updateCourseState()"></textarea>
        </div>

        <div id="active-lesson-editor" style="display: none;">
            
            <div class="editor-tabs">
                <button class="tab-btn active" id="tab-edit" onclick="toggleMode('edit')">‚úèÔ∏è Edycja</button>
                <button class="tab-btn" id="tab-preview" onclick="toggleMode('preview')">üëÅÔ∏è PodglƒÖd (Preview)</button>
            </div>

            <div id="mode-edit">
                <input type="text" id="lesson-title-input" class="edit-input title-input" placeholder="Tytu≈Ç lekcji" oninput="updateLessonState()" style="margin-bottom: 15px;">
                
                <div class="editor-toolbar">
                    <button class="tool-btn" onclick="formatText('bold')" title="Pogrubienie">B</button>
                    <button class="tool-btn" onclick="formatText('italic')" title="Kursywa" style="font-style:italic;">I</button>
                    <button class="tool-btn" onclick="formatText('underline')" title="Podkre≈õlenie" style="text-decoration:underline;">U</button>
                    <button class="tool-btn" onclick="formatText('h2')" title="Nag≈Ç√≥wek">H2</button>
                    <button class="tool-btn" onclick="formatText('list')" title="Lista">‚ò∞</button>
                </div>

                <textarea id="lesson-content-input" class="edit-area" placeholder="Tre≈õƒá lekcji... (Mo≈ºesz u≈ºywaƒá HTML)" oninput="updateLessonState()"></textarea>
            </div>

            <div id="mode-preview" class="preview-box">
                </div>
            
            <div style="margin-top: 15px; text-align: right; color: #888; font-size: 12px;">
                * Kolejno≈õƒá lekcji zapisuje siƒô automatycznie.
            </div>
        </div>

        <div id="no-selection-msg" style="text-align: center; color: #888; padding: 40px;">
            <h3>ZarzƒÖdzanie Tre≈õciƒÖ</h3>
            <p>Wybierz lekcjƒô z menu po lewej, aby edytowaƒá.</p>
            <div class="big-add-btn" onclick="addNewLesson()">+ Dodaj nowƒÖ lekcjƒô</div>
        </div>
    </div>
</main>
    </div>

    <button class="save-course-fab" onclick="handleSaveClick()" id="preSaveBtn">
        <span>üíæ Zapisz Zmiany</span>
    </button>

    <!-- PACKAGE MODAL -->
    <div class="modal-overlay" id="packageModal"><div class="modal-window"><div class="modal-header"><h3 class="modal-title">Zapisz</h3><span class="close-modal" onclick="closeModal()">&times;</span></div><div style="margin-bottom: 20px;"><label style="display:block; margin-bottom:10px;"><input type="radio" name="pkgOption" value="new" checked onchange="togglePkgInputs()"> Nowy Pakiet</label><div id="new-pkg-inputs" style="padding-left: 20px;"><input type="text" id="new-pkg-name" class="edit-input" placeholder="Nazwa"><select id="new-pkg-level" class="edit-input" style="margin-top:5px;"><option value="1">Podstawowa</option><option value="2">≈örednia</option><option value="3">Wy≈ºsza</option></select></div><label style="display:block; margin-top:15px;"><input type="radio" name="pkgOption" value="existing" onchange="togglePkgInputs()"> IstniejƒÖcy</label><div id="existing-pkg-inputs" style="padding-left: 20px; display:none;"><select id="existing-pkg-select" class="edit-input"></select></div></div><button class="login-button full-width-btn" onclick="saveCourseToDB(true)" id="finalSaveBtn">Zapisz</button></div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg'; 
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id'); 

    let courseData = { title: "", description: "", author_id: null };
    let lessons = []; 
    let activeLessonId = null;
    let deletedLessonIds = []; 
    let dragStartIndex = null; // Do przesuwania

    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) { window.location.href = 'login.html'; return; }
        courseData.author_id = session.user.id;

        const { data: profile } = await _supabase.from('users').select('role').eq('id', session.user.id).single();
        if (!profile || profile.role !== 'admin') { alert("Brak uprawnie≈Ñ."); window.location.href = 'dashboard.html'; return; }

        if (editId) {
            document.title = "Edycja Kursu";
            await loadCourseData(editId);
        }
    });

    // --- ≈ÅADOWANIE DANYCH ---
    async function loadCourseData(id) {
        const { data: course } = await _supabase.from('courses').select('*').eq('id', id).single();
        if (!course) return;

        courseData.title = course.title;
        courseData.description = course.description;
        
        document.getElementById('course-title-input').value = course.title;
        document.getElementById('course-desc-input').value = course.description || "";

        // Pobranie lekcji
        const { data: dbLessons } = await _supabase.from('lessons')
            .select(`id, title, order_index, lesson_components ( content_text_blocks ( content ) )`)
            .eq('course_id', id)
            .order('order_index', { ascending: true });

        if (dbLessons && dbLessons.length > 0) {
            lessons = dbLessons.map(l => {
                let contentText = "";
                if (l.lesson_components?.[0]?.content_text_blocks) {
                    contentText = l.lesson_components[0].content_text_blocks.content;
                }
                return { id: l.id, title: l.title, content: contentText };
            });
            renderSidebar();
            selectLesson(lessons[0].id);
        }
    }

    // --- DRAG & DROP + RENDER SIDEBAR ---
    function renderSidebar() {
        const list = document.getElementById('editor-lesson-list');
        list.innerHTML = '';
        
        lessons.forEach((l, index) => {
            const li = document.createElement('li');
            li.className = `lesson-item ${l.id === activeLessonId ? 'active' : ''}`;
            li.draggable = true; // W≈ÇƒÖczamy przeciƒÖganie
            li.dataset.index = index;

            // Uchwyt i Tytu≈Ç
            li.innerHTML = `
                <div style="display:flex; align-items:center; width:100%;">
                    <span class="drag-handle">‚ò∞</span>
                    <span style="flex-grow:1;">${index + 1}. ${l.title}</span>
                </div>
                <span style="color:red; cursor:pointer; padding:5px;" onclick="removeLesson(event, '${l.id}')">&times;</span>
            `;

            // Zdarzenia Drag & Drop
            li.addEventListener('dragstart', dragStart);
            li.addEventListener('dragover', dragOver);
            li.addEventListener('drop', dragDrop);
            li.addEventListener('dragenter', dragEnter);
            li.addEventListener('dragleave', dragLeave);
            
            // Klikniƒôcie (wyb√≥r)
            li.addEventListener('click', (e) => {
               // Ignoruj klikniƒôcie je≈õli to by≈Ç drag lub usuwanie
               if(e.target.tagName !== 'SPAN' || e.target.innerText !== '√ó') selectLesson(l.id);
            });

            list.appendChild(li);
        });
    }

    // --- LOGIKA DRAG & DROP ---
    function dragStart() {
        dragStartIndex = +this.dataset.index;
        this.classList.add('dragging');
    }
    function dragOver(e) { e.preventDefault(); }
    function dragEnter() { this.classList.add('active'); }
    function dragLeave() { this.classList.remove('active'); }
    function dragDrop() {
        const dragEndIndex = +this.dataset.index;
        swapItems(dragStartIndex, dragEndIndex);
        this.classList.remove('active');
        document.querySelector('.dragging').classList.remove('dragging');
    }
    function swapItems(fromIndex, toIndex) {
        const item = lessons[fromIndex];
        lessons.splice(fromIndex, 1);
        lessons.splice(toIndex, 0, item);
        renderSidebar(); // Prze≈Çaduj listƒô (z nowymi indeksami)
    }

    // --- PODSTAWOWE FUNKCJE EDYTORA ---
    function addNewLesson() {
        const tempId = 'new-' + Date.now(); 
        lessons.push({ id: tempId, title: "Nowa lekcja", content: "" });
        renderSidebar(); selectLesson(tempId);
    }

    function selectLesson(id) {
        activeLessonId = id;
        document.getElementById('no-selection-msg').style.display = 'none';
        document.getElementById('active-lesson-editor').style.display = 'block';
        
        // Domy≈õlnie tryb edycji
        toggleMode('edit');

        const l = lessons.find(x => x.id === id);
        document.getElementById('lesson-title-input').value = l.title;
        document.getElementById('lesson-content-input').value = l.content;
        renderSidebar();
    }

    function removeLesson(e, id) {
        e.stopPropagation();
        if(!confirm("UsunƒÖƒá lekcjƒô?")) return;
        if (typeof id !== 'string' || !id.startsWith('new-')) deletedLessonIds.push(id);
        lessons = lessons.filter(l => l.id != id);
        if (activeLessonId == id) { 
            activeLessonId = null; 
            document.getElementById('active-lesson-editor').style.display = 'none'; 
            document.getElementById('no-selection-msg').style.display = 'block'; 
        }
        renderSidebar();
    }

    function updateCourseState() {
        courseData.title = document.getElementById('course-title-input').value;
        courseData.description = document.getElementById('course-desc-input').value;
    }

    function updateLessonState() {
        if (!activeLessonId) return;
        const l = lessons.find(x => x.id === activeLessonId);
        l.title = document.getElementById('lesson-title-input').value;
        l.content = document.getElementById('lesson-content-input').value;
        // Od≈õwie≈º tytu≈Ç na li≈õcie, ale nie renderuj ca≈Çej listy (≈ºeby nie psuƒá focusu inputa)
        const activeLi = document.querySelector('.lesson-item.active span[style="flex-grow:1;"]');
        if(activeLi) activeLi.innerText = `${lessons.indexOf(l) + 1}. ${l.title}`;
    }

    // --- TOOLBAR & PREVIEW ---
    function toggleMode(mode) {
        const editDiv = document.getElementById('mode-edit');
        const prevDiv = document.getElementById('mode-preview');
        const btnEdit = document.getElementById('tab-edit');
        const btnPrev = document.getElementById('tab-preview');

        if (mode === 'preview') {
            // Render HTML
            const l = lessons.find(x => x.id === activeLessonId);
            const title = document.getElementById('lesson-title-input').value;
            const content = document.getElementById('lesson-content-input').value;
            
            prevDiv.innerHTML = `<h2 style="color:#f04a4a;">${title}</h2><div>${content || '<i>(Brak tre≈õci)</i>'}</div>`;
            
            editDiv.style.display = 'none';
            prevDiv.style.display = 'block';
            btnEdit.classList.remove('active');
            btnPrev.classList.add('active');
        } else {
            editDiv.style.display = 'block';
            prevDiv.style.display = 'none';
            btnEdit.classList.add('active');
            btnPrev.classList.remove('active');
        }
    }

    function formatText(cmd) {
        const area = document.getElementById('lesson-content-input');
        const start = area.selectionStart;
        const end = area.selectionEnd;
        const text = area.value;
        const selected = text.substring(start, end);
        
        let before = text.substring(0, start);
        let after = text.substring(end);
        let insertion = "";

        switch(cmd) {
            case 'bold': insertion = `<b>${selected || 'tekst'}</b>`; break;
            case 'italic': insertion = `<i>${selected || 'tekst'}</i>`; break;
            case 'underline': insertion = `<u>${selected || 'tekst'}</u>`; break;
            case 'h2': insertion = `\n<h2>${selected || 'Nag≈Ç√≥wek'}</h2>\n`; break;
            case 'list': insertion = `\n<ul>\n  <li>${selected || 'Element listy'}</li>\n</ul>\n`; break;
        }

        area.value = before + insertion + after;
        updateLessonState(); // Zapisz do pamiƒôci
        area.focus();
    }

    // --- ZAPISYWANIE (BEZ ZMIAN W LOGICE) ---
    function handleSaveClick() {
        if (!courseData.title) return alert("Podaj tytu≈Ç!");
        if (lessons.length === 0) return alert("Dodaj lekcje!");
        if (editId) saveCourseToDB(false);
        else { document.getElementById('packageModal').classList.add('active'); openPackageModal(); }
    }

    async function openPackageModal() {
        document.getElementById('new-pkg-name').value = courseData.title;
        const s = document.getElementById('existing-pkg-select'); 
        s.innerHTML = '<option>≈Åadowanie...</option>';
        const { data } = await _supabase.from('packages').select('*').order('created_at', { ascending: false });
        s.innerHTML = '<option value="" disabled selected>-- Wybierz --</option>';
        data.forEach(p => s.add(new Option(p.title, p.id)));
    }
    function closeModal() { document.getElementById('packageModal').classList.remove('active'); }
    function togglePkgInputs() { 
        const n = document.querySelector('input[name="pkgOption"]:checked').value === 'new';
        document.getElementById('new-pkg-inputs').style.display = n ? 'block' : 'none';
        document.getElementById('existing-pkg-inputs').style.display = n ? 'none' : 'block';
    }

    async function saveCourseToDB(isNew) {
        const btn = isNew ? document.getElementById('finalSaveBtn') : document.getElementById('preSaveBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = "‚è≥ Zapisywanie...";

        try {
            let courseId = editId;

            // 1. Kurs
            if (isNew) {
                let packageId = null;
                const pkgOpt = document.querySelector('input[name="pkgOption"]:checked').value;
                if (pkgOpt === 'new') {
                    const { data: pkg } = await _supabase.from('packages').insert({ 
                        title: document.getElementById('new-pkg-name').value, 
                        level: document.getElementById('new-pkg-level').value 
                    }).select().single();
                    packageId = pkg.id;
                } else {
                    packageId = document.getElementById('existing-pkg-select').value;
                }
                const { data: newC, error } = await _supabase.from('courses').insert({
                    title: courseData.title, description: courseData.description, author_id: courseData.author_id, type: 'course', package_id: packageId
                }).select().single();
                if(error) throw error;
                courseId = newC.id;
            } else {
                await _supabase.from('courses').update({ title: courseData.title, description: courseData.description }).eq('id', courseId);
            }

            // 2. Usuwanie
            if (deletedLessonIds.length > 0) await _supabase.from('lessons').delete().in('id', deletedLessonIds);

            // 3. Zapis lekcji (ZACHOWUJE KOLEJNO≈öƒÜ Z TABLICY lessons)
            for (let i = 0; i < lessons.length; i++) {
                const l = lessons[i];
                let lessonId = l.id;
                const isTemp = String(l.id).startsWith('new-');

                if (isTemp) {
                    const { data: insL } = await _supabase.from('lessons').insert({
                        course_id: courseId, title: l.title, order_index: i + 1 
                    }).select().single();
                    lessonId = insL.id;
                    const { data: content } = await _supabase.from('content_text_blocks').insert({ content: l.content }).select().single();
                    await _supabase.from('lesson_components').insert({
                        lesson_id: lessonId, order_index: 1, component_type: 'text', content_text_block_id: content.id
                    });
                } else {
                    // Update: WA≈ªNE - aktualizujemy te≈º order_index
                    await _supabase.from('lessons').update({ title: l.title, order_index: i + 1 }).eq('id', lessonId);
                    
                    const { data: comp } = await _supabase.from('lesson_components').select('content_text_block_id').eq('lesson_id', lessonId).single();
                    if (comp) {
                        await _supabase.from('content_text_blocks').update({ content: l.content }).eq('id', comp.content_text_block_id);
                    }
                }
            }
            alert("‚úÖ Zapisano pomy≈õlnie!");
            window.location.href = 'admin_content.html';
        } catch (err) {
            console.error(err);
            alert("B≈ÇƒÖd: " + err.message);
        } finally {
            btn.disabled = false; btn.innerHTML = originalText;
        }
    }
</script>
</body>
</html>
