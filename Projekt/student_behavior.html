<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Zachowanie</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .points-summary {
            /* ZMIANA: Solidny ciemnoszary kolor tła zamiast gradientu */ 
            background: #4b5563; 
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            /* ZMIANA: Cień bardziej neutralny */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .points-value { font-size: 3rem; font-weight: 800; display: block; margin: 10px 0; }
        
        .remarks-list { display: flex; flex-direction: column; gap: 15px; }
        .remark-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .remark-positive { border-left: 5px solid #10b981; }
        .remark-negative { border-left: 5px solid #ef4444; }
        .points-badge { font-weight: bold; padding: 5px 10px; border-radius: 6px; }
        .points-pos { background: #d1fae5; color: #047857; }
        .points-neg { background: #fee2e2; color: #b91c1c; }

        .parent-controls {
            margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.02);
            border-radius: 8px; display: none;
        }
        .child-select {
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color);
            font-size: 14px; min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="student_behavior.html" class="nav-link active"><span>Zachowanie</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <h1>Zachowanie i Uwagi</h1>
                    <p>Szczegóły punktacji z zachowania.</p>
                </div>
            </div>

            <div id="parent-controls" class="parent-controls">
                <label for="childSelect"><strong>Wybierz dziecko:</strong> </label>
                <select id="childSelect" class="child-select" onchange="changeChild()">
                    <option value="" disabled selected>Ładowanie...</option>
                </select>
            </div>

            <div class="points-summary">
                <span>Aktualna liczba punktów</span>
                <span class="points-value" id="total-points">...</span>
                <span id="behavior-grade-prediction">Ładowanie...</span>
            </div>

            <h3>Ostatnie uwagi</h3>
            <div class="remarks-list" id="remarks-container">
                </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const { data: userDetails } = await _supabase.from('users').select('*').eq('id', session.user.id).single();
            currentUser = userDetails;

            if (currentUser.role === 'parent') {
                setupParentView();
            } else {
                fetchBehavior(currentUser.id, currentUser.behavior_points);
            }
        }

        async function setupParentView() {
            document.getElementById('parent-controls').style.display = 'block';
            
            const { data: relations } = await _supabase.from('parent_children').select('child_id').eq('parent_id', currentUser.id);
            if (!relations || relations.length === 0) return;

            const childIds = relations.map(r => r.child_id);
            const { data: children } = await _supabase.from('users').select('id, username, behavior_points').in('id', childIds);

            const select = document.getElementById('childSelect');
            select.innerHTML = '';
            
            window.childDataCache = children;

            children.forEach(child => {
                const option = document.createElement('option');
                option.value = child.id;
                option.textContent = child.username;
                select.appendChild(option);
            });

            if (children.length > 0) {
                select.value = children[0].id;
                fetchBehavior(children[0].id, children[0].behavior_points);
            }
        }

        function changeChild() {
            const childId = document.getElementById('childSelect').value;
            const child = window.childDataCache.find(c => c.id === childId);
            fetchBehavior(childId, child ? child.behavior_points : 100);
        }

        async function fetchBehavior(studentId, currentPoints) {
            document.getElementById('total-points').innerText = currentPoints !== undefined ? currentPoints : '100';
            
            let grade = "Wzorowe";
            if(currentPoints < 50) grade = "Nieodpowiednie";
            else if(currentPoints < 80) grade = "Poprawne";
            else if(currentPoints < 150) grade = "Dobre";
            else grade = "Wzorowe";
            
            document.getElementById('behavior-grade-prediction').innerText = `Przewidywana ocena: ${grade}`;

            const container = document.getElementById('remarks-container');
            container.innerHTML = '<p>Ładowanie uwag...</p>';

            const { data: remarks, error } = await _supabase
                .from('remarks')
                .select('*')
                .eq('student_id', studentId)
                .order('created_at', { ascending: false });

            if (error) { console.error(error); return; }

            container.innerHTML = '';
            if (!remarks || remarks.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted)">Brak uwag w systemie.</p>';
                return;
            }

            remarks.forEach(rem => {
                const isPositive = rem.points >= 0;
                const pointsClass = isPositive ? 'points-pos' : 'points-neg';
                const cardClass = isPositive ? 'remark-positive' : 'remark-negative';
                const sign = isPositive ? '+' : '';
                
                const html = `
                    <div class="remark-card ${cardClass}">
                        <div>
                            <div style="font-weight:600; font-size:1.1rem;">${rem.category || 'Uwaga'}</div>
                            <div style="color:var(--text-muted); font-size:0.9rem;">${rem.description}</div>
                            <div style="font-size:0.8rem; margin-top:5px; color:#888;">${new Date(rem.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="points-badge ${pointsClass}">${sign}${rem.points} pkt</div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
