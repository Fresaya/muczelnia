<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Moje Kursy</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <!-- Active state for this page -->
                    <li class="nav-item"><a href="#" class="nav-link active"><span>Moje Kursy</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:#888; font-size:14px;">← Wróć do pulpitu</a>
                    <h1>Moje Kursy</h1>
                    <p>Lista przedmiotów przypisanych do Twojej klasy.</p>
                </div>
            </div>

            <!-- DYNAMIC COURSE GRID -->
            <div class="dashboard-grid" id="courses-grid">
                <div style="grid-column: 1/-1; text-align:center; color:#888;">Ładowanie kursów...</div>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card">
                <!-- Avatar Trigger -->
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje"></div>
                
                <!-- Dropdown Menu -->
                <div class="dropdown-menu" id="profileDropdown">
                    <div class="dropdown-item" id="logoutBtn">
                        <div class="icon-logout"></div>
                        Wyloguj się
                    </div>
                </div>

                <h2 class="profile-name" id="profile-name-display">...</h2>
                <p class="profile-id" id="profile-school-display" style="font-size:12px; color:#888; margin-top:2px;">...</p>
                <p class="profile-id" id="profile-class-display" style="font-size:12px; color:#555; font-weight:bold; margin-top:2px;">...</p>
            </div>
        </aside>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const userId = session.user.id;

            // 1. Fetch Profile (Get User's Class ID)
            const { data: profile } = await _supabase
                .from('users')
                .select('username, school_id, class_id, schools(name), classes(name)')
                .eq('id', userId)
                .single();
            
            if (profile) {
                document.getElementById('profile-name-display').textContent = profile.username;
                if(profile.schools) {
                    document.getElementById('profile-school-display').textContent = profile.schools.name;
                }
                if(profile.classes) {
                    document.getElementById('profile-class-display').textContent = `Klasa: ${profile.classes.name}`;
                } else {
                    document.getElementById('profile-class-display').textContent = "Brak przypisanej klasy";
                }
            }

            // If user has no class (e.g. fresh account or admin), show empty or all
            if (!profile.class_id && profile.role === 'student') {
                document.getElementById('courses-grid').innerHTML = `
                    <div class="widget-tile" style="grid-column:1/-1; text-align:center; padding:50px;">
                        <h3>Brak klasy</h3>
                        <p style="color:#888;">Poproś administratora o przypisanie Cię do klasy.</p>
                    </div>`;
                return;
            }

            // 2. FETCH COURSES VIA JUNCTION TABLE
            // Query: "Give me rows from course_classes where class_id is MY class, and include the course details"
            let query = _supabase
                .from('course_classes')
                .select('course_id, courses ( id, title, description )');
            
            // If student, filter by their class. If admin, maybe fetch all unique? 
            // For now, let's show courses for the user's class context.
            // If admin has no class_id, this might return empty, so let's handle admin separately or require class.
            
            if (profile.role === 'admin' || profile.role === 'manager') {
                 // For Admins/Managers, let's just show ALL courses for now (or distinct ones)
                 // Or keep it simple: fetch directly from courses table
                 const { data: allCourses } = await _supabase.from('courses').select('id, title, description');
                 renderCourses(allCourses ? allCourses.map(c => ({ courses: c })) : []); // Adapter format
                 return;
            } else {
                query = query.eq('class_id', profile.class_id);
            }

            const { data: linkedCourses, error } = await query;

            renderCourses(linkedCourses);

            function renderCourses(data) {
                const gridContainer = document.getElementById('courses-grid');
                gridContainer.innerHTML = ''; 

                if (data && data.length > 0) {
                    data.forEach(item => {
                        // The structure is { course_id: 1, courses: { title: '...', ... } }
                        const course = item.courses;
                        if (!course) return;

                        const tile = document.createElement('a');
                        tile.href = `course.html?id=${course.id}`; 
                        tile.className = 'widget-tile';
                        
                        // NO PROGRESS BAR HERE
                        tile.innerHTML = `
                            <div class="widget-icon icon-course-active"></div>
                            <h3>${course.title}</h3>
                            <div class="course-meta" style="margin-top:15px;">Przejdź do kursu →</div>
                        `;
                        gridContainer.appendChild(tile);
                    });
                } else {
                     gridContainer.innerHTML += `
                        <div class="widget-tile" style="grid-column:1/-1; text-align:center; padding:50px;">
                            <h3>Brak kursów</h3>
                            <p style="color:#888;">Twoja klasa nie ma jeszcze przypisanych kursów.</p>
                        </div>`;
                }
            }

            // Dropdown & Logout Logic
            const avatarTrigger = document.getElementById('avatarTrigger');
            const dropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');

            if(avatarTrigger && dropdown) {
                avatarTrigger.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
            }
            window.addEventListener('click', () => {
                if (dropdown && dropdown.classList.contains('show')) dropdown.classList.remove('show');
            });
            if(logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await _supabase.auth.signOut();
                    window.location.href = 'login.html';
                });
            }
        });
    </script>
</body>
</html>
