<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Plan Zajęć</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <style>
        /* --- STYLE PLANU ZAJĘĆ --- */
        .schedule-container { background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow-x: auto; }
        .schedule-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .schedule-table th, .schedule-table td { padding: 10px; text-align: center; border: 1px solid var(--border-color); }
        .schedule-table th { background: rgba(0,0,0,0.02); color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        .schedule-table td { height: 60px; vertical-align: middle; font-size: 13px; }
        .hour-col { font-weight: bold; color: var(--text-muted); width: 100px; }
        .subject-block { display: flex; flex-direction: column; gap: 2px; }
        .subject-name { font-weight: 600; color: var(--text-main); }
        .subject-info { font-size: 10px; color: var(--text-muted); background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; display: inline-block; margin: 0 auto; }
        .editable:hover { background-color: #f0f8ff; cursor: pointer; outline: 1px dashed #007bff; }
        .class-selector-container { margin-bottom: 15px; display: inline-flex; align-items: center; gap: 10px; }
        .class-select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-main); font-size: 14px; }

        /* --- STYLE SIDEBARA (Skopiowane z Dashboardu) --- */
        .widget-icon { display: flex; align-items: center; justify-content: center; background: none !important; }
        
        #student-sidebar-content { display: flex; flex-direction: column; gap: 30px; width: 100%; margin-top: 30px;}
        .sidebar-section { width: 100%; display: block; }
        .sidebar-section + .sidebar-section { border-top: 1px solid var(--border-color); padding-top: 20px; }
        
        .sidebar-title { font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: bold; margin-bottom: 15px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-list-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; }
        .sidebar-list-date { font-weight: bold; color: var(--accent-color); margin-right: 10px; font-size: 12px; min-width: 35px; }
        .sidebar-list-content { flex: 1; color: var(--text-main); line-height: 1.3; font-size: 13px; }
        
        .sidebar-grade-circle { 
            width: 30px; height: 30px; border-radius: 50%; background: var(--hover-bg); 
            border: 2px solid var(--border-color); display: flex; align-items: center; 
            justify-content: center; font-weight: bold; font-size: 14px; margin-right: 10px; color: var(--text-main);
        }
        .empty-sidebar { font-size: 12px; color: var(--text-muted); font-style: italic; }

        @media (prefers-color-scheme: dark) {
            .sidebar-grade-circle { background: #333; border-color: #555; color: #fff; }
        }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="schedule.html" class="nav-link active"><span>Plan Zajęć</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">← Wróć do pulpitu</a>
                    <h1>Plan Zajęć</h1>
                    
                    <div id="teacher-controls" style="display:none; margin-top: 10px;">
                        <div class="class-selector-container">
                            <label for="classSelect">Wybierz klasę do edycji:</label>
                            <select id="classSelect" class="class-select" onchange="changeClass()">
                                <option value="" disabled selected>Ładowanie klas...</option>
                            </select>
                        </div>
                    </div>
                    <p id="schedule-info-text">Ładowanie planu...</p>
                </div>
            </div>

            <div class="schedule-container">
                <table class="schedule-table">
                    <thead>
                        <tr><th>Godzina</th><th>Poniedziałek</th><th>Wtorek</th><th>Środa</th><th>Czwartek</th><th>Piątek</th></tr>
                    </thead>
                    <tbody id="schedule-body"></tbody>
                </table>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card" style="position: relative;">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje" style="cursor: pointer;"></div> 
            
                <div id="profileDropdown" style="display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); border: 1px solid var(--border-color); padding: 5px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; width: 180px; text-align: left;">
                    
                    <div class="dropdown-item" id="changePassBtn" style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                        <div class="widget-icon" style="width:20px;height:20px;"><span class="material-symbols-outlined" style="font-size:18px">lock_reset</span></div> Zmień hasło
                    </div>
                    
                    <div class="dropdown-item" id="logoutBtn" style="padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: red; font-size: 13px;">
                        <div class="widget-icon" style="width:20px;height:20px;"><span class="material-symbols-outlined" style="font-size:18px">logout</span></div> Wyloguj się
                    </div>
            
                </div>
            
                <h2 class="profile-name" id="profile-name-display" style="margin-top: 15px;">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
                <p style="font-size: 13px; color: #888; margin-top: 5px; max-width: 200px; line-height: 1.4;" id="profile-school-display"></p>
            </div>

            <div id="student-sidebar-content" style="display: none;">
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <span>NADCHODZĄCE</span>
                    </div>
                    <div id="sidebar-calendar-list">
                        <p class="empty-sidebar">Ładowanie...</p>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">OSTATNIE OCENY (7 DNI)</div>
                    <div id="sidebar-grades-list">
                        <p class="empty-sidebar">Ładowanie...</p>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">OSTATNIE UWAGI</div>
                    <div id="sidebar-remarks-list">
                        <p class="empty-sidebar">Ładowanie...</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentViewClassId = null;
        let isStaff = false; 

        function generateGrid() {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            for (let hour = 8; hour < 20; hour++) {
                const tr = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.className = 'hour-col';
                timeCell.innerHTML = `${hour.toString().padStart(2, '0')}:00<br>-<br>${hour.toString().padStart(2, '0')}:45`;
                tr.appendChild(timeCell);
                for (let day = 1; day <= 5; day++) {
                    const td = document.createElement('td');
                    td.dataset.day = day; td.dataset.hour = hour; td.id = `cell-${day}-${hour}`; td.innerHTML = '—';
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        async function init() {
            generateGrid();
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            // Pobieramy rozszerzone dane użytkownika do Sidebara
            const { data: userDetails } = await _supabase
                .from('users')
                .select('id, username, role, school_id, class_id, schools(name), classes(name)')
                .eq('id', session.user.id)
                .single();
                
            if (!userDetails) return;
            currentUser = userDetails;

            // --- OBSŁUGA SIDEBARA I PROFILU ---
            setupProfileCard(userDetails);
            setupSidebarEvents();

            isStaff = ['teacher', 'manager', 'admin'].includes(currentUser.role);

            if (isStaff) {
                await setupStaffView();
            } else {
                setupStudentView();
                // Jeśli uczeń -> załaduj dane do sidebara
                document.getElementById('student-sidebar-content').style.display = 'flex';
                loadSidebarCalendar(currentUser.id);
                loadSidebarGrades(currentUser.id);
                loadSidebarRemarks(currentUser.id);
            }
        }

        // --- FUNKCJE PROFILU I SIDEBARA ---
        function setupProfileCard(profile) {
            document.getElementById('profile-name-display').textContent = profile.username;
            const roleMap = { 'student': 'UCZEŃ', 'teacher': 'NAUCZYCIEL', 'manager': 'SEKRETARIAT', 'admin': 'ADMIN', 'lecturer': 'WYKŁADOWCA', 'parent': 'RODZIC' };
            document.getElementById('profile-role-display').textContent = (roleMap[profile.role] || profile.role).toUpperCase();
            
            let schoolInfo = "";
            if (profile.schools && profile.schools.name) schoolInfo = profile.schools.name;
            if (profile.classes && profile.classes.name) schoolInfo += `<br><span style="color:var(--accent-color); font-weight:bold;">${profile.classes.name}</span>`;
            document.getElementById('profile-school-display').innerHTML = schoolInfo;
        }

        function setupSidebarEvents() {
            document.getElementById('avatarTrigger').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                const menu = document.getElementById('profileDropdown');
                menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
            });
            window.addEventListener('click', () => { 
                document.getElementById('profileDropdown').style.display = 'none'; 
            });
            document.getElementById('logoutBtn').addEventListener('click', async () => { 
                await _supabase.auth.signOut(); 
                window.location.href = 'login.html'; 
            });
            document.getElementById('changePassBtn').addEventListener('click', () => {
                window.location.href = 'settings.html';
            });
        }

        async function loadSidebarCalendar(targetUserId) {
            const list = document.getElementById('sidebar-calendar-list');
            // Pobieramy ID klasy usera (mamy już w currentUser, ale dla pewności z bazy lub obiektu)
            if(!currentUser.class_id) { list.innerHTML = '<p class="empty-sidebar">Brak klasy.</p>'; return; }

            const today = new Date().toISOString().split('T')[0];
            const { data } = await _supabase.from('calendar_events')
                .select('title, event_date, subject_name')
                .eq('class_id', currentUser.class_id)
                .gte('event_date', today)
                .order('event_date', { ascending: true })
                .limit(3);
            
            list.innerHTML = '';
            if(!data || data.length === 0) { list.innerHTML = '<p class="empty-sidebar">Brak wydarzeń.</p>'; return; }
            
            data.forEach(e => {
                const d = new Date(e.event_date);
                const dateStr = `${d.getDate()}.${d.getMonth()+1}`;
                const subj = e.subject_name ? `<b>${e.subject_name}:</b> ` : '';
                list.innerHTML += `<div class="sidebar-list-item"><div class="sidebar-list-date">${dateStr}</div><div class="sidebar-list-content">${subj}${e.title}</div></div>`;
            });
        }

        async function loadSidebarGrades(targetUserId) {
            const list = document.getElementById('sidebar-grades-list');
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const { data: grades } = await _supabase.from('grades')
                .select('grade, packages(title)')
                .eq('user_id', targetUserId)
                .gte('created_at', weekAgo)
                .order('created_at', { ascending: false })
                .limit(5);

            list.innerHTML = '';
            if(!grades || grades.length === 0) { list.innerHTML = '<p class="empty-sidebar">Brak nowych ocen.</p>'; return; }

            grades.forEach(g => {
                const pkgTitle = g.packages ? g.packages.title : 'Inne';
                list.innerHTML += `<div class="sidebar-list-item"><div class="sidebar-grade-circle">${g.grade}</div><div class="sidebar-list-content">${pkgTitle}</div></div>`;
            });
        }

        async function loadSidebarRemarks(targetUserId) {
            const list = document.getElementById('sidebar-remarks-list');
            const { data: remarks } = await _supabase.from('remarks')
                .select('category, subject_name, created_at, points')
                .eq('student_id', targetUserId)
                .order('created_at', { ascending: false })
                .limit(3);

            list.innerHTML = '';
            if (!remarks || remarks.length === 0) { list.innerHTML = '<p class="empty-sidebar">Brak uwag.</p>'; return; }

            remarks.forEach(r => {
                const d = new Date(r.created_at);
                const dateStr = `${d.getDate()}.${d.getMonth() + 1}`;
                let pts = r.points || 0;
                let txt = pts > 0 ? "+" + pts : pts; 
                let color = pts > 0 ? '#4CAF50' : (pts < 0 ? '#F44336' : '#757575'); 

                list.innerHTML += `<div class="sidebar-list-item"><div class="sidebar-grade-circle" style="color:${color}; border-color:${color}; font-size:14px; width:35px; height:35px;">${txt}</div><div class="sidebar-list-content"><span style="font-size:11px; color:#888;">${dateStr}</span><br>${r.subject_name}</div></div>`;
            });
        }

        // --- FUNKCJE PLANU ZAJĘĆ ---
        function setupStudentView() {
            if (currentUser.class_id) {
                currentViewClassId = currentUser.class_id;
                document.getElementById('schedule-info-text').innerText = "Twój plan zajęć";
                fetchAndRenderSchedule(currentViewClassId);
            } else {
                document.getElementById('schedule-info-text').innerText = "Nie jesteś przypisany do żadnej klasy.";
            }
        }

        async function setupStaffView() {
            document.getElementById('teacher-controls').style.display = 'block';
            document.getElementById('schedule-info-text').innerText = "Wybierz klasę, aby edytować jej plan.";
            
            let query = _supabase.from('classes').select('id, name').order('name', { ascending: true });
            if (currentUser.role !== 'admin') query = query.eq('school_id', currentUser.school_id);

            const { data: classes } = await query;
            const select = document.getElementById('classSelect');
            select.innerHTML = ''; 

            if (classes && classes.length > 0) {
                classes.forEach(cls => { select.add(new Option(cls.name, cls.id)); });
                currentViewClassId = classes[0].id;
                select.value = currentViewClassId;
                fetchAndRenderSchedule(currentViewClassId);
                enableEditing(); 
            } else {
                select.innerHTML = '<option>Brak klas</option>';
            }
        }

        function changeClass() {
            currentViewClassId = document.getElementById('classSelect').value;
            generateGrid(); 
            if(isStaff) enableEditing(); 
            fetchAndRenderSchedule(currentViewClassId);
        }

        async function fetchAndRenderSchedule(classId) {
            const { data: scheduleData } = await _supabase.from('weekly_schedule').select('*').eq('class_id', classId);
            if (!scheduleData) return;

            scheduleData.forEach(item => {
                const hourPart = parseInt(item.start_time.split(':')[0]); 
                const cell = document.getElementById(`cell-${item.day_of_week}-${hourPart}`);
                if (cell) {
                    cell.innerHTML = `<div class="subject-block"><span class="subject-name">${item.subject_name}</span><span class="subject-info">${item.room || ''}</span></div>`;
                }
            });
        }

        function enableEditing() {
            const cells = document.querySelectorAll('td[data-day]');
            cells.forEach(cell => {
                cell.classList.add('editable');
                const newCell = cell.cloneNode(true);
                cell.parentNode.replaceChild(newCell, cell);
                newCell.onclick = async () => {
                    if (!currentViewClassId) return;
                    const currentName = newCell.querySelector('.subject-name')?.innerText || "";
                    const currentRoom = newCell.querySelector('.subject-info')?.innerText || "";
                    const subject = prompt("Przedmiot (puste = usuń):", currentName);
                    if (subject === null) return; 

                    const day = newCell.dataset.day;
                    const hour = parseInt(newCell.dataset.hour);
                    const startTime = `${hour.toString().padStart(2,'0')}:00`;
                    const endTime = `${hour.toString().padStart(2,'0')}:45`;

                    await _supabase.from('weekly_schedule').delete().eq('class_id', currentViewClassId).eq('day_of_week', day).eq('start_time', startTime);

                    if (subject.trim() !== "") {
                        const room = prompt("Sala:", currentRoom);
                        await _supabase.from('weekly_schedule').insert({
                            class_id: currentViewClassId, day_of_week: day, start_time: startTime, end_time: endTime, subject_name: subject, room: room
                        });
                        newCell.innerHTML = `<div class="subject-block"><span class="subject-name">${subject}</span><span class="subject-info">${room || ''}</span></div>`;
                    } else {
                        newCell.innerHTML = '—';
                    }
                };
            });
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
