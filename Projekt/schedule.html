<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Plan Zajęć</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- STYLE PLANU ZAJĘĆ --- */
        .schedule-container { 
            background: var(--panel-bg); 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            box-shadow: var(--shadow); 
            overflow-x: auto; 
        }
        .schedule-table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 600px; 
        }
        .schedule-table th, .schedule-table td { 
            padding: 5px; 
            text-align: center; 
            border: 1px solid var(--border-color); 
        }
        .schedule-table th { 
            background: rgba(0,0,0,0.02); 
            color: var(--text-muted); 
            font-size: 12px; 
            text-transform: uppercase; 
            padding: 10px; 
        }
        .schedule-table td { 
            height: 85px; 
            vertical-align: top; 
            font-size: 13px; 
            position: relative; 
            width: 18%; 
        } 
        
        .hour-col { 
            font-weight: bold; 
            color: var(--text-muted); 
            width: 80px !important; 
            vertical-align: middle !important; 
        }
        
        /* BLOK LEKCJI (Wewnątrz komórki) */
        .lesson-cell-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            width: 100%;
            position: relative;
            box-sizing: border-box;
            padding: 2px;
        }

        /* Strefy edycji */
        .zone-subject { 
            font-weight: 700; 
            color: var(--text-main); 
            padding: 4px; 
            border-radius: 4px; 
            margin-top: 5px; 
            font-size: 13px;
        }
        .zone-bottom { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-end; 
            padding: 4px; 
            margin-top: auto; 
        }
        .zone-teacher { 
            font-size: 10px; 
            color: var(--accent-color); 
            font-weight: 600; 
            cursor: pointer; 
        }
        .zone-room { 
            font-size: 10px; 
            background: rgba(0,0,0,0.05); 
            padding: 2px 5px; 
            border-radius: 4px; 
            color: var(--text-muted); 
            font-weight: bold; 
        }

        /* Hover effects tylko dla Admina (dodawane klasą .can-edit w JS) */
        .can-edit .zone-subject:hover { background: rgba(33, 150, 243, 0.1); cursor: pointer; outline: 1px dashed #2196F3; }
        .can-edit .zone-teacher:hover { text-decoration: underline; }
        .can-edit .zone-room:hover { background: #ddd; cursor: pointer; }

        /* Przycisk usuwania (X) */
        .delete-x {
            position: absolute;
            top: 0px;
            right: 0px;
            width: 18px;
            height: 18px;
            background: #F44336;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            line-height: 1;
            font-weight: bold;
        }
        .can-edit .lesson-cell-content:hover .delete-x { display: flex; } 

        /* Pusta komórka do dodawania */
        .empty-cell-trigger {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            color: transparent; font-size: 24px; cursor: default;
        }
        .can-edit .empty-cell-trigger { cursor: pointer; }
        .can-edit .empty-cell-trigger:hover { color: #ccc; background: rgba(0,0,0,0.02); }

        /* Style Mapowania (Modal) */
        .mapping-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.02);
        }
        .mapping-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            background: var(--panel-bg);
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .mapping-row:last-child { margin-bottom: 0; border-bottom: none; }
        .sheet-name { font-weight: bold; color: #D32F2F; display:flex; align-items:center; gap:5px; font-size: 13px; }
        .arrow-icon { color: var(--text-muted); font-size: 18px; margin: 0 10px; }
        .mapping-select { padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); width: 180px; font-size: 12px; }

        /* Kontrolki */
        .class-selector-container { margin-bottom: 15px; display: inline-flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .class-select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-main); font-size: 14px; }

        /* Sidebar */
        .widget-icon { display: flex; align-items: center; justify-content: center; background: none !important; }
        #student-sidebar-content { display: flex; flex-direction: column; gap: 30px; width: 100%; margin-top: 30px;}
        .sidebar-section { width: 100%; display: block; }
        .sidebar-section + .sidebar-section { border-top: 1px solid var(--border-color); padding-top: 20px; }
        .sidebar-title { font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: bold; margin-bottom: 15px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-list-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; }
        .sidebar-list-date { font-weight: bold; color: var(--accent-color); margin-right: 10px; font-size: 12px; min-width: 35px; }
        .sidebar-list-content { flex: 1; color: var(--text-main); line-height: 1.3; font-size: 13px; }
        .sidebar-grade-circle { width: 30px; height: 30px; border-radius: 50%; background: var(--hover-bg); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; margin-right: 10px; color: var(--text-main); }
        .empty-sidebar { font-size: 12px; color: var(--text-muted); font-style: italic; }

        @media (prefers-color-scheme: dark) {
            .sidebar-grade-circle { background: #333; border-color: #555; color: #fff; }
        }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="schedule.html" class="nav-link active"><span>Plan Zajęć</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">← Wróć do pulpitu</a>
                    <h1>Plan Zajęć</h1>
                    
                    <div id="staff-view-controls" style="display:none; margin-top: 10px;">
                        <div class="class-selector-container">
                            <label for="classSelect">Wybierz klasę:</label>
                            <select id="classSelect" class="class-select" onchange="changeClass()">
                                <option value="" disabled selected>Ładowanie klas...</option>
                            </select>
                        </div>
                    </div>

                    <div id="admin-controls" style="display:none; margin-top: 5px; padding-top: 10px; border-top: 1px dashed var(--border-color);">
                        <p style="font-size: 11px; color: var(--accent-color); font-weight: bold; margin-bottom: 5px;">ZARZĄDZANIE (CAŁA SZKOŁA)</p>
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#2E7D32; display:flex; align-items:center; gap:5px;" onclick="exportAllClassesToExcel()">
                                <span class="material-symbols-outlined" style="font-size:16px;">download</span> Export Wszystkich
                            </button>
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#1565C0; display:flex; align-items:center; gap:5px;" onclick="document.getElementById('import-excel-input').click()">
                                <span class="material-symbols-outlined" style="font-size:16px;">upload</span> Import Masowy
                            </button>
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#7B1FA2; display:flex; align-items:center; gap:5px;" onclick="downloadAllClassesTemplate()">
                                <span class="material-symbols-outlined" style="font-size:16px;">description</span> Szablon Szkoły
                            </button>
                        </div>
                        <input type="file" id="import-excel-input" accept=".xlsx, .xls" style="display:none;" onchange="importAllClassesFromExcel(this)">
                    </div>

                    <div id="parent-controls" style="display:none; margin-top: 10px;">
                        <div class="class-selector-container">
                            <label for="childSelect">Wybierz dziecko:</label>
                            <select id="childSelect" class="class-select" onchange="changeChild()">
                                <option value="" disabled selected>Ładowanie...</option>
                            </select>
                            
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#2E7D32; display:flex; align-items:center; gap:5px;" onclick="exportCurrentViewToExcel()">
                                <span class="material-symbols-outlined" style="font-size:16px;">download</span> Pobierz Plan
                            </button>
                        </div>
                    </div>

                    <p id="schedule-info-text" style="margin-top: 15px;">Ładowanie planu...</p>
                </div>
            </div>

            <div class="schedule-container">
                <table class="schedule-table">
                    <thead>
                        <tr><th style="width:80px;">Godz.</th><th>Poniedziałek</th><th>Wtorek</th><th>Środa</th><th>Czwartek</th><th>Piątek</th></tr>
                    </thead>
                    <tbody id="schedule-body"></tbody>
                </table>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card" style="position: relative;">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje" style="cursor: pointer;"></div> 
                <div id="profileDropdown" style="display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); border: 1px solid var(--border-color); padding: 5px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; width: 180px; text-align: left;">
                    <div class="dropdown-item" id="changePassBtn" style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                        <div class="widget-icon" style="width:20px;height:20px;"><span class="material-symbols-outlined" style="font-size:18px">lock_reset</span></div> Zmień hasło
                    </div>
                    <div class="dropdown-item" id="logoutBtn" style="padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: red; font-size: 13px;">
                        <div class="widget-icon" style="width:20px;height:20px;"><span class="material-symbols-outlined" style="font-size:18px">logout</span></div> Wyloguj się
                    </div>
                </div>
                <h2 class="profile-name" id="profile-name-display" style="margin-top: 15px;">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
                <p style="font-size: 13px; color: #888; margin-top: 5px; max-width: 200px; line-height: 1.4;" id="profile-school-display"></p>
            </div>

            <div id="student-sidebar-content" style="display: none;">
                <div class="sidebar-section">
                    <div class="sidebar-title"><span>NADCHODZĄCE</span></div>
                    <div id="sidebar-calendar-list"><p class="empty-sidebar">Ładowanie...</p></div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">OSTATNIE OCENY (7 DNI)</div>
                    <div id="sidebar-grades-list"><p class="empty-sidebar">Ładowanie...</p></div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">OSTATNIE UWAGI</div>
                    <div id="sidebar-remarks-list"><p class="empty-sidebar">Ładowanie...</p></div>
                </div>
            </div>
        </aside>
    </div>

    <div class="modal-overlay" id="addLessonModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Dodaj Lekcję</h3>
                <span class="close-modal" onclick="closeModal('addLessonModal')">&times;</span>
            </div>
            <form id="addLessonForm" class="modal-form">
                <input type="hidden" id="add-day"><input type="hidden" id="add-hour">
                <label>Przedmiot</label>
                <input type="text" id="add-subject" class="edit-input" required>
                <label>Sala</label>
                <input type="text" id="add-room" class="edit-input">
                <label>Nauczyciel</label>
                <select id="add-teacher" class="edit-input"><option value="">-- Wybierz --</option></select>
                <button type="submit" class="login-button full-width-btn" style="margin-top:15px;">Dodaj</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="changeTeacherModal">
        <div class="modal-window" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Zmień Nauczyciela</h3>
                <span class="close-modal" onclick="closeModal('changeTeacherModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ch-day"><input type="hidden" id="ch-hour">
                <select id="ch-teacher-select" class="edit-input" style="width:100%"><option value="">Ładowanie...</option></select>
                <button class="login-button full-width-btn" onclick="saveTeacherChange()" style="margin-top:15px;">Zapisz</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="mappingModal">
        <div class="modal-window" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Mapowanie Arkuszy</h3>
                <span class="close-modal" onclick="closeModal('mappingModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:var(--text-main);">Niektóre arkusze w pliku Excel nie pasują nazwą do żadnej klasy. Przypisz je ręcznie lub pomiń.</p>
                <div id="mapping-container" class="mapping-list"></div>
                <div style="text-align:right; margin-top:15px;">
                    <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('mappingModal')">Anuluj</button>
                    <button class="login-button" style="width:auto;" onclick="finalizeImport()">Zatwierdź i Importuj</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentViewClassId = null;
        let isStaff = false; 
        let canEdit = false; 

        // Import variables
        let pendingWorkbook = null;
        let pendingClassList = [];
        let autoMatchedSheets = [];
        let unmatchedSheets = [];

        function generateGrid() {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            for (let hour = 8; hour < 20; hour++) {
                const tr = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.className = 'hour-col';
                timeCell.innerHTML = `${hour.toString().padStart(2, '0')}:00<br>-<br>${hour.toString().padStart(2, '0')}:45`;
                tr.appendChild(timeCell);
                for (let day = 1; day <= 5; day++) {
                    const td = document.createElement('td');
                    td.dataset.day = day; td.dataset.hour = hour; td.id = `cell-${day}-${hour}`;
                    td.innerHTML = `<div class="empty-cell-trigger" onclick="handleEmptyClick(${day}, ${hour})">+</div>`;
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        async function init() {
            generateGrid();
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const { data: userDetails } = await _supabase
                .from('users')
                .select('id, username, role, school_id, class_id, schools(name), classes(name)')
                .eq('id', session.user.id)
                .single();
                
            if (!userDetails) return;
            currentUser = userDetails;

            setupProfileCard(userDetails);
            setupSidebarEvents();

            isStaff = ['teacher', 'manager', 'admin', 'lecturer'].includes(currentUser.role);
            canEdit = ['manager', 'admin'].includes(currentUser.role);

            if (isStaff) {
                await setupStaffView();
            } else if (currentUser.role === 'parent') {
                await setupParentView();
                document.getElementById('student-sidebar-content').style.display = 'flex';
            } else {
                setupStudentView();
                document.getElementById('student-sidebar-content').style.display = 'flex';
                loadSidebarCalendar(currentUser.id);
                loadSidebarGrades(currentUser.id);
                loadSidebarRemarks(currentUser.id);
            }
        }

        // --- RENDEROWANIE PLANU Z LOGIKĄ EDYCJI (Split Zones) ---
        async function fetchAndRenderSchedule(classId) {
            generateGrid(); 
            const { data: scheduleData } = await _supabase.from('weekly_schedule').select('*, teacher:teacher_id(username)').eq('class_id', classId);
            if (!scheduleData) return;

            scheduleData.forEach(item => {
                const hourPart = parseInt(item.start_time.split(':')[0]); 
                const cell = document.getElementById(`cell-${item.day_of_week}-${hourPart}`);
                if (cell) {
                    const teacherName = item.teacher ? item.teacher.username : 'Brak';
                    const editClass = canEdit ? 'can-edit' : '';
                    
                    cell.className = editClass; 
                    cell.innerHTML = `
                        <div class="lesson-cell-content">
                            <div class="delete-x" onclick="deleteLessonDirect(${item.day_of_week}, ${hourPart})">&times;</div>
                            <div class="zone-subject" onclick="editSubject(${item.day_of_week}, ${hourPart}, '${item.subject_name}')">${item.subject_name}</div>
                            <div class="zone-bottom">
                                <div class="zone-teacher" onclick="editTeacher(${item.day_of_week}, ${hourPart})">${teacherName}</div>
                                <div class="zone-room" onclick="editRoom(${item.day_of_week}, ${hourPart}, '${item.room||''}')">${item.room || '?'}</div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // --- OBSŁUGA KLIKNIĘĆ (EDYCJA) ---
        function handleEmptyClick(day, hour) {
            if (!canEdit || !currentViewClassId) return;
            document.getElementById('add-day').value = day;
            document.getElementById('add-hour').value = hour;
            document.getElementById('add-subject').value = "";
            document.getElementById('add-room').value = "";
            document.getElementById('add-teacher').value = "";
            openModal('addLessonModal');
        }

        async function editSubject(day, hour, currentVal) {
            if (!canEdit) return;
            const newVal = prompt("Edytuj nazwę przedmiotu:", currentVal);
            if (newVal && newVal.trim() !== "") {
                await updateScheduleField(day, hour, { subject_name: newVal.trim() });
            }
        }

        async function editRoom(day, hour, currentVal) {
            if (!canEdit) return;
            const newVal = prompt("Edytuj numer sali:", currentVal);
            if (newVal !== null) {
                await updateScheduleField(day, hour, { room: newVal.trim() });
            }
        }

        function editTeacher(day, hour) {
            if (!canEdit) return;
            document.getElementById('ch-day').value = day;
            document.getElementById('ch-hour').value = hour;
            // Kopiuj opcje z głównego selecta do tego w modalu
            const mainSel = document.getElementById('add-teacher');
            const targetSel = document.getElementById('ch-teacher-select');
            targetSel.innerHTML = mainSel.innerHTML;
            openModal('changeTeacherModal');
        }

        async function saveTeacherChange() {
            const day = document.getElementById('ch-day').value;
            const hour = document.getElementById('ch-hour').value;
            const teacherId = document.getElementById('ch-teacher-select').value || null;
            await updateScheduleField(day, hour, { teacher_id: teacherId });
            closeModal('changeTeacherModal');
        }

        async function deleteLessonDirect(day, hour) {
            if (!canEdit) return;
            if(!confirm("Usunąć tę lekcję?")) return;
            const startTime = `${hour.toString().padStart(2,'0')}:00`;
            await _supabase.from('weekly_schedule')
                .delete()
                .eq('class_id', currentViewClassId)
                .eq('day_of_week', day)
                .eq('start_time', startTime);
            
            fetchAndRenderSchedule(currentViewClassId);
        }

        async function updateScheduleField(day, hour, updates) {
            const startTime = `${hour.toString().padStart(2,'0')}:00`;
            const { error } = await _supabase.from('weekly_schedule')
                .update(updates)
                .eq('class_id', currentViewClassId)
                .eq('day_of_week', day)
                .eq('start_time', startTime);
            
            if (error) alert("Błąd zapisu: " + error.message);
            else fetchAndRenderSchedule(currentViewClassId);
        }

        // Zapis nowej lekcji
        document.getElementById('addLessonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const day = document.getElementById('add-day').value;
            const hour = parseInt(document.getElementById('add-hour').value);
            const startTime = `${hour.toString().padStart(2,'0')}:00`;
            const endTime = `${hour.toString().padStart(2,'0')}:45`;
            
            const insertData = {
                class_id: currentViewClassId,
                day_of_week: day,
                start_time: startTime,
                end_time: endTime,
                subject_name: document.getElementById('add-subject').value,
                room: document.getElementById('add-room').value,
                teacher_id: document.getElementById('add-teacher').value || null
            };

            const { error } = await _supabase.from('weekly_schedule').insert(insertData);
            if(error) alert(error.message);
            else { closeModal('addLessonModal'); fetchAndRenderSchedule(currentViewClassId); }
        });

        // --- SIDEBAR & WIDOKI ---
        function setupProfileCard(p){ document.getElementById('profile-name-display').textContent=p.username;document.getElementById('profile-role-display').textContent=p.role.toUpperCase(); document.getElementById('profile-school-display').textContent=p.schools?.name||""; }
        function setupSidebarEvents(){ document.getElementById('avatarTrigger').onclick=()=>{let d=document.getElementById('profileDropdown');d.style.display=d.style.display==='block'?'none':'block';}; document.getElementById('logoutBtn').onclick=async()=>{await _supabase.auth.signOut();window.location.href='login.html';};}
        
        async function loadSidebarCalendar(uid){const l=document.getElementById('sidebar-calendar-list');const{data:u}=await _supabase.from('users').select('class_id').eq('id',uid).single();if(!u?.class_id){l.innerHTML='<p class="empty-sidebar">Brak.</p>';return;} const t=new Date().toISOString().split('T')[0];const{data}=await _supabase.from('calendar_events').select('*').eq('class_id',u.class_id).gte('event_date',t).limit(3);l.innerHTML='';if(!data||!data.length){l.innerHTML='<p class="empty-sidebar">Brak wydarzeń.</p>';return;} data.forEach(e=>l.innerHTML+=`<div class="sidebar-list-item"><b>${e.event_date.slice(5)}</b>: ${e.title}</div>`);}
        
        async function loadSidebarGrades(uid){ const l=document.getElementById('sidebar-grades-list'); const w=new Date(Date.now()-7*24*60*60*1000).toISOString(); const{data:g}=await _supabase.from('grades').select('grade,packages(title)').eq('user_id',uid).gte('created_at',w).order('created_at',{ascending:false}).limit(5); l.innerHTML=''; if(!g||!g.length){l.innerHTML='<p class="empty-sidebar">Brak ocen.</p>';return;} g.forEach(x=>l.innerHTML+=`<div class="sidebar-list-item"><div class="sidebar-grade-circle">${x.grade}</div><div class="sidebar-list-content">${x.packages?x.packages.title:'Inne'}</div></div>`);}
        
        async function loadSidebarRemarks(uid){ const l=document.getElementById('sidebar-remarks-list'); const{data:r}=await _supabase.from('remarks').select('points,subject_name,created_at').eq('student_id',uid).order('created_at',{ascending:false}).limit(3); l.innerHTML=''; if(!r||!r.length){l.innerHTML='<p class="empty-sidebar">Brak uwag.</p>';return;} r.forEach(x=>{ let c=x.points>0?'#4CAF50':(x.points<0?'#F44336':'#757575'); let t=x.points>0?`+${x.points}`:x.points; l.innerHTML+=`<div class="sidebar-list-item"><div class="sidebar-grade-circle" style="color:${c};border-color:${c};font-size:14px;width:35px;height:35px;">${t}</div><div class="sidebar-list-content">${x.subject_name}</div></div>`; });}

        function setupStudentView() { if(currentUser.class_id){currentViewClassId=currentUser.class_id;fetchAndRenderSchedule(currentViewClassId);} }
        async function setupParentView() { 
            document.getElementById('parent-controls').style.display='block'; 
            const {data:rels}=await _supabase.from('parent_children').select('users:child_id(id,username,class_id)').eq('parent_id',currentUser.id);
            const s=document.getElementById('childSelect'); s.innerHTML='';
            rels?.forEach(r=>{const o=new Option(r.users.username,r.users.id);o.dataset.classId=r.users.class_id||"";s.add(o);});
            changeChild();
        }
        function changeChild(){
            const s=document.getElementById('childSelect'); const cid=s.options[s.selectedIndex].dataset.classId;
            const uid=s.value;
            loadSidebarCalendar(uid); loadSidebarGrades(uid); loadSidebarRemarks(uid);
            if(cid) {currentViewClassId=cid; fetchAndRenderSchedule(cid);} else {generateGrid();}
        }

        async function setupStaffView() {
            document.getElementById('staff-view-controls').style.display='block';
            if(canEdit) document.getElementById('admin-controls').style.display='block';
            let q=_supabase.from('classes').select('id,name,school_id').order('name');
            if(currentUser.role!=='admin') q=q.eq('school_id',currentUser.school_id);
            const{data:classes}=await q;
            const s=document.getElementById('classSelect'); s.innerHTML='';
            if(classes?.length){
                classes.forEach(c=>{ s.add(new Option(c.name,c.id)); });
                currentViewClassId=classes[0].id; 
                await loadTeachersForSelect(classes[0].school_id);
                fetchAndRenderSchedule(currentViewClassId);
            }
        }
        async function changeClass(){
            const s=document.getElementById('classSelect'); currentViewClassId=s.value;
            fetchAndRenderSchedule(currentViewClassId);
        }
        async function loadTeachersForSelect(sid){
            const s=document.getElementById('add-teacher'); s.innerHTML='<option value="">-- Wybierz --</option>';
            const{data}=await _supabase.from('users').select('id,username').eq('school_id',sid).in('role',['teacher','manager','admin','lecturer']).order('username');
            data?.forEach(t=>s.add(new Option(t.username,t.id)));
        }

        // --- EXCEL (MASOWY) ---
        const DAY_MAP={1:"Poniedziałek",2:"Wtorek",3:"Środa",4:"Czwartek",5:"Piątek"};
        const REV_MAP={"poniedziałek":1,"wtorek":2,"środa":3,"czwartek":4,"piątek":5,"pon":1,"wt":2,"śr":3,"czw":4,"pt":5};

        async function exportAllClassesToExcel() {
            if(typeof XLSX==='undefined')return alert("Brak biblioteki");
            try {
                let q=_supabase.from('classes').select('id,name').order('name');
                if(currentUser.role!=='admin') q=q.eq('school_id',currentUser.school_id);
                const{data:classes}=await q;
                const cids=classes.map(c=>c.id);
                const{data:sched}=await _supabase.from('weekly_schedule').select('*').in('class_id',cids);
                const wb=XLSX.utils.book_new();
                classes.forEach(c=>{
                    const rows=[["Dzień","Godzina","Przedmiot","Sala"]];
                    const cs=sched.filter(x=>x.class_id===c.id);
                    for(let d=1;d<=5;d++){
                        for(let h=8;h<20;h++){
                            const st=`${h.toString().padStart(2,'0')}:00`;
                            const l=cs.find(x=>x.day_of_week===d && x.start_time.startsWith(st));
                            const timeStr = `${h.toString().padStart(2,'0')}:00 - ${h.toString().padStart(2,'0')}:45`;
                            rows.push([DAY_MAP[d], timeStr, l?l.subject_name:"", l?l.room:""]);
                        }
                    }
                    const ws=XLSX.utils.aoa_to_sheet(rows); ws['!cols']=[{wch:15},{wch:15},{wch:30},{wch:10}];
                    XLSX.utils.book_append_sheet(wb,ws,c.name.substring(0,30));
                });
                XLSX.writeFile(wb,"Plan_Cala_Szkola.xlsx");
            } catch(e){alert(e.message);}
        }

        async function importAllClassesFromExcel(input) {
            if(!input.files.length) return;
            const reader=new FileReader();
            reader.onload=async(e)=>{
                try{
                    const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
                    pendingWorkbook=wb;
                    let q=_supabase.from('classes').select('id,name');
                    if(currentUser.role!=='admin') q=q.eq('school_id',currentUser.school_id);
                    const{data:cls}=await q;
                    pendingClassList=cls;
                    autoMatchedSheets=[]; unmatchedSheets=[];
                    const map={}; cls.forEach(c=>map[c.name.trim().toLowerCase()]=c.id);

                    wb.SheetNames.forEach(sn=>{
                        const cid=map[sn.trim().toLowerCase()];
                        if(cid) autoMatchedSheets.push({sheet:sn,id:cid}); else unmatchedSheets.push(sn);
                    });

                    if(unmatchedSheets.length) showMappingModal();
                    else { if(confirm(`Znaleziono ${autoMatchedSheets.length} arkuszy. Importować?`)) executeImport([]); }
                } catch(err){alert(err.message);} finally{input.value='';}
            };
            reader.readAsArrayBuffer(input.files[0]);
        }

        function showMappingModal(){
            const c=document.getElementById('mapping-container'); c.innerHTML='';
            unmatchedSheets.forEach(sn=>{
                let opts='<option value="">-- Pomiń --</option>';
                pendingClassList.forEach(cl=>opts+=`<option value="${cl.id}">${cl.name}</option>`);
                c.innerHTML+=`<div class="mapping-row"><div class="sheet-name"><span class="material-symbols-outlined">description</span> ${sn}</div><span class="arrow-icon">→</span><select class="mapping-select" data-sheet="${sn}">${opts}</select></div>`;
            });
            openModal('mappingModal');
        }

        async function finalizeImport(){
            const matches=[];
            document.querySelectorAll('.mapping-select').forEach(s=>{if(s.value) matches.push({sheet:s.dataset.sheet,id:s.value});});
            closeModal('mappingModal');
            await executeImport(matches);
        }

        async function executeImport(manual){
            const all=[...autoMatchedSheets,...manual];
            if(!all.length) return alert("Nic do importu.");
            let count=0;
            for(const m of all){
                const ws=pendingWorkbook.Sheets[m.sheet];
                const rows=XLSX.utils.sheet_to_json(ws);
                const inserts=[];
                rows.forEach(r=>{
                    const day=REV_MAP[(r['Dzień']||"").toLowerCase().trim()];
                    const hRaw=parseInt(r['Godzina']);
                    if(day && hRaw && r['Przedmiot']){
                        inserts.push({
                            class_id:m.id, day_of_week:day,
                            start_time:`${hRaw.toString().padStart(2,'0')}:00`,
                            end_time:`${hRaw.toString().padStart(2,'0')}:45`,
                            subject_name:r['Przedmiot'], room:r['Sala']||"", teacher_id:null
                        });
                    }
                });
                await _supabase.from('weekly_schedule').delete().eq('class_id',m.id);
                if(inserts.length) await _supabase.from('weekly_schedule').insert(inserts);
                count++;
            }
            alert(`Zaimportowano plan dla ${count} klas.`);
            if(currentViewClassId) fetchAndRenderSchedule(currentViewClassId);
        }

        async function downloadAllClassesTemplate(){ exportAllClassesToExcel(); } 
        
        async function exportCurrentViewToExcel(){
            if(!currentViewClassId) return alert("Wybierz.");
            const { data: schedule } = await _supabase.from('weekly_schedule').select('*').eq('class_id', currentViewClassId);
            const wb = XLSX.utils.book_new();
            const data = [["Dzień", "Godzina", "Przedmiot", "Sala"]];
            for (let d=1; d<=5; d++) {
                for (let h=8; h<20; h++) {
                    const st=`${h.toString().padStart(2,'0')}:00`;
                    const l=schedule?.find(s=>s.day_of_week===d && s.start_time.startsWith(st));
                    const ts=`${h.toString().padStart(2,'0')}:00 - ${h.toString().padStart(2,'0')}:45`;
                    data.push([DAY_MAP[d], ts, l?l.subject_name:"", l?l.room:""]);
                }
            }
            const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols']=[{wch:15},{wch:15},{wch:30},{wch:10}];
            XLSX.utils.book_append_sheet(wb, ws, "Plan");
            XLSX.writeFile(wb, "Plan_Zajec.xlsx");
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
