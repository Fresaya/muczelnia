<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mUczelnia - Plan Zajęć</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- STYLE PLANU ZAJĘĆ --- */
        .schedule-container { background: var(--panel-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow-x: auto; }
        .schedule-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .schedule-table th, .schedule-table td { padding: 10px; text-align: center; border: 1px solid var(--border-color); }
        .schedule-table th { background: rgba(0,0,0,0.02); color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        .schedule-table td { height: 70px; vertical-align: middle; font-size: 13px; position: relative; } 
        
        .hour-col { font-weight: bold; color: var(--text-muted); width: 100px; }
        
        .subject-block { display: flex; flex-direction: column; gap: 2px; justify-content: center; height: 100%; }
        .subject-name { font-weight: 600; color: var(--text-main); }
        .subject-info { font-size: 10px; color: var(--text-muted); background: rgba(0,0,0,0.05); padding: 1px 4px; border-radius: 4px; display: inline-block; margin: 2px auto 0; }
        .subject-teacher { font-size: 9px; color: var(--accent-color); margin-top: 2px; font-weight: 500; }
        
        /* Klasa editable tylko dla Admina/Managera */
        .editable:hover { background-color: rgba(33, 150, 243, 0.05); cursor: pointer; outline: 1px dashed var(--accent-color); }
        
        .class-selector-container { margin-bottom: 15px; display: inline-flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .class-select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--panel-bg); color: var(--text-main); font-size: 14px; }

        /* --- STYLE SIDEBARA --- */
        .widget-icon { display: flex; align-items: center; justify-content: center; background: none !important; }
        #student-sidebar-content { display: flex; flex-direction: column; gap: 30px; width: 100%; margin-top: 30px;}
        .sidebar-section { width: 100%; display: block; }
        .sidebar-section + .sidebar-section { border-top: 1px solid var(--border-color); padding-top: 20px; }
        .sidebar-title { font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: bold; margin-bottom: 15px; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-list-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; }
        .sidebar-list-date { font-weight: bold; color: var(--accent-color); margin-right: 10px; font-size: 12px; min-width: 35px; }
        .sidebar-list-content { flex: 1; color: var(--text-main); line-height: 1.3; font-size: 13px; }
        .sidebar-grade-circle { width: 30px; height: 30px; border-radius: 50%; background: var(--hover-bg); border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; margin-right: 10px; color: var(--text-main); }
        .empty-sidebar { font-size: 12px; color: var(--text-muted); font-style: italic; }

        @media (prefers-color-scheme: dark) {
            .sidebar-grade-circle { background: #333; border-color: #555; color: #fff; }
        }
        /* Styl dla listy mapowania w modalu */
        .mapping-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.02);
        }
        .mapping-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            background: var(--panel-bg);
            margin-bottom: 5px;
            border-radius: 4px;
        }
        .mapping-row:last-child { margin-bottom: 0; border-bottom: none; }
        .sheet-name { font-weight: bold; color: #D32F2F; display:flex; align-items:center; gap:5px; }
        .arrow-icon { color: var(--text-muted); font-size: 18px; margin: 0 10px; }
        .mapping-select { padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); width: 180px; }
    </style>
</head>
<body>
    <div class="layout-wrapper">
        <aside class="sidebar-left">
            <div class="top-section">
                <div class="brand-area"><a href="dashboard.html" class="logo-text"><span>m</span>Uczelnia</a></div>
                <ul class="nav-menu">
                    <li class="nav-item"><a href="dashboard.html" class="nav-link"><span>Pulpit</span></a></li>
                    <li class="nav-item"><a href="schedule.html" class="nav-link active"><span>Plan Zajęć</span></a></li>
                </ul>
            </div>
        </aside>

        <main class="main-content">
            <div class="welcome-header">
                <div>
                    <a href="dashboard.html" style="text-decoration:none; color:var(--text-muted); font-size:14px;">← Wróć do pulpitu</a>
                    <h1>Plan Zajęć</h1>
                    
                    <div id="staff-view-controls" style="display:none; margin-top: 10px;">
                        <div class="class-selector-container">
                            <label for="classSelect">Wybierz klasę:</label>
                            <select id="classSelect" class="class-select" onchange="changeClass()">
                                <option value="" disabled selected>Ładowanie klas...</option>
                            </select>
                        </div>
                    </div>

                    <div id="admin-controls" style="display:none; margin-top: 5px; padding-top: 10px; border-top: 1px dashed var(--border-color);">
                        <p style="font-size: 11px; color: var(--accent-color); font-weight: bold; margin-bottom: 5px;">ZARZĄDZANIE (CAŁA SZKOŁA)</p>
                        <div style="display:flex; gap:5px; flex-wrap:wrap;">
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#2E7D32; display:flex; align-items:center; gap:5px;" onclick="exportAllClassesToExcel()">
                                <span class="material-symbols-outlined" style="font-size:16px;">download</span> Export Wszystkich Klas
                            </button>
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#1565C0; display:flex; align-items:center; gap:5px;" onclick="document.getElementById('import-excel-input').click()">
                                <span class="material-symbols-outlined" style="font-size:16px;">upload</span> Import (Masowy)
                            </button>
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#7B1FA2; display:flex; align-items:center; gap:5px;" onclick="downloadAllClassesTemplate()">
                                <span class="material-symbols-outlined" style="font-size:16px;">description</span> Pobierz Szablon Szkoły
                            </button>
                        </div>
                        <input type="file" id="import-excel-input" accept=".xlsx, .xls" style="display:none;" onchange="importAllClassesFromExcel(this)">
                    </div>

                    <div id="parent-controls" style="display:none; margin-top: 10px;">
                        <div class="class-selector-container">
                            <label for="childSelect">Wybierz dziecko:</label>
                            <select id="childSelect" class="class-select" onchange="changeChild()">
                                <option value="" disabled selected>Ładowanie...</option>
                            </select>
                            
                            <button class="login-button" style="width:auto; font-size:12px; padding:5px 15px; background:#2E7D32; display:flex; align-items:center; gap:5px;" onclick="exportCurrentViewToExcel()">
                                <span class="material-symbols-outlined" style="font-size:16px;">download</span> Pobierz Plan
                            </button>
                        </div>
                    </div>

                    <p id="schedule-info-text" style="margin-top: 15px;">Ładowanie planu...</p>
                </div>
            </div>

            <div class="schedule-container">
                <table class="schedule-table">
                    <thead>
                        <tr><th>Godzina</th><th>Poniedziałek</th><th>Wtorek</th><th>Środa</th><th>Czwartek</th><th>Piątek</th></tr>
                    </thead>
                    <tbody id="schedule-body"></tbody>
                </table>
            </div>
        </main>

        <aside class="sidebar-right">
            <div class="profile-card" style="position: relative;">
                <div class="avatar" id="avatarTrigger" title="Kliknij, aby otworzyć opcje" style="cursor: pointer;"></div> 
                <div id="profileDropdown" style="display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); border: 1px solid var(--border-color); padding: 5px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; width: 180px; text-align: left;">
                    <div class="dropdown-item" id="changePassBtn" style="padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;">
                        <div class="widget-icon" style="width:20px;height:20px;"><span class="material-symbols-outlined" style="font-size:18px">lock_reset</span></div> Zmień hasło
                    </div>
                    <div class="dropdown-item" id="logoutBtn" style="padding: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: red; font-size: 13px;">
                        <div class="widget-icon" style="width:20px;height:20px;"><span class="material-symbols-outlined" style="font-size:18px">logout</span></div> Wyloguj się
                    </div>
                </div>
                <h2 class="profile-name" id="profile-name-display" style="margin-top: 15px;">...</h2>
                <p class="profile-id" id="profile-role-display">...</p>
                <p style="font-size: 13px; color: #888; margin-top: 5px; max-width: 200px; line-height: 1.4;" id="profile-school-display"></p>
            </div>

            <div id="student-sidebar-content" style="display: none;">
                <div class="sidebar-section">
                    <div class="sidebar-title"><span>NADCHODZĄCE</span></div>
                    <div id="sidebar-calendar-list"><p class="empty-sidebar">Ładowanie...</p></div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">OSTATNIE OCENY (7 DNI)</div>
                    <div id="sidebar-grades-list"><p class="empty-sidebar">Ładowanie...</p></div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">OSTATNIE UWAGI</div>
                    <div id="sidebar-remarks-list"><p class="empty-sidebar">Ładowanie...</p></div>
                </div>
            </div>
        </aside>
    </div>

    <div class="modal-overlay" id="editLessonModal">
        <div class="modal-window">
            <div class="modal-header">
                <h3 class="modal-title">Edytuj Lekcję</h3>
                <span class="close-modal" onclick="closeModal('editLessonModal')">&times;</span>
            </div>
            <form id="editLessonForm" class="modal-form">
                <input type="hidden" id="edit-day">
                <input type="hidden" id="edit-hour">
                
                <label>Przedmiot</label>
                <input type="text" id="edit-subject" class="edit-input" placeholder="np. Matematyka" required>
                
                <label>Sala</label>
                <input type="text" id="edit-room" class="edit-input" placeholder="np. 204">
                
                <label>Nauczyciel Prowadzący</label>
                <select id="edit-teacher" class="edit-input">
                    <option value="">-- Brak / Zastępstwo --</option>
                    <option disabled>Ładowanie listy...</option>
                </select>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button type="button" class="login-button" style="background:#F44336; width:auto; border:none;" onclick="deleteLesson()">Usuń Lekcję</button>
                    <button type="submit" class="login-button" style="flex:1;">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="mappingModal">
        <div class="modal-window" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Mapowanie Arkuszy</h3>
                <span class="close-modal" onclick="closeModal('mappingModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:var(--text-main);">Niektóre arkusze w pliku Excel nie pasują nazwą do żadnej klasy. Przypisz je ręcznie lub pomiń.</p>
                
                <div id="mapping-container" class="mapping-list">
                    </div>

                <div style="text-align:right; margin-top:15px;">
                    <button class="login-button" style="background:#ccc; width:auto; color:#333;" onclick="closeModal('mappingModal')">Anuluj</button>
                    <button class="login-button" style="width:auto;" onclick="finalizeImport()">Zatwierdź i Importuj</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://xzbonbdtfgrhihwmiamq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6Ym9uYmR0ZmdyaGlod21pYW1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNDYxMzAsImV4cCI6MjA3OTcyMjEzMH0.iqd1FO3kdgECw857Okf0CF_i570wcTk2VtJhJXSwlEg';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentViewClassId = null;
        let isStaff = false; 
        let canEdit = false; 

        // Zmienne do procesu importu
        let pendingWorkbook = null;
        let pendingClassList = [];
        let autoMatchedSheets = []; // { sheetName, classId }
        let unmatchedSheets = [];   // [sheetName, sheetName...]

        function generateGrid() {
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = '';
            for (let hour = 8; hour < 20; hour++) {
                const tr = document.createElement('tr');
                const timeCell = document.createElement('td');
                timeCell.className = 'hour-col';
                timeCell.innerHTML = `${hour.toString().padStart(2, '0')}:00<br>-<br>${hour.toString().padStart(2, '0')}:45`;
                tr.appendChild(timeCell);
                for (let day = 1; day <= 5; day++) {
                    const td = document.createElement('td');
                    td.dataset.day = day; td.dataset.hour = hour; td.id = `cell-${day}-${hour}`; td.innerHTML = '—';
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
        }

        async function init() {
            generateGrid();
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }

            const { data: userDetails } = await _supabase
                .from('users')
                .select('id, username, role, school_id, class_id, schools(name), classes(name)')
                .eq('id', session.user.id)
                .single();
                
            if (!userDetails) return;
            currentUser = userDetails;

            setupProfileCard(userDetails);
            setupSidebarEvents();

            isStaff = ['teacher', 'manager', 'admin', 'lecturer'].includes(currentUser.role);
            canEdit = ['manager', 'admin'].includes(currentUser.role);

            if (isStaff) {
                await setupStaffView();
            } else if (currentUser.role === 'parent') {
                await setupParentView();
                document.getElementById('student-sidebar-content').style.display = 'flex';
            } else {
                setupStudentView();
                document.getElementById('student-sidebar-content').style.display = 'flex';
                loadSidebarCalendar(currentUser.id);
                loadSidebarGrades(currentUser.id);
                loadSidebarRemarks(currentUser.id);
            }
        }

        // --- SIDEBAR & PROFILE (Bez zmian) ---
        function setupProfileCard(profile) {
            document.getElementById('profile-name-display').textContent = profile.username;
            const roleMap = { 'student': 'UCZEŃ', 'teacher': 'NAUCZYCIEL', 'manager': 'SEKRETARIAT', 'admin': 'ADMIN', 'lecturer': 'WYKŁADOWCA', 'parent': 'RODZIC' };
            document.getElementById('profile-role-display').textContent = (roleMap[profile.role] || profile.role).toUpperCase();
            let schoolInfo = "";
            if (profile.schools && profile.schools.name) schoolInfo = profile.schools.name;
            if (profile.classes && profile.classes.name) schoolInfo += `<br><span style="color:var(--accent-color); font-weight:bold;">${profile.classes.name}</span>`;
            document.getElementById('profile-school-display').innerHTML = schoolInfo;
        }
        function setupSidebarEvents() {
            document.getElementById('avatarTrigger').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('profileDropdown').style.display = document.getElementById('profileDropdown').style.display === 'block' ? 'none' : 'block'; });
            window.addEventListener('click', () => { document.getElementById('profileDropdown').style.display = 'none'; });
            document.getElementById('logoutBtn').addEventListener('click', async () => { await _supabase.auth.signOut(); window.location.href = 'login.html'; });
            document.getElementById('changePassBtn').addEventListener('click', () => { window.location.href = 'settings.html'; });
        }
        async function loadSidebarCalendar(uid) { 
            const list = document.getElementById('sidebar-calendar-list');
            const { data: u } = await _supabase.from('users').select('class_id').eq('id', uid).single();
            if(!u || !u.class_id) { list.innerHTML = '<p class="empty-sidebar">Brak klasy.</p>'; return; }
            const today = new Date().toISOString().split('T')[0];
            const { data } = await _supabase.from('calendar_events').select('title, event_date, subject_name').eq('class_id', u.class_id).gte('event_date', today).order('event_date', {ascending:true}).limit(3);
            list.innerHTML=''; if(!data||!data.length){list.innerHTML='<p class="empty-sidebar">Brak wydarzeń.</p>';return;}
            data.forEach(e=>{ list.innerHTML+=`<div class="sidebar-list-item"><div class="sidebar-list-date">${new Date(e.event_date).getDate()}.${new Date(e.event_date).getMonth()+1}</div><div class="sidebar-list-content">${e.subject_name?`<b>${e.subject_name}:</b> `:''}${e.title}</div></div>`; });
        }
        async function loadSidebarGrades(uid){ 
            const list = document.getElementById('sidebar-grades-list');
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
            const { data: g } = await _supabase.from('grades').select('grade, packages(title)').eq('user_id', uid).gte('created_at', weekAgo).order('created_at', {ascending:false}).limit(5);
            list.innerHTML=''; if(!g||!g.length){list.innerHTML='<p class="empty-sidebar">Brak nowych ocen.</p>';return;}
            g.forEach(x=>{ list.innerHTML+=`<div class="sidebar-list-item"><div class="sidebar-grade-circle">${x.grade}</div><div class="sidebar-list-content">${x.packages?x.packages.title:'Inne'}</div></div>`; });
        }
        async function loadSidebarRemarks(uid){ 
            const list = document.getElementById('sidebar-remarks-list');
            const { data: r } = await _supabase.from('remarks').select('category, subject_name, created_at, points').eq('student_id', uid).order('created_at', {ascending:false}).limit(3);
            list.innerHTML=''; if(!r||!r.length){list.innerHTML='<p class="empty-sidebar">Brak uwag.</p>';return;}
            r.forEach(x=>{ 
                let c = x.points>0?'#4CAF50':(x.points<0?'#F44336':'#757575'); let t = x.points>0?`+${x.points}`:x.points;
                list.innerHTML+=`<div class="sidebar-list-item"><div class="sidebar-grade-circle" style="color:${c};border-color:${c};font-size:14px;width:35px;height:35px;">${t}</div><div class="sidebar-list-content"><span style="font-size:11px;color:#888;">${new Date(x.created_at).getDate()}.${new Date(x.created_at).getMonth()+1}</span><br>${x.subject_name}</div></div>`; 
            });
        }

        // --- WIDOKI ---
        function setupStudentView() {
            if (currentUser.class_id) {
                currentViewClassId = currentUser.class_id;
                document.getElementById('schedule-info-text').innerText = "Twój plan zajęć";
                fetchAndRenderSchedule(currentViewClassId);
            } else {
                document.getElementById('schedule-info-text').innerText = "Nie jesteś przypisany do żadnej klasy.";
            }
        }

        async function setupParentView() {
            document.getElementById('parent-controls').style.display = 'block';
            document.getElementById('schedule-info-text').innerText = "Plan zajęć Twojego dziecka";
            const { data: relations } = await _supabase.from('parent_children').select('child_id, users:child_id(id, username, class_id)').eq('parent_id', currentUser.id);
            const select = document.getElementById('childSelect');
            select.innerHTML = '';
            if (relations && relations.length > 0) {
                relations.forEach(rel => {
                    const child = rel.users;
                    const opt = new Option(child.username, child.id);
                    opt.dataset.classId = child.class_id || ""; 
                    select.add(opt);
                });
                changeChild();
            } else {
                select.innerHTML = '<option>Brak przypisanych dzieci</option>';
            }
        }

        function changeChild() {
            const select = document.getElementById('childSelect');
            const selectedOpt = select.options[select.selectedIndex];
            const childId = selectedOpt.value;
            const classId = selectedOpt.dataset.classId;
            loadSidebarCalendar(childId); loadSidebarGrades(childId); loadSidebarRemarks(childId);
            if (classId && classId !== "undefined" && classId !== "null" && classId !== "") {
                currentViewClassId = classId;
                generateGrid(); 
                fetchAndRenderSchedule(classId);
            } else {
                generateGrid();
                document.getElementById('schedule-body').innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center; color:#888;">To dziecko nie jest przypisane do żadnej klasy.</td></tr>';
            }
        }

        async function setupStaffView() {
            document.getElementById('staff-view-controls').style.display = 'block';
            document.getElementById('schedule-info-text').innerText = "Wybierz klasę, aby zobaczyć plan.";
            if (canEdit) {
                document.getElementById('admin-controls').style.display = 'block';
                document.getElementById('schedule-info-text').innerText = "Wybierz klasę do podglądu lub użyj przycisków poniżej, aby zarządzać całą szkołą.";
            }
            let query = _supabase.from('classes').select('id, name, school_id').order('name', { ascending: true });
            if (currentUser.role !== 'admin') query = query.eq('school_id', currentUser.school_id);
            const { data: classes } = await query;
            const select = document.getElementById('classSelect');
            select.innerHTML = ''; 
            if (classes && classes.length > 0) {
                classes.forEach(cls => { 
                    const opt = new Option(cls.name, cls.id);
                    opt.dataset.schoolId = cls.school_id;
                    select.add(opt); 
                });
                currentViewClassId = classes[0].id;
                select.value = currentViewClassId;
                await loadTeachersForSelect(classes[0].school_id);
                fetchAndRenderSchedule(currentViewClassId);
                if (canEdit) enableEditing(); 
            } else {
                select.innerHTML = '<option>Brak klas</option>';
            }
        }

        async function changeClass() {
            const select = document.getElementById('classSelect');
            currentViewClassId = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const schoolId = selectedOption.dataset.schoolId || currentUser.school_id;
            await loadTeachersForSelect(schoolId);
            generateGrid(); 
            if(canEdit) enableEditing(); 
            fetchAndRenderSchedule(currentViewClassId);
        }

        // --- FETCHING DATA & EDIT ---
        async function loadTeachersForSelect(schoolId) {
            if(!canEdit) return;
            const sel = document.getElementById('edit-teacher');
            sel.innerHTML = '<option disabled>Ładowanie...</option>';
            const { data: teachers } = await _supabase.from('users').select('id, username').eq('school_id', schoolId).in('role', ['teacher', 'manager', 'admin', 'lecturer']).order('username');
            sel.innerHTML = '<option value="">-- Brak / Zastępstwo --</option>';
            if(teachers) { teachers.forEach(t => sel.add(new Option(t.username, t.id))); }
        }

        async function fetchAndRenderSchedule(classId) {
            const { data: scheduleData } = await _supabase.from('weekly_schedule').select('*, teacher:teacher_id(username)').eq('class_id', classId);
            if (!scheduleData) return;
            scheduleData.forEach(item => {
                const hourPart = parseInt(item.start_time.split(':')[0]); 
                const cell = document.getElementById(`cell-${item.day_of_week}-${hourPart}`);
                if (cell) {
                    const teacherName = item.teacher ? item.teacher.username : '';
                    cell.innerHTML = `<div class="subject-block"><span class="subject-name">${item.subject_name}</span><span class="subject-info">${item.room || ''}</span><span class="subject-teacher">${teacherName}</span></div>`;
                    cell.dataset.subject = item.subject_name;
                    cell.dataset.room = item.room || "";
                    cell.dataset.teacherId = item.teacher_id || "";
                }
            });
        }

        function enableEditing() {
            const cells = document.querySelectorAll('td[data-day]');
            cells.forEach(cell => {
                cell.classList.add('editable');
                cell.onclick = () => {
                    if (!currentViewClassId || !canEdit) return;
                    document.getElementById('edit-day').value = cell.dataset.day;
                    document.getElementById('edit-hour').value = cell.dataset.hour;
                    document.getElementById('edit-subject').value = cell.dataset.subject || "";
                    document.getElementById('edit-room').value = cell.dataset.room || "";
                    document.getElementById('edit-teacher').value = cell.dataset.teacherId || "";
                    openModal('editLessonModal');
                };
            });
        }

        document.getElementById('editLessonForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!canEdit) return;
            const day = document.getElementById('edit-day').value;
            const hour = parseInt(document.getElementById('edit-hour').value);
            const subject = document.getElementById('edit-subject').value;
            const room = document.getElementById('edit-room').value;
            const teacherId = document.getElementById('edit-teacher').value || null;
            const startTime = `${hour.toString().padStart(2,'0')}:00`;
            const endTime = `${hour.toString().padStart(2,'0')}:45`;

            await _supabase.from('weekly_schedule').delete().eq('class_id', currentViewClassId).eq('day_of_week', day).eq('start_time', startTime);
            const { error } = await _supabase.from('weekly_schedule').insert({ class_id: currentViewClassId, day_of_week: day, start_time: startTime, end_time: endTime, subject_name: subject, room: room, teacher_id: teacherId });

            if(error) alert(error.message);
            else {
                closeModal('editLessonModal');
                fetchAndRenderSchedule(currentViewClassId);
                const cell = document.getElementById(`cell-${day}-${hour}`);
                cell.dataset.subject = subject;
                cell.dataset.room = room;
                cell.dataset.teacherId = teacherId || "";
            }
        });

        async function deleteLesson() {
            if(!canEdit) return;
            if(!confirm("Usunąć tę lekcję?")) return;
            const day = document.getElementById('edit-day').value;
            const hour = parseInt(document.getElementById('edit-hour').value);
            const startTime = `${hour.toString().padStart(2,'0')}:00`;
            await _supabase.from('weekly_schedule').delete().eq('class_id', currentViewClassId).eq('day_of_week', day).eq('start_time', startTime);
            closeModal('editLessonModal');
            const cell = document.getElementById(`cell-${day}-${hour}`);
            cell.innerHTML = '—';
            delete cell.dataset.subject; delete cell.dataset.room; delete cell.dataset.teacherId;
        }

        // --- EXCEL ---
        const DAY_MAP = { 1: "Poniedziałek", 2: "Wtorek", 3: "Środa", 4: "Czwartek", 5: "Piątek" };
        const REVERSE_DAY_MAP = { "poniedziałek": 1, "wtorek": 2, "środa": 3, "czwartek": 4, "piątek": 5, "pon": 1, "wt": 2, "śr": 3, "czw": 4, "pt": 5 };

        async function exportAllClassesToExcel() {
            if (typeof XLSX === 'undefined') { alert("Błąd biblioteki Excel."); return; }
            if (!currentUser.school_id && currentUser.role !== 'admin') { alert("Błąd danych szkoły."); return; }

            try {
                let qClasses = _supabase.from('classes').select('id, name').order('name');
                if (currentUser.role !== 'admin') qClasses = qClasses.eq('school_id', currentUser.school_id);
                const { data: classes } = await qClasses;
                
                if (!classes || classes.length === 0) return alert("Brak klas w szkole.");

                const classIds = classes.map(c => c.id);
                const { data: allSchedules } = await _supabase.from('weekly_schedule').select('*').in('class_id', classIds);

                const wb = XLSX.utils.book_new();

                classes.forEach(cls => {
                    const sheetData = [["Dzień", "Godzina", "Przedmiot", "Sala"]];
                    const classSchedule = allSchedules ? allSchedules.filter(s => s.class_id === cls.id) : [];

                    for (let day = 1; day <= 5; day++) {
                        for (let hour = 8; hour < 20; hour++) {
                            const timePrefix = hour.toString().padStart(2, '0') + ":00";
                            const lesson = classSchedule.find(s => s.day_of_week === day && s.start_time.startsWith(timePrefix));
                            const timeString = `${hour.toString().padStart(2, '0')}:00 - ${hour.toString().padStart(2, '0')}:45`;
                            
                            sheetData.push([
                                DAY_MAP[day],
                                timeString,
                                lesson ? lesson.subject_name : "",
                                lesson ? (lesson.room || "") : ""
                            ]);
                        }
                    }

                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    ws['!cols'] = [{wch:15}, {wch:15}, {wch:30}, {wch:10}];
                    
                    let sheetName = cls.name.replace(/[:\\\/?*\[\]]/g, ""); 
                    if (sheetName.length > 30) sheetName = sheetName.substring(0, 30);
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                let fileName = prompt("Podaj nazwę pliku:", "Plan_Cala_Szkola.xlsx");
                if (!fileName) return;
                if (!fileName.endsWith(".xlsx")) fileName += ".xlsx";

                XLSX.writeFile(wb, fileName);

            } catch (err) { console.error(err); alert("Błąd eksportu: " + err.message); }
        }

        // --- ZMODYFIKOWANA FUNKCJA IMPORTU (Z MAPOWANIEM) ---
        async function importAllClassesFromExcel(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    pendingWorkbook = XLSX.read(data, { type: 'array' });
                    
                    // Pobierz klasy ze szkoły
                    let qClasses = _supabase.from('classes').select('id, name');
                    if (currentUser.role !== 'admin') qClasses = qClasses.eq('school_id', currentUser.school_id);
                    const { data: classes } = await qClasses;
                    
                    if (!classes) throw new Error("Nie można pobrać listy klas.");
                    pendingClassList = classes;

                    // Reset stanów
                    autoMatchedSheets = [];
                    unmatchedSheets = [];

                    // Mapa do szybkiego szukania ID po nazwie
                    const classMap = {};
                    classes.forEach(c => classMap[c.name.trim().toLowerCase()] = c.id);

                    // Analiza arkuszy
                    for (const sheetName of pendingWorkbook.SheetNames) {
                        const normalizedName = sheetName.trim().toLowerCase();
                        const classId = classMap[normalizedName];

                        if (classId) {
                            autoMatchedSheets.push({ sheetName: sheetName, classId: classId });
                        } else {
                            unmatchedSheets.push(sheetName);
                        }
                    }

                    if (unmatchedSheets.length > 0) {
                        // Otwórz modal do mapowania
                        showMappingModal();
                    } else {
                        // Wszystko pasuje automatycznie
                        if(confirm(`Znaleziono ${autoMatchedSheets.length} arkuszy pasujących do klas. Zaimportować?`)) {
                            await executeImport([]);
                        } else {
                            input.value = '';
                        }
                    }

                } catch (err) {
                    console.error(err);
                    alert("Błąd importu: " + err.message);
                    input.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showMappingModal() {
            const container = document.getElementById('mapping-container');
            container.innerHTML = '';

            unmatchedSheets.forEach((sheetName, index) => {
                const row = document.createElement('div');
                row.className = 'mapping-row';
                
                let optionsHtml = `<option value="">-- Pomiń ten arkusz --</option>`;
                pendingClassList.forEach(cls => {
                    optionsHtml += `<option value="${cls.id}">${cls.name}</option>`;
                });

                row.innerHTML = `
                    <div class="sheet-name"><span class="material-symbols-outlined">description</span> ${sheetName}</div>
                    <span class="arrow-icon">→</span>
                    <select class="mapping-select" data-sheet="${sheetName}">
                        ${optionsHtml}
                    </select>
                `;
                container.appendChild(row);
            });

            openModal('mappingModal');
        }

        async function finalizeImport() {
            const selects = document.querySelectorAll('.mapping-select');
            const manualMatches = [];

            selects.forEach(sel => {
                const sheetName = sel.dataset.sheet;
                const classId = sel.value;
                if (classId) {
                    manualMatches.push({ sheetName: sheetName, classId: classId });
                }
            });

            closeModal('mappingModal');
            await executeImport(manualMatches);
        }

        async function executeImport(manualMatches) {
            const allMatches = [...autoMatchedSheets, ...manualMatches];
            
            if (allMatches.length === 0) {
                alert("Nie wybrano żadnych klas do importu.");
                document.getElementById('import-excel-input').value = '';
                return;
            }

            let processedCount = 0;

            for (const match of allMatches) {
                const sheet = pendingWorkbook.Sheets[match.sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                const toInsert = [];

                for (const row of jsonData) {
                    const dayRaw = row["Dzień"] || row["dzien"] || row["Dzien"];
                    const hourRaw = row["Godzina"] || row["godzina"]; 
                    const subject = row["Przedmiot"] || row["przedmiot"];
                    const room = row["Sala"] || row["sala"] || "";
                    
                    if (!dayRaw || !hourRaw || !subject) continue; 

                    let dayInt = typeof dayRaw === 'number' ? dayRaw : REVERSE_DAY_MAP[dayRaw.toLowerCase().trim()] || 0;
                    if (dayInt < 1 || dayInt > 5) continue; 

                    let hour = parseInt(hourRaw); 
                    if (isNaN(hour) || hour < 8 || hour > 19) continue; 

                    toInsert.push({ 
                        class_id: match.classId, 
                        day_of_week: dayInt, 
                        start_time: `${hour.toString().padStart(2,'0')}:00`, 
                        end_time: `${hour.toString().padStart(2,'0')}:45`, 
                        subject_name: subject, 
                        room: room.toString(), 
                        teacher_id: null 
                    });
                }

                // Delete old & Insert new
                await _supabase.from('weekly_schedule').delete().eq('class_id', match.classId);
                if (toInsert.length > 0) {
                    await _supabase.from('weekly_schedule').insert(toInsert);
                }
                processedCount++;
            }

            alert(`Pomyślnie zaimportowano plany dla ${processedCount} klas.`);
            document.getElementById('import-excel-input').value = '';
            
            if (currentViewClassId) fetchAndRenderSchedule(currentViewClassId);
        }

        async function downloadAllClassesTemplate() {
            try {
                let qClasses = _supabase.from('classes').select('name').order('name');
                if (currentUser.role !== 'admin') qClasses = qClasses.eq('school_id', currentUser.school_id);
                const { data: classes } = await qClasses;

                if (!classes || classes.length === 0) return alert("Brak klas.");

                const wb = XLSX.utils.book_new();

                classes.forEach(cls => {
                    const data = [["Dzień", "Godzina", "Przedmiot", "Sala"]];
                    for (let day = 1; day <= 5; day++) {
                        for (let hour = 8; hour < 20; hour++) {
                            const timeString = `${hour.toString().padStart(2, '0')}:00 - ${hour.toString().padStart(2, '0')}:45`;
                            data.push([DAY_MAP[day], timeString, "", ""]);
                        }
                    }
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch:15}, {wch:15}, {wch:30}, {wch:10}];
                    
                    let sheetName = cls.name.replace(/[:\\\/?*\[\]]/g, "");
                    if (sheetName.length > 30) sheetName = sheetName.substring(0, 30);
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                });

                XLSX.writeFile(wb, "Szablon_Cala_Szkola.xlsx");

            } catch(e) { console.error(e); alert("Błąd: " + e.message); }
        }

        async function exportCurrentViewToExcel() {
            if(!currentViewClassId) return alert("Wybierz dziecko/klasę.");
            try {
                const { data: schedule } = await _supabase.from('weekly_schedule').select('*').eq('class_id', currentViewClassId);
                const wb = XLSX.utils.book_new();
                const data = [["Dzień", "Godzina", "Przedmiot", "Sala"]];
                for (let day = 1; day <= 5; day++) {
                    for (let hour = 8; hour < 20; hour++) {
                        const timePrefix = hour.toString().padStart(2, '0') + ":00";
                        const lesson = schedule ? schedule.find(s => s.day_of_week === day && s.start_time.startsWith(timePrefix)) : null;
                        const timeString = `${hour.toString().padStart(2, '0')}:00 - ${hour.toString().padStart(2, '0')}:45`;
                        data.push([DAY_MAP[day], timeString, lesson?lesson.subject_name:"", lesson?lesson.room:""]);
                    }
                }
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{wch:15}, {wch:15}, {wch:30}, {wch:10}];
                XLSX.utils.book_append_sheet(wb, ws, "Plan");
                XLSX.writeFile(wb, "Plan_Zajec.xlsx");
            } catch(e){ alert(e.message); }
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
</body>
</html>
